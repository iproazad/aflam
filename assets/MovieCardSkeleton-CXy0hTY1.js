import{r as g,j as l}from"./index-Bd1E2-F5.js";const I="ImageCacheDB",j=1,u="images",S=1440*60*1e3;let m=null;function w(){return m||(m=new Promise((r,t)=>{if(!("indexedDB"in window)){t("IndexedDB not supported");return}const e=indexedDB.open(I,j);e.onerror=()=>{console.error("IndexedDB error:",e.error),t("Error opening IndexedDB."),m=null},e.onsuccess=()=>{r(e.result)},e.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains(u)||a.createObjectStore(u,{keyPath:"url"})}}),m)}async function p(r){try{const t=await w();return new Promise((e,n)=>{const s=t.transaction(u,"readonly").objectStore(u).get(r);s.onerror=()=>{n("Error getting image from cache.")},s.onsuccess=()=>{const i=s.result;if(i&&Date.now()-i.timestamp<S)e(i.blob);else{if(i)try{t.transaction(u,"readwrite").objectStore(u).delete(r)}catch{}e(null)}}})}catch(t){return console.error("Failed to access IndexedDB:",t),null}}async function v(r,t){try{const a=(await w()).transaction(u,"readwrite").objectStore(u),c={url:r,blob:t,timestamp:Date.now()};a.put(c)}catch(e){console.error("Failed to add image to IndexedDB cache:",e)}}const R=(r,t)=>{if(r.includes("._V1_"))return r.replace(/\._V1_.*\.jpg$/,`._V1_SX${t}_QL75_.jpg`);if(r.includes(".supabase.co/"))try{const e=new URL(r);return e.searchParams.set("width",t.toString()),e.searchParams.set("quality","75"),e.toString()}catch(e){return console.error("Error transforming Supabase URL",e),r}return r},b=new Map;async function x(r,t){if(!r)return"";const e=t!=null&&t.thumbnailWidth?R(r,t.thumbnailWidth):r;if(b.has(e))return b.get(e);try{const n=await p(e);if(n){const d=URL.createObjectURL(n);return b.set(e,d),d}let a=!1;try{a=new URL(e).origin!==window.location.origin}catch{a=!1}const c=a?`https://corsproxy.io/?${encodeURIComponent(e)}`:e,s=await fetch(c);if(!s.ok)throw new Error(`Fetch failed with status ${s.status}`);const i=await s.blob();v(e,i.slice());const o=URL.createObjectURL(i);return b.set(e,o),o}catch(n){return console.error(`Failed to get or cache image ${e}:`,n),r}}const D=(r,t)=>{const[e,n]=g.useState(r);return g.useEffect(()=>{let a=!0;return r&&x(r,t).then(c=>{a&&n(c)}),()=>{a=!1}},[r,t==null?void 0:t.thumbnailWidth]),e},B=(r,t)=>{const[e,n]=g.useState(void 0),[a,c]=g.useState(!1),s=g.useRef(null);return g.useEffect(()=>{let o;const d=s.current;let h=!0;return d&&!e&&(o=new IntersectionObserver(([f])=>{f.isIntersecting&&h&&(x(r,t).then(y=>{h&&n(y)}),o.unobserve(f.target))},{rootMargin:"0px 0px 200px 0px"}),o.observe(d)),()=>{h=!1,o&&d&&o.unobserve(d)}},[r,e,t==null?void 0:t.thumbnailWidth]),{imageRef:s,imageSrc:e,isLoaded:a,handleImageLoad:()=>{c(!0)}}},E=()=>l.jsxs("div",{className:"block group relative rounded-lg overflow-hidden shadow-lg bg-gray-800 animate-pulse",children:[l.jsx("div",{className:"relative w-full aspect-[2/3] bg-gray-700"}),l.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"}),l.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-2 sm:p-3 md:p-4",children:[l.jsx("div",{className:"h-5 bg-gray-600 rounded w-3/4 mb-2"}),l.jsxs("div",{className:"flex justify-between items-center mt-1",children:[l.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/4"}),l.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/4"})]})]})]});export{E as M,B as a,D as u};
