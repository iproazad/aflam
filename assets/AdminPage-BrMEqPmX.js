import{r as o,j as e,s as E,a as mt,f as ht,R as yt}from"./index-c2awL_6y.js";import{P as it}from"./Pagination-Dr61bSuL.js";import{F as _e,S as Ce}from"./SpinnerIcon-BsUuOgM6.js";const wt=["https://cors.eu.org/","https://api.allorigins.win/raw?url="],Ge=async i=>{let r=null;for(const m of wt){const d=m.endsWith("?url=")?`${m}${encodeURIComponent(i)}`:`${m}${i}`;try{const f=await fetch(d);if(f.ok)return f;r=new Error(`Proxy ${m} failed with status: ${f.status}`)}catch(f){r=f}}throw r||new Error("Failed to fetch from all available proxies.")},jt=[{key:"foreign",label:"افلام اجنبي"},{key:"kurdish",label:"افلام كردي"},{key:"asian",label:"افلام اسيوية"},{key:"turkish",label:"افلام تركية"},{key:"arabic",label:"افلام عربي"},{key:"classic",label:"افلام كلاسيكيه"},{key:"dubbed",label:"افلام مدبلجة"},{key:"indian",label:"افلام هندية"},{key:"anime",label:"افلام انمي"}],ut=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),vt=({onSubmit:i,initialData:r,onCancel:m,isLoading:d=!1,allGenres:f=[]})=>{var Z,ne,ee;const[s,c]=o.useState({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],servers:[{name:"Server 1",url:"https://vidtube.pro/embed-1y2lihgthstv.html",quality:"FullHD"}],backup_servers:[],download_url:"",trailer_url:"",is_kurdish:!1,movie_type:"foreign",imdb_rating:void 0,quality:"",duration:"",language:"",country:"",directors:[],writers:[],cast:[]}),[k,y]=o.useState(""),[O,K]=o.useState(""),[z,X]=o.useState(!1),[p,v]=o.useState(""),[B,q]=o.useState(!1),[A,I]=o.useState(""),[_,M]=o.useState(""),[J,G]=o.useState(!1),w=o.useRef(null);o.useEffect(()=>{if(r){let n=r.movie_type;!n&&r.is_kurdish&&(n="kurdish"),c({title:r.title||"",description:r.description||"",poster_url:r.poster_url||"",backdrop_url:r.backdrop_url||"",year:r.year||new Date().getFullYear(),genres:r.genres||[],tags:r.tags||[],servers:r.servers&&r.servers.length>0?r.servers:[{name:"Server 1",url:"",quality:"FullHD"}],backup_servers:r.backup_servers||[],download_url:r.download_url||"",trailer_url:r.trailer_url||"",is_kurdish:n==="kurdish",movie_type:n||"foreign",imdb_rating:r.imdb_rating,quality:r.quality||"",duration:r.duration||"",language:r.language||"",country:r.country||"",directors:r.directors||[],writers:r.writers||[],cast:r.cast||[]}),y((r.tags||[]).join(", "))}else c({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],servers:[{name:"Server 1",url:"https://vidtube.pro/embed-1y2lihgthstv.html",quality:"FullHD"}],backup_servers:[],download_url:"",trailer_url:"",is_kurdish:!1,movie_type:"foreign",imdb_rating:void 0,quality:"",duration:"",language:"",country:"",directors:[],writers:[],cast:[]}),y("")},[r]),o.useEffect(()=>{const n=t=>{w.current&&!w.current.contains(t.target)&&q(!1)};return document.addEventListener("mousedown",n),()=>{document.removeEventListener("mousedown",n)}},[]),o.useEffect(()=>{if(!r){const n=s.title.match(/\b(19[89]\d|20\d{2})\b/);if(n&&n[0]){const t=parseInt(n[0],10),l=s.title.replace(n[0],"").replace(/\s\s+/g," ").trim();c(g=>g.year!==t||g.title!==l?{...g,year:t,title:l}:g)}}},[s.title,r]),o.useEffect(()=>{!r&&!s.backdrop_url.trim()&&c(n=>({...n,backdrop_url:n.poster_url}))},[s.poster_url,r,s.backdrop_url]),o.useEffect(()=>{const n=s.download_url;if(n&&n.includes("vidtube.pro/d/")){const t=n.match(/vidtube\.pro\/d\/([a-zA-Z0-9]+)\.html/);if(t&&t[1]){const g=`https://vidtube.pro/embed-${t[1]}.html`;if(s.servers.length>0&&s.servers[0].url!==g){const j=[...s.servers];j[0]={...j[0],url:g},c(F=>({...F,servers:j}))}else if(s.servers.length===0){const j={name:"Server 1",url:g,quality:"FullHD"};c(F=>({...F,servers:[j]}))}}}},[s.download_url]);const R=async n=>{var t;try{if(!((t=navigator.clipboard)!=null&&t.readText))throw new Error("Clipboard API not available.");const l=await navigator.clipboard.readText();l&&n(l)}catch(l){console.error("Failed to read clipboard contents: ",l),alert("فشل لصق النص. يرجى التأكد من منح الإذن لاستخدام الحافظة.")}},u=n=>{const{name:t,value:l,type:g}=n.target;if(g==="checkbox"){const{checked:j}=n.target;c(F=>({...F,[t]:j}))}else if(t==="year"){const j=parseInt(l,10);c(F=>({...F,[t]:isNaN(j)?0:j}))}else if(t==="imdb_rating"){const j=parseFloat(l);c(F=>({...F,imdb_rating:isNaN(j)?void 0:j}))}else c(j=>({...j,[t]:l}))},x=n=>{y(n.target.value)},h=n=>{c(t=>{const l=t.genres||[],g=l.includes(n)?l.filter(j=>j!==n):[...l,n];return{...t,genres:g}})},C=async()=>{const n=_.trim();if(n){if(f.some(t=>t.toLowerCase()===n.toLowerCase())){alert("هذه الفئة موجودة بالفعل.");return}G(!0);try{const{error:t}=await E.from("categories").insert({name:n});if(t)throw t;c(l=>({...l,genres:[...l.genres||[],n]})),M("")}catch(t){console.error("Error adding new genre:",t),alert("حدث خطأ أثناء إضافة الفئة الجديدة.")}finally{G(!1)}}},$=(n,t,l)=>{const g=[...s.servers];g[n]={...g[n],[t]:l},c(j=>({...j,servers:g}))},L=()=>{c(n=>{const t={name:`Server ${n.servers.length+1}`,url:"",quality:"FullHD"};return{...n,servers:[...n.servers,t]}})},se=n=>{c(t=>({...t,servers:t.servers.filter((l,g)=>g!==n)}))},P=(n,t,l)=>{const g=[...s.backup_servers||[]];g[n]={...g[n],[t]:l},c(j=>({...j,backup_servers:g}))},ve=()=>{c(n=>{var t;return{...n,backup_servers:[...n.backup_servers||[],{name:`Server ${(((t=n.backup_servers)==null?void 0:t.length)||0)+1}`,url:"",quality:"FullHD",no_sub_url:""}]}})},ue=n=>{c(t=>({...t,backup_servers:(t.backup_servers||[]).filter((l,g)=>g!==n)}))},N=async()=>{var n,t,l,g,j,F,te,ae,me,a,b,S,re,Ee,ye,we,je,ge,$e;if(!O){v("Please enter a URL.");return}X(!0),v("");try{v("Fetching movie page...");const Me=await Ge(O);if(!Me.ok)throw new Error(`Failed to fetch URL: ${Me.statusText}`);const ft=await Me.text(),dt=new DOMParser,le=dt.parseFromString(ft,"text/html");if(O.includes("a.asd.homes")){v("جلب البيانات من عرب سيد...");const oe=W=>{var Q,qe;const V=Array.from(le.querySelectorAll(".info__area__ul > li")).find(he=>{var xe,st;return(st=(xe=he.querySelector(".title__kit span"))==null?void 0:xe.textContent)==null?void 0:st.trim().startsWith(W)});if(!V)return[];const ce=Array.from(V.querySelectorAll("ul.tags__list a"));if(ce.length>0)return ce.map(he=>{var xe;return((xe=he.textContent)==null?void 0:xe.trim())||""}).filter(Boolean);const de=Array.from(V.childNodes).find(he=>{var xe;return he.nodeType===Node.TEXT_NODE&&((xe=he.textContent)==null?void 0:xe.trim())});if(de)return[((Q=de.textContent)==null?void 0:Q.trim())||""];const T=V.querySelector("a");return T?[((qe=T.textContent)==null?void 0:qe.trim())||""]:[]},Fe=((t=(n=le.querySelector("h1.post__name"))==null?void 0:n.textContent)==null?void 0:t.trim())||"",fe=Fe.match(/\(\s*(\d{4})\s*\)/),Je=fe?parseInt(fe[1],10):new Date().getFullYear(),be=fe?Fe.replace(fe[0],"").trim():Fe,Ye=((g=(l=le.querySelector(".post__story p"))==null?void 0:l.textContent)==null?void 0:g.trim())||"",Ae=((j=le.querySelector(".poster__single img"))==null?void 0:j.getAttribute("data-src"))||((F=le.querySelector(".poster__single img"))==null?void 0:F.getAttribute("src"))||"",Ve=((ae=(te=le.querySelector(".rating__box .rate__txt"))==null?void 0:te.textContent)==null?void 0:ae.trim().split("/")[0].trim())||"0",Ke=parseFloat(Ve)||void 0,Xe=oe("نوع العرض"),Ze=oe("جودة العرض").join(", "),Qe=oe("مدة العرض").join(", "),et=oe("لغة العرض").join(", "),tt=oe("بلد العرض").join(", "),Oe=[],Pe=[],De=[];le.querySelectorAll(".persons__list li a").forEach(W=>{var ce,de,T,Q;const ie=(de=(ce=W.querySelector(".name"))==null?void 0:ce.textContent)==null?void 0:de.trim(),V=(Q=(T=W.querySelector(".role"))==null?void 0:T.textContent)==null?void 0:Q.trim();ie&&V&&(V.includes("مخرج")?Oe.push(ie):V.includes("كاتب")?Pe.push(ie):De.push(ie))});const Be=((me=le.querySelector(".show__trailer"))==null?void 0:me.getAttribute("data-iframe"))||"",Te=async W=>{var ie;if(!W)return"";try{v("Fetching watch page...");const V=await Ge(W);if(!V.ok)throw new Error(`Failed to fetch watch page: ${V.statusText}`);const ce=await V.text(),T=(ie=new DOMParser().parseFromString(ce,"text/html").querySelector(".player__iframe iframe"))==null?void 0:ie.getAttribute("src");return T?T.startsWith("/")?`https://a.asd.homes${T}`:new URL(T,W).href:""}catch(V){return console.error("Error scraping watch page:",V),v("Warning: Could not automatically find watch server."),""}},Re=(W,ie,V)=>new Promise(async(ce,de)=>{if(!W)return ce("");let T=null,Q=null;const qe=setTimeout(()=>{Q==null||Q.disconnect(),T==null||T.remove(),de(new Error(`Scraping timed out for ${W}`))},15e3);try{const he=await Ge(W);if(!he.ok)return de(new Error(`Failed to fetch intermediate page: ${W}`));const xe=await he.text(),rt=new DOMParser().parseFromString(xe,"text/html").querySelector(ie);if(rt&&rt.getAttribute(V))return clearTimeout(qe),ce(rt.getAttribute(V)||"");T=document.createElement("div"),T.style.display="none",document.body.appendChild(T),Q=new MutationObserver(()=>{const at=T==null?void 0:T.querySelector(ie);if(at&&at.getAttribute(V)){const bt=at.getAttribute(V)||"";Q==null||Q.disconnect(),clearTimeout(qe),T==null||T.remove(),ce(bt)}}),Q.observe(T,{childList:!0,subtree:!0}),T.innerHTML=xe}catch(he){clearTimeout(qe),Q==null||Q.disconnect(),T==null||T.remove(),de(he)}});v("Fetching watch & download pages (this may take a moment)...");const pe=(a=le.querySelector("a.watch__btn"))==null?void 0:a.getAttribute("href"),Le=(b=le.querySelector("a.download__btn"))==null?void 0:b.getAttribute("href"),[Ne,Ue]=await Promise.all([Te(pe),Re(Le,'a.downloadsLink, a[href*="vidtube.pro/d/"], .downloads__links__list a',"href").catch(W=>(console.warn("Could not scrape download URL:",W),v("Warning: Could not automatically find download link."),""))]);let ke=[];Ne&&(v("Parsing watch servers..."),ke.push({name:"Server 1",url:Ne,quality:"HD"})),c(W=>({...W,title:be,year:Je||W.year,description:Ye,poster_url:Ae,backdrop_url:Ae,imdb_rating:Ke,genres:[...new Set([...W.genres,...Xe])],quality:Ze,duration:Qe,language:et,country:tt,directors:Oe,writers:Pe,cast:De,trailer_url:Be,servers:ke.length>0?ke:W.servers,download_url:Ue||W.download_url})),v("تم جلب البيانات بنجاح!")}else if(O.includes("topcinema.cam")){const oe=pe=>{var ie,V,ce;const Ne=Array.from(le.querySelectorAll(".RightTaxContent > li")).find(de=>{var T,Q;return(Q=(T=de.querySelector("span"))==null?void 0:T.textContent)==null?void 0:Q.trim().startsWith(pe)});if(!Ne)return[];const Ue=Array.from(Ne.querySelectorAll("a, strong"));if(Ue.length>0)return Ue.map(de=>{var T;return((T=de.textContent)==null?void 0:T.trim())||""}).filter(Boolean);const ke=Ne.cloneNode(!0);(ie=ke.querySelector("i"))==null||ie.remove(),(V=ke.querySelector("span"))==null||V.remove();const W=(ce=ke.textContent)==null?void 0:ce.trim().replace(/^:/,"").trim();return W?W.split(/\s*,\s*/):[]},Fe=((re=(S=le.querySelector("h1.post-title"))==null?void 0:S.textContent)==null?void 0:re.trim())||"",fe=Fe.match(/\b(19\d{2}|20\d{2})\b/),Je=fe?parseInt(fe[0],10):new Date().getFullYear();let be=Fe;be=be.replace(/فيلم|مترجم|اون لاين|اونلاين|WEB-DL|BluRay|HD/gi,"").replace(/[\u0600-\u06FF]+/g,""),fe&&(be=be.replace(fe[0],"")),be=be.trim().replace(/^[^a-zA-Z0-9\s]+|[^a-zA-Z0-9\s]+$/g,"").trim();const Ye=((ye=(Ee=le.querySelector(".story p"))==null?void 0:Ee.textContent)==null?void 0:ye.trim())||"",Ae=((we=le.querySelector(".MainSingle .left .image img"))==null?void 0:we.getAttribute("src"))||"",Ve=((ge=(je=le.querySelector(".imdbR span"))==null?void 0:je.textContent)==null?void 0:ge.trim())||"0",Ke=parseFloat(Ve)||void 0,Xe=oe("نوع الفيلم"),Ze=oe("جودة الفيلم").join(", "),Qe=oe("توقيت الفيلم").join(", "),et=oe("لغة الفيلم").join(", "),tt=oe("دولة الفيلم").join(", "),Oe=oe("المخرجين"),Pe=oe("المؤلفين"),De=oe("بطولة");let Be="";const Te=le.querySelector("a.download"),Re=Te==null?void 0:Te.getAttribute("href");if(Re){v("Fetching download link...");const pe=await Ge(Re);if(pe.ok){const Le=await pe.text();Be=(($e=dt.parseFromString(Le,"text/html").querySelector('a.downloadsLink, a[href*="vidtube.pro/d/"]'))==null?void 0:$e.getAttribute("href"))||""}}c(pe=>({...pe,title:be,year:Je||pe.year,description:Ye,poster_url:Ae,backdrop_url:Ae,imdb_rating:Ke,genres:[...new Set([...pe.genres,...Xe])],quality:Ze,duration:Qe,language:et,country:tt,directors:Oe,writers:Pe,cast:De,download_url:Be})),v("تم جلب البيانات بنجاح!")}else{v("هذا الموقع غير مدعوم حاليًا للجلب."),X(!1);return}}catch(Me){console.error("Scraping failed:",Me),v(`فشل جلب البيانات: ${Me.message}.`)}finally{X(!1)}},U=n=>{if(n.preventDefault(),s.genres.length===0){alert("الرجاء اختيار فئة واحدة على الأقل.");return}const t=k.split(",").map(g=>g.trim()).filter(Boolean),l={...s,tags:t,is_kurdish:s.movie_type==="kurdish"};i(l)},Y=f.filter(n=>n.toLowerCase().includes(A.toLowerCase())),H="w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 focus:border-cyan-500 outline-none transition",D="bg-slate-600 text-white p-2 rounded-md border border-slate-500 focus:border-cyan-500 outline-none";return e.jsxs("form",{onSubmit:U,children:[e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsxs("div",{className:"space-y-3 p-4 bg-slate-900/50 rounded-lg border border-slate-700",children:[e.jsx("label",{htmlFor:"scrape_url",className:"block text-lg font-semibold text-white",children:"جلب البيانات من رابط"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{id:"scrape_url",type:"url",value:O,onChange:n=>K(n.target.value),placeholder:"https://web6.topcinema.cam/... or https://a.asd.homes/...",className:`${H} flex-grow`}),e.jsxs("div",{className:"flex gap-2 flex-shrink-0",children:[e.jsx("button",{type:"button",onClick:()=>c(n=>({...n,download_url:O})),title:"لصق رابط الجلب في حقل رابط التحميل",className:"bg-slate-600 text-white font-bold py-2 px-3 rounded-lg hover:bg-slate-500 transition-colors flex-grow sm:flex-grow-0 flex items-center justify-center text-sm",children:"تحميل"}),e.jsxs("button",{type:"button",onClick:N,disabled:z,className:"bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 flex-shrink-0 flex-grow sm:flex-grow-0 flex items-center justify-center disabled:bg-slate-500",children:[z&&e.jsx(ut,{}),z?"جاري الجلب...":"جلب البيانات"]})]})]}),p&&e.jsx("p",{className:`text-sm mt-1 ${p.startsWith("فشل")||p.startsWith("هذا")?"text-red-400":"text-green-400"}`,children:p})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx("input",{type:"text",name:"title",value:s.title,onChange:u,placeholder:"عنوان الفيلم (بالانجليزية)",required:!0,className:H})}),e.jsx("input",{type:"number",name:"year",value:s.year||"",onChange:u,placeholder:"سنة الإنتاج",required:!0,className:H})]}),e.jsx("textarea",{name:"description",value:s.description,onChange:u,placeholder:"وصف الفيلم",required:!0,className:`${H} h-32`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",name:"poster_url",value:s.poster_url,onChange:u,placeholder:"رابط صورة البوستر",required:!0,className:`${H} flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(n=>c(t=>({...t,poster_url:n,backdrop_url:n}))),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-2 px-4 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsx("input",{type:"url",name:"backdrop_url",value:s.backdrop_url,onChange:u,placeholder:"رابط صورة الخلفية",required:!0,className:H})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"number",name:"imdb_rating",value:s.imdb_rating??"",onChange:u,placeholder:"تقيم الفيلم",step:"0.1",min:"0",max:"10",className:H}),e.jsx("input",{type:"url",name:"trailer_url",value:s.trailer_url??"",onChange:u,placeholder:"رابط المقطع الدعائي (اختياري)",className:H})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"movie_type",className:"block text-sm font-medium text-slate-300 mb-2",children:"نوع الفيلم"}),e.jsx("select",{id:"movie_type",name:"movie_type",value:s.movie_type||"foreign",onChange:u,className:H,children:jt.map(n=>e.jsx("option",{value:n.key,children:n.label},n.key))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block text-sm font-medium text-slate-300 mb-2",children:"الكلمات الدلالية (Tags)"}),e.jsx("input",{id:"tags",type:"text",name:"tags",value:k,onChange:x,placeholder:"أكشن, بطل خارق, إثارة (مفصولة بفاصلة)",className:H})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الفئات (اختر واحدة على الأقل)"}),e.jsxs("div",{className:"relative",ref:w,children:[e.jsxs("button",{type:"button",onClick:()=>q(n=>!n),className:`${H} text-right flex justify-between items-center`,children:[e.jsx("span",{children:s.genres.length>0?s.genres.join(", "):"اختر الفئات..."}),e.jsx("svg",{className:`h-5 w-5 transition-transform duration-200 ${B?"rotate-180":""}`,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),B&&e.jsxs("div",{className:"absolute z-10 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto",children:[e.jsx("div",{className:"p-2 border-b border-slate-700",children:e.jsx("input",{type:"text",placeholder:"ابحث أو أضف فئة...",value:A,onChange:n=>I(n.target.value),className:"w-full bg-slate-700 text-white p-2 rounded-md border-slate-600 outline-none"})}),e.jsx("ul",{className:"p-1",children:Y.map(n=>e.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-700 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s.genres.includes(n),onChange:()=>h(n),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("span",{className:"text-white",children:n})]},n))}),e.jsx("div",{className:"p-2 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"إضافة فئة جديدة...",value:_,onChange:n=>M(n.target.value),className:"flex-grow bg-slate-700 text-white p-2 rounded-md border-slate-600 outline-none"}),e.jsx("button",{type:"button",onClick:C,disabled:J||!_.trim(),className:"bg-cyan-600 text-white px-3 py-1 rounded-md text-sm hover:bg-cyan-700 disabled:bg-slate-500",children:J?"...":"إضافة"})]})})]})]})]}),e.jsxs("details",{className:"bg-slate-900/30 p-4 rounded-lg border border-slate-700",open:!0,children:[e.jsx("summary",{className:"text-lg font-semibold text-white cursor-pointer",children:"تفاصيل إضافية للفيلم"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",name:"quality",value:s.quality,onChange:u,placeholder:"الجودة (e.g. 1080p WEB-DL)",className:D}),e.jsx("input",{type:"text",name:"duration",value:s.duration,onChange:u,placeholder:"مدة العرض",className:D}),e.jsx("input",{type:"text",name:"language",value:s.language,onChange:u,placeholder:"اللغة",className:D}),e.jsx("input",{type:"text",name:"country",value:s.country,onChange:u,placeholder:"الدولة",className:D})]}),e.jsx("textarea",{value:(Z=s.directors)==null?void 0:Z.join(", "),onChange:n=>c(t=>({...t,directors:n.target.value.split(",").map(l=>l.trim())})),placeholder:"المخرجين (مفصولة بفاصلة)",className:`${D} w-full`,rows:2}),e.jsx("textarea",{value:(ne=s.writers)==null?void 0:ne.join(", "),onChange:n=>c(t=>({...t,writers:n.target.value.split(",").map(l=>l.trim())})),placeholder:"المؤلفين (مفصولة بفاصلة)",className:`${D} w-full`,rows:2}),e.jsx("textarea",{value:(ee=s.cast)==null?void 0:ee.join(", "),onChange:n=>c(t=>({...t,cast:n.target.value.split(",").map(l=>l.trim())})),placeholder:"البطولة (مفصولة بفاصلة)",className:`${D} w-full`,rows:3})]})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"سيرفرات المشاهدة"}),s.servers.map((n,t)=>e.jsxs("div",{className:"bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:n.name,onChange:l=>$(t,"name",l.target.value),placeholder:"اسم السيرفر",className:`${D} flex-1`}),e.jsxs("select",{value:n.quality,onChange:l=>$(t,"quality",l.target.value),className:`${D} w-28`,children:[e.jsx("option",{value:"FullHD",children:"FullHD"}),e.jsx("option",{value:"HD",children:"HD"}),e.jsx("option",{value:"SD",children:"SD"})]}),s.servers.length>1&&e.jsx("button",{type:"button",onClick:()=>se(t),className:"bg-red-600 text-white p-2 rounded-md hover:bg-red-700 text-xs",children:"X"})]}),t===0?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:n.url,onChange:l=>$(t,"url",l.target.value),placeholder:"رابط السيرفر 1",required:!0,className:`${D} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(l=>$(t,"url",l)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",name:"download_url",value:s.download_url||"",onChange:u,placeholder:"رابط صفحة الفيلم (لجلب التحميلات)",className:`${D} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(l=>c(g=>({...g,download_url:l}))),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:n.url,onChange:l=>$(t,"url",l.target.value),placeholder:`رابط السيرفر ${t+1}`,required:!0,className:`${D} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(l=>$(t,"url",l)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]})]},t)),e.jsx("button",{type:"button",onClick:L,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500",children:"إضافة سيرفر"})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"سيرفرات احتياطية (مشغل خارجي)"}),(s.backup_servers||[]).map((n,t)=>e.jsxs("div",{className:"bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:n.name,onChange:l=>P(t,"name",l.target.value),placeholder:"اسم السيرفر",className:`${D} flex-1`}),e.jsxs("select",{value:n.quality,onChange:l=>P(t,"quality",l.target.value),className:`${D} w-28`,children:[e.jsx("option",{value:"FullHD",children:"FullHD"}),e.jsx("option",{value:"HD",children:"HD"}),e.jsx("option",{value:"SD",children:"SD"})]}),e.jsx("button",{type:"button",onClick:()=>ue(t),className:"bg-red-600 text-white p-2 rounded-md hover:bg-red-700 text-xs",children:"X"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:n.url,onChange:l=>P(t,"url",l.target.value),placeholder:"رابط السيرفر (مع ترجمة)",className:`${D} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(l=>P(t,"url",l)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:n.no_sub_url||"",onChange:l=>P(t,"no_sub_url",l.target.value),placeholder:"رابط السيرفر (بدون ترجمة)",className:`${D} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>R(l=>P(t,"no_sub_url",l)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]})]})]},t)),e.jsx("button",{type:"button",onClick:ve,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500",children:"إضافة سيرفر احتياطي"})]})]}),e.jsxs("div",{className:"sticky bottom-0 z-10 bg-slate-800/95 backdrop-blur-sm p-4 border-t border-slate-700 flex justify-end gap-4 -mx-6 -mb-6 md:-mx-8 md:-mb-8 rounded-b-lg",children:[e.jsx("button",{type:"button",onClick:m,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors disabled:opacity-50",disabled:d,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",disabled:d,children:[d&&e.jsx(ut,{}),d?r?"جاري التحديث...":"جاري الإضافة...":r?"تحديث الفيلم":"إضافة الفيلم"]})]})]})},Nt=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),Se=({isOpen:i,onClose:r,onConfirm:m,title:d,message:f,isLoading:s=!1})=>{const[c,k]=o.useState(i);return o.useEffect(()=>{if(i)k(!0);else{const y=setTimeout(()=>k(!1),300);return()=>clearTimeout(y)}},[i]),c?e.jsx("div",{className:`fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 ${i?"animate-fade-in":"animate-fade-out"}`,onClick:r,"aria-modal":"true",role:"dialog",children:e.jsxs("div",{className:`relative bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-slate-700 ${i?"animate-zoom-in":"animate-zoom-out"}`,onClick:y=>y.stopPropagation(),children:[e.jsxs("div",{className:"sm:flex sm:items-start",children:[e.jsx("div",{className:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-500/20 sm:mx-0 sm:h-10 sm:w-10",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right flex-grow",children:[e.jsx("h3",{className:"text-lg leading-6 font-bold text-white",id:"modal-title",children:d}),e.jsx("div",{className:"mt-2",children:e.jsx("p",{className:"text-sm text-slate-300",children:f})})]})]}),e.jsxs("div",{className:"mt-5 sm:mt-4 sm:flex sm:flex-row-reverse sm:justify-start gap-3",children:[e.jsxs("button",{type:"button",className:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-slate-800 sm:w-auto sm:text-sm disabled:bg-red-800 disabled:cursor-not-allowed",onClick:m,disabled:s,children:[s&&e.jsx(Nt,{}),s?"جاري الحذف...":"حذف"]}),e.jsx("button",{type:"button",className:"mt-3 w-full inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 focus:ring-offset-slate-800 sm:mt-0 sm:w-auto sm:text-sm disabled:opacity-50",onClick:r,disabled:s,children:"إلغاء"})]})]})}):null},kt=10,xt=()=>e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden mt-8 animate-pulse",children:[e.jsxs("div",{className:"p-4 flex justify-between items-center",children:[e.jsx("div",{className:"h-10 bg-gray-700 rounded w-40"}),e.jsx("div",{className:"h-8 bg-gray-700 rounded w-64"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsx("tr",{children:[...Array(9)].map((i,r)=>e.jsx("th",{className:"px-4 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})},r))})}),e.jsx("tbody",{children:[...Array(kt)].map((i,r)=>e.jsxs("tr",{className:"border-b border-gray-700",children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-6 w-6 bg-gray-600 rounded"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-20 w-14 bg-gray-600 rounded"})}),[...Array(7)].map((m,d)=>e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})},d))]},r))})]})})]}),ct=({message:i,type:r,onClose:m})=>(o.useEffect(()=>{const s=setTimeout(m,5e3);return()=>clearTimeout(s)},[m]),e.jsx("div",{className:`fixed top-24 right-5 z-[100] p-4 rounded-lg shadow-lg text-white border-l-4 animate-fade-in-down ${r==="success"?"bg-green-600 border-green-500":"bg-red-600 border-red-500"}`,role:"alert",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"font-bold",children:i}),e.jsx("button",{onClick:m,className:"absolute top-1 right-2 text-2xl font-bold leading-none",children:"×"})]})})),gt=({genres:i,onSubmit:r,onClose:m,isLoading:d})=>{const[f,s]=o.useState(i[0]||""),[c,k]=o.useState("add"),y=O=>{O.preventDefault(),f&&r(f,c)};return e.jsx(_e,{title:"تغيير الفئة بشكل جماعي",onClose:m,isOpen:!0,children:e.jsxs("form",{onSubmit:y,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"اختر فئة لإضافتها أو إزالتها من الأفلام المحددة."}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("select",{value:f,onChange:O=>s(O.target.value),className:"flex-grow bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:i.map(O=>e.jsx("option",{value:O,children:O},O))}),e.jsxs("select",{value:c,onChange:O=>k(O.target.value),className:"bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:[e.jsx("option",{value:"add",children:"إضافة"}),e.jsx("option",{value:"remove",children:"إزالة"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:m,disabled:d,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:d||!f,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[d&&e.jsx(Ce,{}),d?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},Ct=({onSubmit:i,onClose:r,isLoading:m})=>{const[d,f]=o.useState(new Date().getFullYear()),s=c=>{c.preventDefault(),i(d)};return e.jsx(_e,{title:"تغيير سنة الإنتاج بشكل جماعي",onClose:r,isOpen:!0,children:e.jsxs("form",{onSubmit:s,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"أدخل سنة الإنتاج الجديدة ليتم تطبيقها على جميع الأفلام المحددة."}),e.jsx("input",{type:"number",value:d,onChange:c=>f(parseInt(c.target.value)),required:!0,className:"w-full bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:r,disabled:m,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:m,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[m&&e.jsx(Ce,{}),m?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},pt=({onSubmit:i,onClose:r,isLoading:m})=>{const[d,f]=o.useState(""),[s,c]=o.useState("add"),k=y=>{y.preventDefault(),d.trim()&&i(d.trim(),s)};return e.jsx(_e,{title:"تغيير الكلمات الدلالية بشكل جماعي",onClose:r,isOpen:!0,children:e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"أدخل كلمة دلالية (Tag) لإضافتها أو إزالتها من الأفلام المحددة."}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"text",value:d,onChange:y=>f(y.target.value),placeholder:"الكلمة الدلالية, مثلاً: بطل خارق",required:!0,className:"flex-grow bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("select",{value:s,onChange:y=>c(y.target.value),className:"bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:[e.jsx("option",{value:"add",children:"إضافة"}),e.jsx("option",{value:"remove",children:"إزالة"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:r,disabled:m,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:m||!d.trim(),className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[m&&e.jsx(Ce,{}),m?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},St=({movieTypes:i,onSubmit:r,onClose:m,isLoading:d})=>{var k;const[f,s]=o.useState(((k=i[0])==null?void 0:k.key)||"foreign"),c=y=>{y.preventDefault(),r(f)};return e.jsx(_e,{title:"تغيير نوع الفيلم بشكل جماعي",onClose:m,isOpen:!0,children:e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"اختر النوع الجديد ليتم تطبيقه على جميع الأفلام المحددة."}),e.jsx("select",{value:f,onChange:y=>s(y.target.value),required:!0,className:"w-full bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:i.map(y=>e.jsx("option",{value:y.key,children:y.label},y.key))}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:m,disabled:d,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:d,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[d&&e.jsx(Ce,{}),d?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},ze=10,nt=[{key:"foreign",label:"افلام اجنبي"},{key:"kurdish",label:"افلام كردي"},{key:"asian",label:"افلام اسيوية"},{key:"turkish",label:"افلام تركية"},{key:"arabic",label:"افلام عربي"},{key:"classic",label:"افلام كلاسيكيه"},{key:"dubbed",label:"افلام مدبلجة"},{key:"indian",label:"افلام هندية"},{key:"anime",label:"افلام انمي"}],_t=async()=>{let i=[],r=0;const m=1e3;for(;;){const{data:d,error:f}=await E.from("movies").select("*").order("created_at",{ascending:!1}).range(r,r+m-1);if(f)throw console.error("Error fetching a batch of movies for admin: ",f.message),f;if(d&&d.length>0){if(i=i.concat(d),d.length<m)break;r+=d.length}else break}return i},Et=()=>{const[i,r]=o.useState([]),[m,d]=o.useState(null),[f,s]=o.useState(!1),[c,k]=o.useState(1),[y,O]=o.useState("all"),[K,z]=o.useState(""),[X,p]=o.useState(!1),[v,B]=o.useState(null),[q,A]=o.useState(!0),[I,_]=o.useState(!1),[M,J]=o.useState(null),[G,w]=o.useState([]),[R,u]=o.useState(null),[x,h]=o.useState([]),[C,$]=mt(),L=o.useRef(!1),se=async()=>{try{const S=await _t();r(S)}catch(S){console.error("Error fetching movies: ",S),P("فشل في تحميل الأفلام.","error")}const{data:a,error:b}=await E.from("categories").select("name").order("name");b?console.error("Error fetching categories from ManageMovies: ",b):h(a.map(S=>S.name)),A(!1)};o.useEffect(()=>{A(!0),se();const a=E.channel("public:movies").on("postgres_changes",{event:"*",schema:"public",table:"movies"},()=>se()).subscribe();return()=>{E.removeChannel(a)}},[]),o.useEffect(()=>{if(q||L.current)return;const a=C.get("edit");if(a&&i.length>0){const b=i.find(S=>S.id===a);b&&(Y(b),C.delete("edit"),$(C,{replace:!0}),L.current=!0)}},[C,$,i,q]),o.useEffect(()=>{k(1),w([])},[y,K]);const P=(a,b)=>{J({message:a,type:b})},ve=async a=>{_(!0);try{const{error:b}=await E.from("movies").insert([{...a,created_at:new Date().toISOString()}]);if(b)throw b;await se(),s(!1),k(1),P("تمت إضافة الفيلم بنجاح.","success")}catch(b){console.error("Error adding movie: ",b);const S=b.message||JSON.stringify(b);P(`حدث خطأ أثناء إضافة الفيلم: ${S}`,"error")}finally{_(!1)}},ue=async(a,b)=>{_(!0);try{const{error:S}=await E.from("movies").update(b).eq("id",a);if(S)throw S;await se(),d(null),s(!1),P("تم تحديث الفيلم بنجاح.","success")}catch(S){console.error("Error updating movie: ",S);const re=S.message||JSON.stringify(S);P(`حدث خطأ أثناء تحديث الفيلم: ${re}`,"error")}finally{_(!1)}},N=a=>{B(a),p(!0)},U=async()=>{if(v){_(!0);try{const{error:a}=await E.from("movies").delete().eq("id",v.id);if(a)throw a;P("تم حذف الفيلم بنجاح.","success")}catch(a){console.error("Error deleting movie: ",a);const b=a.message||JSON.stringify(a);P(`حدث خطأ أثناء حذف الفيلم: ${b}`,"error")}finally{p(!1),B(null),_(!1)}}},Y=a=>{d(a),s(!0)},H=()=>{d(null),s(!0)},D=()=>{d(null),s(!1),u(null)},Z=a=>{w(b=>b.includes(a)?b.filter(S=>S!==a):[...b,a])},ne=a=>{a.target.checked?w(te.map(b=>b.id)):w(G.filter(b=>!te.some(S=>S.id===b)))},ee=async(a,b)=>{_(!0);try{const{error:S}=await E.from("movies").update(a).in("id",G);if(S)throw S;P(b,"success"),w([])}catch(S){console.error("Bulk update failed:",S),P("فشل التحديث الجماعي.","error")}finally{_(!1),u(null)}},n=async a=>{await ee({movie_type:a,is_kurdish:a==="kurdish"},"تم تغيير النوع بنجاح.")},t=async()=>{_(!0);try{const{error:a}=await E.from("movies").delete().in("id",G);if(a)throw a;P(`تم حذف ${G.length} فيلم بنجاح.`,"success"),w([])}catch(a){console.error("Bulk delete failed:",a),P("فشل الحذف الجماعي.","error")}finally{_(!1),u(null)}},l=async(a,b)=>{_(!0);try{const{data:S,error:re}=await E.from("movies").select("id, genres").in("id",G);if(re)throw re;const Ee=S.map(we=>{const je=we.genres||[];let ge;return b==="add"?ge=[...new Set([...je,a])]:ge=je.filter($e=>$e!==a),{id:we.id,genres:ge}}),{error:ye}=await E.from("movies").upsert(Ee);if(ye)throw ye;P(`تم ${b==="add"?"إضافة":"إزالة"} فئة "${a}" بنجاح.`,"success"),w([])}catch(S){console.error("Bulk genre change failed:",S),P("فشل تغيير الفئة الجماعي.","error")}finally{_(!1),u(null)}},g=async(a,b)=>{_(!0);try{const{data:S,error:re}=await E.from("movies").select("id, tags").in("id",G);if(re)throw re;const Ee=S.map(we=>{const je=we.tags||[];let ge;return b==="add"?ge=[...new Set([...je,a])]:ge=je.filter($e=>$e!==a),{id:we.id,tags:ge}}),{error:ye}=await E.from("movies").upsert(Ee);if(ye)throw ye;P(`تم ${b==="add"?"إضافة":"إزالة"} الكلمة الدلالية "${a}" بنجاح.`,"success"),w([])}catch(S){console.error("Bulk tags change failed:",S),P("فشل تغيير الكلمات الدلالية الجماعي.","error")}finally{_(!1),u(null)}},j=i.filter(a=>y==="all"?!0:y==="foreign"?a.movie_type==="foreign"||!a.movie_type:y==="kurdish"?a.movie_type==="kurdish"||a.is_kurdish===!0:a.movie_type===y).filter(a=>ht(K,a.title)),F=Math.ceil(j.length/ze),te=j.slice((c-1)*ze,c*ze),ae=te.length>0&&te.every(a=>G.includes(a.id)),me=a=>{var S;let b=a.movie_type;return!b&&a.is_kurdish?b="kurdish":b||(b="foreign"),((S=nt.find(re=>re.key===b))==null?void 0:S.label)||b};return q?e.jsx(xt,{}):e.jsxs("div",{className:"relative",children:[M&&e.jsx(ct,{...M,onClose:()=>J(null)}),e.jsx(Se,{isOpen:X,onClose:()=>p(!1),onConfirm:U,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الفيلم ",e.jsxs("strong",{className:"text-white",children:['"',v==null?void 0:v.title,'"']}),"؟ ",e.jsx("br",{})," ",e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:I}),R==="delete"&&e.jsx(Se,{isOpen:!0,onClose:()=>u(null),onConfirm:t,title:`تأكيد حذف ${G.length} فيلم`,message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الأفلام المحددة؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:I}),R==="genre"&&e.jsx(gt,{genres:x,onClose:D,onSubmit:l,isLoading:I}),R==="tags"&&e.jsx(pt,{onClose:D,onSubmit:g,isLoading:I}),R==="year"&&e.jsx(Ct,{onClose:D,onSubmit:a=>ee({year:a},"تم تحديث السنة بنجاح."),isLoading:I}),R==="changeType"&&e.jsx(St,{movieTypes:nt,onClose:D,onSubmit:n,isLoading:I}),f&&e.jsx(_e,{title:m?"تعديل الفيلم":"إضافة فيلم جديد",onClose:D,isOpen:f,children:e.jsx(vt,{onSubmit:m?a=>ue(m.id,a):ve,initialData:m,onCancel:D,isLoading:I,allGenres:x})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center mb-6 gap-4 w-full",children:[e.jsx("button",{onClick:H,className:"bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2.5 px-5 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-lg w-full sm:w-auto flex-shrink-0",children:"إضافة فيلم جديد"}),e.jsxs("div",{className:"relative w-full sm:flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",value:K,onChange:a=>z(a.target.value),placeholder:"ابحث عن فيلم للتعديل...",className:"w-full bg-slate-700 text-white p-2.5 pl-10 rounded-lg focus:ring-2 focus:ring-cyan-500 border-none outline-none transition-colors","aria-label":"Search for a movie to edit"})]}),e.jsxs("select",{value:y,onChange:a=>O(a.target.value),className:"w-full sm:w-auto bg-slate-700 text-white p-2.5 rounded-lg focus:ring-2 focus:ring-cyan-500 border-none outline-none transition-colors flex-shrink-0","aria-label":"Filter by movie type",children:[e.jsx("option",{value:"all",children:"كل الأنواع"}),nt.map(a=>e.jsx("option",{value:a.key,children:a.label},a.key))]})]}),G.length>0&&e.jsxs("div",{className:"bg-slate-900/80 backdrop-blur-sm border border-cyan-500 rounded-lg p-3 mb-4 flex flex-wrap items-center justify-between gap-3 animate-fade-in-down",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-white font-bold",children:[G.length," فيلم محدد"]}),e.jsx("button",{onClick:()=>w([]),className:"text-sm text-cyan-400 hover:underline",children:"إلغاء التحديد"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>u("changeType"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير النوع"}),e.jsx("button",{onClick:()=>u("genre"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الفئة"}),e.jsx("button",{onClick:()=>u("tags"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الكلمات"}),e.jsx("button",{onClick:()=>u("year"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير السنة"}),e.jsx("button",{onClick:()=>u("delete"),className:"bg-red-600 text-sm py-1 px-3 rounded-md hover:bg-red-500",children:"حذف المحدد"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"overflow-x-auto hidden lg:block",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-900/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right",children:e.jsx("input",{type:"checkbox",onChange:ne,checked:ae,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الصورة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"العنوان"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تقييم IMDb"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"السنة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الفئات"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"نوع الفيلم"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تاريخ الإضافة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:te.map(a=>{var b,S;return e.jsxs("tr",{className:`${G.includes(a.id)?"bg-cyan-500/20":"hover:bg-slate-700/50"} transition-colors duration-200`,children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:G.includes(a.id),onChange:()=>Z(a.id),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:e.jsx("img",{src:a.poster_url,alt:a.title,className:"h-20 w-auto rounded object-cover",loading:"lazy"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap font-medium text-white align-middle",children:a.title}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-yellow-400 font-bold align-middle",children:a.imdb_rating?a.imdb_rating.toFixed(1):"N/A"}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:a.year}),e.jsx("td",{className:"px-4 py-2 text-slate-300 align-middle",children:e.jsxs("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(b=a.genres)==null?void 0:b.slice(0,3).map(re=>e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:re},re)),((S=a.genres)==null?void 0:S.length)>3&&e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:"..."})]})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:me(a)}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:a.created_at?new Date(a.created_at).toLocaleDateString("ar-EG"):"غير متاح"}),e.jsxs("td",{className:"px-4 py-2 whitespace-nowrap font-medium align-middle",children:[e.jsx("button",{onClick:()=>Y(a),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>N(a),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},a.id)})})]})}),e.jsxs("div",{className:"block lg:hidden space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("input",{type:"checkbox",onChange:ne,checked:ae,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("label",{className:"text-sm text-slate-300",children:"تحديد الكل في هذه الصفحة"})]}),te.map(a=>{var b,S;return e.jsxs("div",{className:`p-3 rounded-lg transition-all duration-200 ${G.includes(a.id)?"bg-cyan-500/20 ring-2 ring-cyan-500":"bg-slate-900/50"}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-24",children:e.jsx("img",{src:a.poster_url,alt:a.title,className:"w-full rounded object-cover",loading:"lazy"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h3",{className:"font-bold text-white truncate flex-grow pr-2",children:a.title}),e.jsx("input",{type:"checkbox",checked:G.includes(a.id),onChange:()=>Z(a.id),className:"h-5 w-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600 flex-shrink-0"})]}),e.jsxs("div",{className:"text-sm text-slate-400 mt-1 flex items-center gap-x-2 flex-wrap",children:[e.jsx("span",{children:a.year}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{className:"text-yellow-400 font-bold",children:a.imdb_rating?a.imdb_rating.toFixed(1):"N/A"}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{children:me(a)})]}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[(b=a.genres)==null?void 0:b.slice(0,2).map(re=>e.jsx("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:re},re)),((S=a.genres)==null?void 0:S.length)>2&&e.jsxs("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:["+",a.genres.length-2]})]})]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700 flex justify-end items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-xs text-slate-500 mr-auto",children:["أضيف في: ",a.created_at?new Date(a.created_at).toLocaleDateString("ar-EG"):"N/A"]}),e.jsx("button",{onClick:()=>Y(a),className:"font-medium text-cyan-400 hover:text-cyan-300",children:"تعديل"}),e.jsx("button",{onClick:()=>N(a),className:"font-medium text-red-500 hover:text-red-400",children:"حذف"})]})]},a.id)})]})]}),j.length>ze&&e.jsx("div",{className:"p-4 mt-4 border-t border-slate-700",children:e.jsx(it,{currentPage:c,totalPages:F,onPageChange:k})})]})},$t=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),Mt=({onSubmit:i,initialData:r,onCancel:m,isLoading:d=!1,allGenres:f=[]})=>{const[s,c]=o.useState({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],seasons:[{season_number:1,title:"الموسم 1",description:"",poster_url:"",year:new Date().getFullYear(),episodes:[{episode_number:1,title:"الحلقة 1",url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"FullHD"}],imdb_rating:0}],trailer_url:"",imdb_rating:0}),[k,y]=o.useState(""),[O,K]=o.useState(!1),z=o.useRef(null);o.useEffect(()=>{r&&(c({...r,genres:r.genres||[],tags:r.tags||[],seasons:r.seasons&&r.seasons.length>0?r.seasons:[{season_number:1,title:"الموسم 1",description:"",poster_url:r.poster_url,year:r.year,episodes:[],imdb_rating:0}],trailer_url:r.trailer_url||"",imdb_rating:r.imdb_rating||0}),y((r.tags||[]).join(", ")))},[r]),o.useEffect(()=>{const u=x=>{z.current&&!z.current.contains(x.target)&&K(!1)};return document.addEventListener("mousedown",u),()=>document.removeEventListener("mousedown",u)},[]);const X=async u=>{var x;try{if(!((x=navigator.clipboard)!=null&&x.readText))throw new Error("Clipboard API not available.");const h=await navigator.clipboard.readText();h&&u(h)}catch(h){console.error("Failed to read clipboard contents: ",h),alert("فشل لصق النص. يرجى التأكد من منح الإذن لاستخدام الحافظة.")}},p=u=>{const{name:x,value:h}=u.target;if(x==="year"||x==="imdb_rating"){const C=parseFloat(h);c($=>({...$,[x]:isNaN(C)?0:C}))}else c(C=>({...C,[x]:h}))},v=u=>{y(u.target.value)},B=u=>{c(x=>({...x,genres:x.genres.includes(u)?x.genres.filter(h=>h!==u):[...x.genres,u]}))},q=(u,x,h)=>{const C=[...s.seasons],$={...C[u]};if(x==="season_number"||x==="year"||x==="imdb_rating"){const L=typeof h=="string"?parseFloat(h):h;$[x]=isNaN(L)?0:L}else $[x]=h;C[u]=$,c(L=>({...L,seasons:C}))},A=()=>{const u=s.seasons.length>0?Math.max(...s.seasons.map(h=>h.season_number))+1:1,x=s.seasons.length>0?s.seasons[s.seasons.length-1].year:s.year;c(h=>({...h,seasons:[...h.seasons,{season_number:u,title:`الموسم ${u}`,description:"",poster_url:h.poster_url,year:x+1,episodes:[{episode_number:1,title:"الحلقة 1",url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"FullHD"}],imdb_rating:0}]}))},I=u=>{c(x=>({...x,seasons:x.seasons.filter((h,C)=>C!==u)}))},_=(u,x,h,C)=>{const $=[...s.seasons],L=[...$[u].episodes],se={...L[x]};if(h==="episode_number"){const P=typeof C=="string"?parseFloat(C):C;se[h]=isNaN(P)?0:P}else se[h]=C;L[x]=se,$[u]={...$[u],episodes:L},c(P=>({...P,seasons:$}))},M=u=>{const x=s.seasons[u],h=x.episodes.length>0?Math.max(...x.episodes.map(L=>L.episode_number))+1:1,C={episode_number:h,title:`الحلقة ${h}`,url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"FullHD"},$=s.seasons.map((L,se)=>se===u?{...L,episodes:[...L.episodes,C]}:L);c(L=>({...L,seasons:$}))},J=(u,x)=>{const h=s.seasons.map((C,$)=>$===u?{...C,episodes:C.episodes.filter((L,se)=>se!==x)}:C);c(C=>({...C,seasons:h}))},G=u=>{u.preventDefault();const x=k.split(",").map(h=>h.trim()).filter(Boolean);i({...s,tags:x})},w="w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",R="bg-slate-600 text-white p-2 rounded-md border border-slate-500 focus:border-cyan-500 outline-none";return e.jsxs("form",{onSubmit:G,children:[e.jsxs("div",{className:"space-y-6 pb-24",children:[e.jsx("h3",{className:"text-xl font-bold text-white border-b border-slate-700 pb-2",children:"معلومات المسلسل الرئيسية"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"text",name:"title",value:s.title,onChange:p,placeholder:"عنوان المسلسل",required:!0,className:w}),e.jsx("input",{type:"number",name:"year",value:s.year||"",onChange:p,placeholder:"سنة بداية العرض",required:!0,className:w})]}),e.jsx("textarea",{name:"description",value:s.description,onChange:p,placeholder:"وصف المسلسل العام",required:!0,className:`${w} h-24`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"url",name:"poster_url",value:s.poster_url,onChange:p,placeholder:"رابط البوستر الرئيسي",required:!0,className:w}),e.jsx("input",{type:"url",name:"backdrop_url",value:s.backdrop_url,onChange:p,placeholder:"رابط صورة الخلفية",required:!0,className:w})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"number",name:"imdb_rating",value:s.imdb_rating??"",onChange:p,placeholder:"تقييم IMDb (e.g. 8.5)",step:"0.1",min:"0",max:"10",className:w}),e.jsx("input",{type:"url",name:"trailer_url",value:s.trailer_url??"",onChange:p,placeholder:"رابط المقطع الدعائي (اختياري)",className:w})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الفئات"}),e.jsxs("div",{className:"relative",ref:z,children:[e.jsx("button",{type:"button",onClick:()=>K(u=>!u),className:`${w} text-right`,children:s.genres.length>0?s.genres.join(", "):"اختر الفئات..."}),O&&e.jsx("div",{className:"absolute z-10 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto",children:f.map(u=>e.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-700 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:s.genres.includes(u),onChange:()=>B(u),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("span",{className:"text-white",children:u})]},u))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الكلمات الدلالية (مفصولة بفاصلة)"}),e.jsx("input",{type:"text",value:k,onChange:v,placeholder:"أكشن, إثارة...",className:w})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"المواسم والحلقات"}),s.seasons.map((u,x)=>e.jsxs("div",{className:"bg-slate-900/50 p-4 rounded-lg border border-slate-700 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-white font-semibold",children:"الموسم رقم:"}),e.jsx("input",{type:"number",value:u.season_number||"",onChange:h=>q(x,"season_number",h.target.value),className:`${R} w-20`})]}),e.jsx("button",{type:"button",onClick:()=>I(x),className:"bg-red-600 text-white px-3 py-1 rounded-md text-sm",children:"إزالة الموسم"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsx("input",{type:"text",value:u.title,onChange:h=>q(x,"title",h.target.value),placeholder:"عنوان الموسم",required:!0,className:R}),e.jsx("input",{type:"number",value:u.year||"",onChange:h=>q(x,"year",h.target.value),placeholder:"سنة الموسم",required:!0,className:R}),e.jsx("input",{type:"number",value:u.imdb_rating??"",onChange:h=>q(x,"imdb_rating",h.target.value),placeholder:"تقييم IMDb",step:"0.1",min:"0",max:"10",className:R}),e.jsx("input",{type:"url",value:u.poster_url,onChange:h=>q(x,"poster_url",h.target.value),placeholder:"رابط بوستر الموسم",required:!0,className:`${R} col-span-1 sm:col-span-3`}),e.jsx("textarea",{value:u.description,onChange:h=>q(x,"description",h.target.value),placeholder:"وصف الموسم",required:!0,className:`${R} h-20 col-span-1 sm:col-span-3`})]}),e.jsxs("div",{className:"space-y-2 pt-3 mt-3 border-t border-slate-600",children:[e.jsxs("h4",{className:"font-semibold text-slate-300",children:["حلقات الموسم ",u.season_number,":"]}),u.episodes.map((h,C)=>e.jsxs("div",{className:"bg-slate-800/60 p-2 rounded-md space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:h.episode_number||"",onChange:$=>_(x,C,"episode_number",$.target.value),placeholder:"رقم",className:`${R} w-16`}),e.jsx("input",{type:"text",value:h.title,onChange:$=>_(x,C,"title",$.target.value),placeholder:"عنوان الحلقة",className:`${R} flex-1`}),e.jsx("button",{type:"button",onClick:()=>J(x,C),className:"bg-red-500 text-white p-2 rounded-md hover:bg-red-600 text-xs",children:"X"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("input",{type:"url",value:h.url,onChange:$=>_(x,C,"url",$.target.value),placeholder:"رابط المشاهدة",required:!0,className:`${R} flex-1`}),e.jsx("button",{type:"button",onClick:()=>X($=>_(x,C,"url",$)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsxs("select",{value:h.quality||"FullHD",onChange:$=>_(x,C,"quality",$.target.value),className:`${R} w-28 flex-shrink-0`,children:[e.jsx("option",{value:"FullHD",children:"FullHD"}),e.jsx("option",{value:"HD",children:"HD"}),e.jsx("option",{value:"SD",children:"SD"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:h.download_url||"",onChange:$=>_(x,C,"download_url",$.target.value),placeholder:"رابط التحميل (اختياري)",className:`${R} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>X($=>_(x,C,"download_url",$)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]})]})]},C)),e.jsx("button",{type:"button",onClick:()=>M(x),className:"text-sm bg-slate-600 text-white py-1 px-3 rounded-md hover:bg-slate-500",children:"إضافة حلقة"})]})]},x)),e.jsx("button",{type:"button",onClick:A,className:"bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700",children:"إضافة موسم"})]})]}),e.jsxs("div",{className:"sticky bottom-0 z-10 bg-slate-800/95 backdrop-blur-sm p-4 border-t border-slate-700 flex justify-end gap-4 -mx-6 -mb-6 md:-mx-8 md:-mb-8 rounded-b-lg",children:[e.jsx("button",{type:"button",onClick:m,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg",disabled:d,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg",disabled:d,children:[d&&e.jsx($t,{}),r?"تحديث المسلسل":"إضافة المسلسل"]})]})]})},Ie=10,Ft=()=>{const[i,r]=o.useState([]),[m,d]=o.useState(null),[f,s]=o.useState(!1),[c,k]=o.useState(1),[y,O]=o.useState(""),[K,z]=o.useState(!1),[X,p]=o.useState(null),[v,B]=o.useState(!0),[q,A]=o.useState(!1),[I,_]=o.useState(null),[M,J]=o.useState([]),[G,w]=o.useState(null),[R,u]=o.useState([]),x=async()=>{const{data:t,error:l}=await E.from("series").select("*").order("created_at",{ascending:!1});l?(console.error("Error fetching series: ",l),h("فشل في تحميل المسلسلات.","error")):r(t);const{data:g,error:j}=await E.from("categories").select("name").order("name");j?console.error("Error fetching categories: ",j):u(g.map(F=>F.name)),B(!1)};o.useEffect(()=>{B(!0),x();const t=E.channel("public:series").on("postgres_changes",{event:"*",schema:"public",table:"series"},x).subscribe();return()=>{E.removeChannel(t)}},[]),o.useEffect(()=>{k(1),J([])},[y]);const h=(t,l)=>{_({message:t,type:l})},C=async t=>{A(!0);try{const{error:l}=await E.from("series").insert([{...t,created_at:new Date().toISOString()}]);if(l)throw l;await x(),s(!1),k(1),h("تمت إضافة المسلسل بنجاح.","success")}catch(l){console.error("Error adding series: ",l);const g=l.message||JSON.stringify(l);h(`حدث خطأ أثناء إضافة المسلسل: ${g}`,"error")}finally{A(!1)}},$=async(t,l)=>{A(!0);try{const{error:g}=await E.from("series").update(l).eq("id",t);if(g)throw g;await x(),d(null),s(!1),h("تم تحديث المسلسل بنجاح.","success")}catch(g){console.error("Error updating series:",g);const j=g.message||JSON.stringify(g);h(`حدث خطأ أثناء تحديث المسلسل: ${j}`,"error")}finally{A(!1)}},L=t=>{p(t),z(!0)},se=async()=>{if(X){A(!0);try{const{error:t}=await E.from("series").delete().eq("id",X.id);if(t)throw t;h("تم حذف المسلسل بنجاح.","success")}catch(t){console.error("Error deleting series:",t);const l=t.message||JSON.stringify(t);h(`حدث خطأ أثناء حذف المسلسل: ${l}`,"error")}finally{z(!1),p(null),A(!1)}}},P=t=>{d(t),s(!0)},ve=()=>{d(null),s(!0)},ue=()=>{d(null),s(!1),w(null)},N=t=>{J(l=>l.includes(t)?l.filter(g=>g!==t):[...l,t])},U=t=>{t.target.checked?J(ee.map(l=>l.id)):J(M.filter(l=>!ee.some(g=>g.id===l)))},Y=async()=>{A(!0);try{const{error:t}=await E.from("series").delete().in("id",M);if(t)throw t;h(`تم حذف ${M.length} مسلسل بنجاح.`,"success"),J([])}catch(t){console.error("Bulk delete failed:",t),h("فشل الحذف الجماعي.","error")}finally{A(!1),w(null)}},H=async(t,l)=>{A(!0);try{const{data:g,error:j}=await E.from("series").select("id, genres").in("id",M);if(j)throw j;const F=g.map(ae=>{const me=ae.genres||[],a=l==="add"?[...new Set([...me,t])]:me.filter(b=>b!==t);return{id:ae.id,genres:a}}),{error:te}=await E.from("series").upsert(F);if(te)throw te;h(`تم ${l==="add"?"إضافة":"إزالة"} فئة "${t}" بنجاح.`,"success"),J([])}catch(g){console.error("Bulk genre change failed:",g),h("فشل تغيير الفئة الجماعي.","error")}finally{A(!1),w(null)}},D=async(t,l)=>{A(!0);try{const{data:g,error:j}=await E.from("series").select("id, tags").in("id",M);if(j)throw j;const F=g.map(ae=>{const me=ae.tags||[],a=l==="add"?[...new Set([...me,t])]:me.filter(b=>b!==t);return{id:ae.id,tags:a}}),{error:te}=await E.from("series").upsert(F);if(te)throw te;h(`تم ${l==="add"?"إضافة":"إزالة"} الكلمة الدلالية "${t}" بنجاح.`,"success"),J([])}catch(g){console.error("Bulk tags change failed:",g),h("فشل تغيير الكلمات الدلالية الجماعي.","error")}finally{A(!1),w(null)}},Z=i.filter(t=>ht(y,t.title)),ne=Math.ceil(Z.length/Ie),ee=Z.slice((c-1)*Ie,c*Ie),n=ee.length>0&&ee.every(t=>M.includes(t.id));return v?e.jsx(xt,{}):e.jsxs("div",{className:"relative",children:[I&&e.jsx(ct,{...I,onClose:()=>_(null)}),e.jsx(Se,{isOpen:K,onClose:()=>z(!1),onConfirm:se,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف المسلسل ",e.jsxs("strong",{className:"text-white",children:['"',X==null?void 0:X.title,'"']}),"؟ ",e.jsx("br",{})," ",e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:q}),G==="delete"&&e.jsx(Se,{isOpen:!0,onClose:()=>w(null),onConfirm:Y,title:`تأكيد حذف ${M.length} مسلسل`,message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف المسلسلات المحددة؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:q}),G==="genre"&&e.jsx(gt,{genres:R,onClose:ue,onSubmit:H,isLoading:q}),G==="tags"&&e.jsx(pt,{onClose:ue,onSubmit:D,isLoading:q}),f&&e.jsx(_e,{title:m?"تعديل المسلسل":"إضافة مسلسل جديد",onClose:ue,isOpen:f,children:e.jsx(Mt,{onSubmit:m?t=>$(m.id,t):C,initialData:m,onCancel:ue,isLoading:q,allGenres:R})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center mb-6 gap-4 w-full",children:[e.jsx("button",{onClick:ve,className:"bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2.5 px-5 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-lg w-full sm:w-auto flex-shrink-0",children:"إضافة مسلسل جديد"}),e.jsxs("div",{className:"relative w-full sm:flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",value:y,onChange:t=>O(t.target.value),placeholder:"ابحث عن مسلسل للتعديل...",className:"w-full bg-slate-700 text-white p-2.5 pl-10 rounded-lg focus:ring-2 focus:ring-cyan-500 border-none outline-none transition-colors","aria-label":"Search for a series to edit"})]})]}),M.length>0&&e.jsxs("div",{className:"bg-slate-900/80 backdrop-blur-sm border border-cyan-500 rounded-lg p-3 mb-4 flex flex-wrap items-center justify-between gap-3 animate-fade-in-down",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-white font-bold",children:[M.length," مسلسل محدد"]}),e.jsx("button",{onClick:()=>J([]),className:"text-sm text-cyan-400 hover:underline",children:"إلغاء التحديد"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>w("genre"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الفئة"}),e.jsx("button",{onClick:()=>w("tags"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الكلمات"}),e.jsx("button",{onClick:()=>w("delete"),className:"bg-red-600 text-sm py-1 px-3 rounded-md hover:bg-red-500",children:"حذف المحدد"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"overflow-x-auto hidden lg:block",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-900/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right",children:e.jsx("input",{type:"checkbox",onChange:U,checked:n,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الصورة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"العنوان"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تقييم IMDb"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"السنة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الفئات"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"المواسم"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تاريخ الإضافة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:ee.map(t=>{var l,g,j;return e.jsxs("tr",{className:`${M.includes(t.id)?"bg-cyan-500/20":"hover:bg-slate-700/50"} transition-colors duration-200`,children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:M.includes(t.id),onChange:()=>N(t.id),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:e.jsx("img",{src:t.poster_url,alt:t.title,className:"h-20 w-auto rounded object-cover",loading:"lazy"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap font-medium text-white align-middle",children:t.title}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-yellow-400 font-bold align-middle",children:t.imdb_rating?t.imdb_rating.toFixed(1):"N/A"}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:t.year}),e.jsx("td",{className:"px-4 py-2 text-slate-300 align-middle",children:e.jsxs("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(l=t.genres)==null?void 0:l.slice(0,3).map(F=>e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:F},F)),((g=t.genres)==null?void 0:g.length)>3&&e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:"..."})]})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:((j=t.seasons)==null?void 0:j.length)||0}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:t.created_at?new Date(t.created_at).toLocaleDateString("ar-EG"):"غير متاح"}),e.jsxs("td",{className:"px-4 py-2 whitespace-nowrap font-medium align-middle",children:[e.jsx("button",{onClick:()=>P(t),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>L(t),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},t.id)})})]})}),e.jsxs("div",{className:"block lg:hidden space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("input",{type:"checkbox",onChange:U,checked:n,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("label",{className:"text-sm text-slate-300",children:"تحديد الكل في هذه الصفحة"})]}),ee.map(t=>{var l,g,j;return e.jsxs("div",{className:`p-3 rounded-lg transition-all duration-200 ${M.includes(t.id)?"bg-cyan-500/20 ring-2 ring-cyan-500":"bg-slate-900/50"}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-24",children:e.jsx("img",{src:t.poster_url,alt:t.title,className:"w-full rounded object-cover",loading:"lazy"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h3",{className:"font-bold text-white truncate flex-grow pr-2",children:t.title}),e.jsx("input",{type:"checkbox",checked:M.includes(t.id),onChange:()=>N(t.id),className:"h-5 w-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600 flex-shrink-0"})]}),e.jsxs("div",{className:"text-sm text-slate-400 mt-1 flex items-center gap-x-2 flex-wrap",children:[e.jsx("span",{children:t.year}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{className:"text-yellow-400 font-bold",children:t.imdb_rating?t.imdb_rating.toFixed(1):"N/A"}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsxs("span",{children:[((l=t.seasons)==null?void 0:l.length)||0," مواسم"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[(g=t.genres)==null?void 0:g.slice(0,2).map(F=>e.jsx("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:F},F)),((j=t.genres)==null?void 0:j.length)>2&&e.jsxs("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:["+",t.genres.length-2]})]})]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700 flex justify-end items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-xs text-slate-500 mr-auto",children:["أضيف في: ",t.created_at?new Date(t.created_at).toLocaleDateString("ar-EG"):"N/A"]}),e.jsx("button",{onClick:()=>P(t),className:"font-medium text-cyan-400 hover:text-cyan-300",children:"تعديل"}),e.jsx("button",{onClick:()=>L(t),className:"font-medium text-red-500 hover:text-red-400",children:"حذف"})]})]},t.id)})]})]}),Z.length>Ie&&e.jsx("div",{className:"p-4 mt-4 border-t border-slate-700",children:e.jsx(it,{currentPage:c,totalPages:ne,onPageChange:k})})]})},qt=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),At=({onSubmit:i,initialData:r,onCancel:m,isLoading:d=!1})=>{const[f,s]=o.useState("");o.useEffect(()=>{s(r?r.name:"")},[r]);const c=k=>{k.preventDefault(),f.trim()&&i({name:f})};return e.jsxs("form",{onSubmit:c,className:"space-y-6",children:[e.jsx("input",{type:"text",name:"name",value:f,onChange:k=>s(k.target.value),placeholder:"اسم الفئة",required:!0,className:"w-full bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:m,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:d,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",disabled:d,children:[d&&e.jsx(qt,{}),d?r?"جاري التحديث...":"جاري الإضافة...":r?"تحديث":"إضافة"]})]})]})},Tt=10,Ot=()=>e.jsx("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden mt-8 animate-pulse",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/3"})}),e.jsx("th",{className:"px-6 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/4"})})]})}),e.jsx("tbody",{children:[...Array(Tt)].map((i,r)=>e.jsxs("tr",{className:"border-b border-gray-700",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/2"})})]},r))})]})})}),Pt=({isOpen:i,onClose:r,onSubmit:m,isLoading:d,categories:f})=>{const[s,c]=o.useState(""),[k,y]=o.useState(""),[O,K]=o.useState(""),z=yt.useMemo(()=>f.filter(p=>p.name!==s),[f,s]);o.useEffect(()=>{if(i&&f.length>0){const p=f[0].name;c(p);const v=f.filter(B=>B.name!==p);y(v.length>0?v[0].name:"")}},[i,f]),o.useEffect(()=>{K(s&&k&&s===k?"لا يمكن دمج فئة مع نفسها. الرجاء اختيار فئتين مختلفتين.":"")},[s,k]),o.useEffect(()=>{z.some(p=>p.name===k)||y(z.length>0?z[0].name:"")},[s,z,k]);const X=p=>{p.preventDefault(),!(O||!s||!k)&&m(s,k)};return e.jsx(_e,{title:"توحيد (دمج) الفئات",onClose:r,isOpen:i,children:e.jsxs("form",{onSubmit:X,className:"space-y-6",children:[e.jsx("p",{className:"text-slate-300",children:"سيتم نقل كل المحتوى من الفئة المصدر إلى الفئة الهدف، ثم سيتم حذف الفئة المصدر نهائياً."}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source_category",className:"block text-sm font-medium text-slate-300 mb-2",children:"دمج من هذه الفئة (سيتم حذفها):"}),e.jsx("select",{id:"source_category",value:s,onChange:p=>c(p.target.value),required:!0,className:"w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",children:f.map(p=>e.jsx("option",{value:p.name,children:p.name},p.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"destination_category",className:"block text-sm font-medium text-slate-300 mb-2",children:"الدمج في هذه الفئة (ستبقى):"}),e.jsx("select",{id:"destination_category",value:k,onChange:p=>y(p.target.value),required:!0,className:"w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",disabled:z.length===0,children:z.map(p=>e.jsx("option",{value:p.name,children:p.name},p.id))})]}),O&&e.jsx("p",{className:"text-red-400 text-center text-sm bg-red-500/10 p-2 rounded-md",children:O}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-slate-700",children:[e.jsx("button",{type:"button",onClick:r,disabled:d,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:d||!!O||!s||!k,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",children:[d&&e.jsx(Ce,{}),d?"جاري الدمج...":"تنفيذ الدمج"]})]})]})})},He=10,Dt=({message:i,type:r,onClose:m})=>(o.useEffect(()=>{const s=setTimeout(m,5e3);return()=>clearTimeout(s)},[m]),e.jsx("div",{className:`fixed top-24 right-5 z-[100] p-4 rounded-lg shadow-lg text-white border-l-4 animate-fade-in-down ${r==="success"?"bg-green-600 border-green-500":"bg-red-600 border-red-500"}`,role:"alert",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"font-bold",children:i}),e.jsx("button",{onClick:m,className:"absolute top-1 right-2 text-2xl font-bold leading-none",children:"×"})]})})),Bt=({children:i,onClose:r,title:m,isOpen:d})=>{const[f,s]=o.useState(d);return o.useEffect(()=>{if(d){s(!0),document.body.style.overflow="hidden";const c=k=>{k.key==="Escape"&&r()};return window.addEventListener("keydown",c),()=>{window.removeEventListener("keydown",c)}}else{const c=setTimeout(()=>{s(!1),document.body.style.overflow="auto"},300);return()=>clearTimeout(c)}},[d,r]),f?e.jsx("div",{className:`fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${d?"animate-fade-in":"animate-fade-out"}`,onClick:r,children:e.jsxs("div",{className:`bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 ${d?"animate-zoom-in":"animate-zoom-out"}`,onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:m}),e.jsx("button",{onClick:r,className:"text-gray-400 hover:text-white text-3xl transition-colors",children:"×"})]}),i]})}):null},Rt=()=>{const[i,r]=o.useState([]),[m,d]=o.useState(null),[f,s]=o.useState(!1),[c,k]=o.useState(1),[y,O]=o.useState(!1),[K,z]=o.useState(null),[X,p]=o.useState(!0),[v,B]=o.useState(!1),[q,A]=o.useState(null),[I,_]=o.useState(!1),[M,J]=o.useState(null),G=async()=>{const{data:N,error:U}=await E.from("categories").select("*").order("name");U?(console.error("Error fetching categories: ",U),w("فشل في تحميل الفئات.","error")):r(N),p(!1)};o.useEffect(()=>{p(!0),G();const N=E.channel("public:categories").on("postgres_changes",{event:"*",schema:"public",table:"categories"},G).subscribe();return()=>{E.removeChannel(N)}},[]);const w=(N,U)=>{A({message:N,type:U})},R=async N=>{B(!0);try{const{error:U}=await E.from("categories").insert([N]);if(U)throw U;w("تمت إضافة الفئة بنجاح!","success"),s(!1),k(1)}catch(U){console.error("Error adding category: ",U);const Y=U.message||JSON.stringify(U);w(`حدث خطأ أثناء إضافة الفئة: ${Y}`,"error")}finally{B(!1)}},u=async(N,U)=>{B(!0);const Y=m==null?void 0:m.name,H=U.name,D=Y&&H&&Y!==H;try{const{error:Z}=await E.from("categories").update(U).eq("id",N);if(Z)throw Z;if(D){w("تم تحديث الفئة. جاري تحديث المحتوى المرتبط...","success");const{data:ne,error:ee}=await E.from("movies").select("id, genres").contains("genres",[Y]);if(ee)console.error("Error fetching movies to update:",ee),w("تم تحديث الفئة، لكن حدث خطأ أثناء جلب الأفلام للتحديث.","error");else if(ne&&ne.length>0){const l=ne.map(F=>{const te=F.genres.map(ae=>ae===Y?H:ae);return E.from("movies").update({genres:te}).eq("id",F.id)}),j=(await Promise.all(l)).find(F=>F.error);j&&(console.error("Error updating movies with new category:",j.error),w("تم تحديث الفئة، لكن حدث خطأ أثناء تحديث بعض الأفلام.","error"))}const{data:n,error:t}=await E.from("series").select("id, genres").contains("genres",[Y]);if(t)console.error("Error fetching series to update:",t),w("تم تحديث الفئة، لكن حدث خطأ أثناء جلب المسلسلات للتحديث.","error");else if(n&&n.length>0){const l=n.map(F=>{const te=F.genres.map(ae=>ae===Y?H:ae);return E.from("series").update({genres:te}).eq("id",F.id)}),j=(await Promise.all(l)).find(F=>F.error);j&&(console.error("Error updating series with new category:",j.error),w("تم تحديث الفئة، لكن حدث خطأ أثناء تحديث بعض المسلسلات.","error"))}w("تم تحديث الفئة والمحتوى المرتبط بنجاح!","success")}else w("تم تحديث الفئة بنجاح!","success");d(null),s(!1)}catch(Z){if(console.error("Error updating category transaction: ",Z),Z.code==="23505")w(`فشل التحديث: اسم الفئة "${H}" موجود بالفعل.`,"error");else{const ne=Z.message||JSON.stringify(Z);w(`حدث خطأ أثناء تحديث الفئة: ${ne}`,"error")}}finally{B(!1)}},x=N=>{z(N),O(!0)},h=async()=>{if(K){B(!0);try{const{error:N}=await E.from("categories").delete().eq("id",K.id);if(N)throw N;w("تم حذف الفئة بنجاح!","success")}catch(N){console.error("Error deleting category: ",N);const U=N.message||JSON.stringify(N);w(`حدث خطأ أثناء حذف الفئة: ${U}`,"error")}finally{O(!1),z(null),B(!1)}}},C=N=>{d(N),s(!0)},$=()=>{d(null),s(!0)},L=()=>{d(null),s(!1)},se=(N,U)=>{_(!1),J({source:N,dest:U})},P=async()=>{if(!M)return;const{source:N,dest:U}=M;B(!0);try{w("جاري تحديث الأفلام...","success");const{data:Y,error:H}=await E.from("movies").select("id, genres").contains("genres",[N]);if(H)throw new Error(`Failed to fetch movies: ${H.message}`);if(Y&&Y.length>0){const ee=Y.map(n=>{const t=[...new Set(n.genres.filter(l=>l!==N).concat([U]))];return E.from("movies").update({genres:t}).eq("id",n.id)});await Promise.all(ee)}w("جاري تحديث المسلسلات...","success");const{data:D,error:Z}=await E.from("series").select("id, genres").contains("genres",[N]);if(Z)throw new Error(`Failed to fetch series: ${Z.message}`);if(D&&D.length>0){const ee=D.map(n=>{const t=[...new Set(n.genres.filter(l=>l!==N).concat([U]))];return E.from("series").update({genres:t}).eq("id",n.id)});await Promise.all(ee)}w("جاري حذف الفئة المدمجة...","success");const{error:ne}=await E.from("categories").delete().eq("name",N);if(ne)throw new Error(`Failed to delete category: ${ne.message}`);w("تم دمج الفئات بنجاح!","success")}catch(Y){console.error("Error merging categories: ",Y),w(`فشل دمج الفئات: ${Y.message}`,"error")}finally{J(null),B(!1)}},ve=Math.ceil(i.length/He),ue=i.slice((c-1)*He,c*He);return X?e.jsxs("div",{children:[e.jsx("div",{className:"h-10 bg-gray-700 rounded w-48 mb-6 animate-pulse"}),e.jsx(Ot,{})]}):e.jsxs("div",{children:[q&&e.jsx(Dt,{...q,onClose:()=>A(null)}),e.jsx(Se,{isOpen:y,onClose:()=>O(!1),onConfirm:h,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الفئة ",e.jsxs("strong",{className:"text-white",children:['"',K==null?void 0:K.name,'"']}),"؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:v}),e.jsx(Se,{isOpen:!!M,onClose:()=>J(null),onConfirm:P,title:"تأكيد عملية الدمج",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد دمج الفئة ",e.jsxs("strong",{className:"text-white",children:['"',M==null?void 0:M.source,'"']})," في الفئة ",e.jsxs("strong",{className:"text-white",children:['"',M==null?void 0:M.dest,'"']}),"؟",e.jsx("br",{}),e.jsxs("span",{className:"text-yellow-400",children:['سيتم حذف الفئة "',M==null?void 0:M.source,'" نهائياً. لا يمكن التراجع عن هذا الإجراء.']})]}),isLoading:v}),e.jsx(Pt,{isOpen:I,onClose:()=>_(!1),onSubmit:se,isLoading:v,categories:i}),e.jsx(Bt,{isOpen:f,title:m?"تعديل الفئة":"إضافة فئة جديدة",onClose:L,children:e.jsx(At,{onSubmit:m?N=>u(m.id,N):R,initialData:m,onCancel:L,isLoading:v})}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{onClick:$,className:"bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition-colors",children:"إضافة فئة جديدة"}),e.jsx("button",{onClick:()=>_(!0),className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors",children:"توحيد الفئات"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden hidden sm:block",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider",children:"اسم الفئة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:i.length>0?ue.map(N=>e.jsxs("tr",{className:"hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-white",children:N.name}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:[e.jsx("button",{onClick:()=>C(N),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>x(N),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},N.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"text-center py-8 text-gray-400",children:"لا توجد فئات حالياً."})})})]})})}),e.jsx("div",{className:"block sm:hidden space-y-3",children:i.length>0?ue.map(N=>e.jsxs("div",{className:"bg-slate-900/50 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-white",children:N.name}),e.jsxs("div",{className:"flex gap-4 flex-shrink-0",children:[e.jsx("button",{onClick:()=>C(N),className:"text-cyan-400 hover:text-cyan-300 text-sm font-medium",children:"تعديل"}),e.jsx("button",{onClick:()=>x(N),className:"text-red-500 hover:text-red-400 text-sm font-medium",children:"حذف"})]})]},N.id)):e.jsx("div",{className:"text-center py-8 text-gray-400 bg-slate-900/50 rounded-lg",children:"لا توجد فئات حالياً."})})]}),i.length>He&&e.jsx("div",{className:"mt-4",children:e.jsx(it,{currentPage:c,totalPages:ve,onPageChange:k})})]})},lt=["movies","series","categories"],Lt=i=>i.replace(/[A-Z]/g,r=>`_${r.toLowerCase()}`),ot=i=>Array.isArray(i)?i.map(r=>ot(r)):i!==null&&typeof i=="object"&&i.constructor===Object?i.hasOwnProperty("seconds")&&i.hasOwnProperty("nanoseconds")&&Object.keys(i).length===2&&typeof i.seconds=="number"&&typeof i.nanoseconds=="number"?new Date(i.seconds*1e3).toISOString():i.hasOwnProperty("_seconds")&&i.hasOwnProperty("_nanoseconds")&&Object.keys(i).length===2&&typeof i._seconds=="number"&&typeof i._nanoseconds=="number"?new Date(i._seconds*1e3).toISOString():Object.keys(i).reduce((r,m)=>{const d=Lt(m);return r[d]=ot(i[m]),r},{}):i,Ut=()=>{const[i,r]=o.useState(!1),[m,d]=o.useState(null),[f,s]=o.useState(!1),[c,k]=o.useState(null),y=(p,v)=>{d({message:p,type:v})},O=async()=>{r(!0),y("بدء عملية النسخ الاحتياطي... قد تستغرق هذه العملية بعض الوقت.","success");try{const p={};for(const _ of lt){const{data:M,error:J}=await E.from(_).select("*");if(J)throw J;p[_]=M||[]}const v=JSON.stringify(p,null,2),B=new Blob([v],{type:"application/json"}),q=URL.createObjectURL(B),A=document.createElement("a");A.href=q;const I=new Date().toISOString().slice(0,10);A.download=`supabase-backup-${I}.json`,document.body.appendChild(A),A.click(),document.body.removeChild(A),URL.revokeObjectURL(q),y("تم إكمال النسخ الاحتياطي بنجاح!","success")}catch(p){console.error("Backup failed:",p);let v="فشل النسخ الاحتياطي. تحقق من وحدة التحكم لمزيد من التفاصيل.";p.code==="42501"&&(v="فشل النسخ الاحتياطي: أذونات غير كافية. تأكد من أن قواعد RLS تسمح للمشرفين بقراءة المجموعات."),y(v,"error")}finally{r(!1)}},K=p=>{var B;const v=(B=p.target.files)==null?void 0:B[0];if(v){const q=new FileReader;q.onload=A=>{var I;try{const _=(I=A.target)==null?void 0:I.result,M=JSON.parse(_);k(M)}catch(_){y("ملف JSON غير صالح.","error"),console.error("JSON parsing error:",_),k(null)}},q.readAsText(v)}},z=()=>{c?s(!0):y("الرجاء تحديد ملف نسخ احتياطي أولاً.","error")},X=async()=>{if(s(!1),!!c){r(!0),y("بدء عملية الاستعادة... هذه العملية ستستغرق وقتاً.","success");try{let p=0,v=[];for(const q of Object.keys(c)){if(!lt.includes(q)){v.push(q),console.warn(`Skipping restore for unsupported collection: "${q}"`);continue}const A=c[q];if(Array.isArray(A)&&A.length>0){const I=A.map(M=>ot(M)),{error:_}=await E.from(q).upsert(I);if(_)throw console.error(`Error during upsert to "${q}":`,JSON.stringify(_,null,2)),console.error("First failed object (transformed):",JSON.stringify(I[0],null,2)),_;p++}}let B="تمت استعادة البيانات بنجاح!";v.length>0&&(B+=` تم تخطي المجموعات التالية: ${v.join(", ")}.`),p===0&&v.length>0?y(`لم يتم العثور على مجموعات بيانات صالحة للاستعادة في الملف. تم تخطي: ${v.join(", ")}.`,"error"):p>0?y(B,"success"):y("لم يتم العثور على بيانات صالحة للاستعادة في الملف.","error")}catch(p){console.error("Restore failed:",JSON.stringify(p,null,2));const v=`فشلت عملية الاستعادة: ${p.message||"خطأ غير معروف"}. يرجى مراجعة وحدة التحكم للحصول على التفاصيل الفنية.`;y(v,"error")}finally{r(!1),k(null)}}};return e.jsxs("div",{className:"space-y-12",children:[m&&e.jsx(ct,{...m,onClose:()=>d(null)}),e.jsx(Se,{isOpen:f,onClose:()=>s(!1),onConfirm:X,title:"تأكيد استعادة البيانات",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد استعادة البيانات من هذا الملف؟",e.jsx("br",{}),e.jsx("strong",{className:"text-yellow-400",children:"تحذير:"})," سيتم الكتابة فوق أي بيانات موجودة في المجموعات التي لها نفس الأسماء. لا يمكن التراجع عن هذا الإجراء."]}),isLoading:i}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"النسخ الاحتياطي للبيانات"}),e.jsxs("div",{className:"bg-slate-900/50 p-6 rounded-lg border border-slate-700 space-y-4",children:[e.jsxs("p",{className:"text-sm text-slate-400",children:["انقر على الزر أدناه لتصدير بيانات المحتوى العام (",lt.join(", "),"). لا يتم تضمين بيانات المستخدمين والمشرفين الخاصة في هذا النسخ الاحتياطي من جانب العميل لأسباب تتعلق بالأمان والأذونات."]}),e.jsxs("button",{onClick:O,disabled:i,className:"w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-800 disabled:cursor-wait",children:[i&&e.jsx(Ce,{}),i?"جاري التصدير...":"تصدير بيانات المحتوى الآن"]})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"استعادة البيانات"}),e.jsxs("div",{className:"bg-slate-900/50 p-6 rounded-lg border border-slate-700 space-y-4",children:[e.jsxs("div",{className:"p-4 border-l-4 border-yellow-500 bg-yellow-500/10 text-yellow-300 rounded-md",children:[e.jsx("strong",{className:"font-bold",children:"تحذير خطير:"})," استعادة البيانات من ملف ستقوم بالكتابة فوق البيانات الحالية في قاعدة البيانات. استخدم هذه الميزة بحذر شديد وتأكد من أنك تستخدم ملف النسخ الاحتياطي الصحيح."]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"1. حدد ملف النسخ الاحتياطي (.json)"}),e.jsx("input",{type:"file",accept:".json",onChange:K,className:"w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/20 file:text-cyan-300 hover:file:bg-cyan-500/30"})]}),e.jsxs("button",{onClick:z,disabled:i||!c,className:"w-full flex items-center justify-center bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:bg-red-800 disabled:cursor-not-allowed disabled:cursor-wait",children:[i&&e.jsx(Ce,{}),i?"جاري الاستعادة...":"2. استعادة البيانات"]})]})]})]})},We=[{key:"movies",label:"إدارة الأفلام",component:e.jsx(Et,{})},{key:"series",label:"إدارة المسلسلات",component:e.jsx(Ft,{})},{key:"categories",label:"إدارة الفئات",component:e.jsx(Rt,{})},{key:"backup",label:"النسخ الاحتياطي والاستعادة",component:e.jsx(Ut,{})}],Gt=({label:i,tabKey:r,activeTab:m,onClick:d})=>e.jsx("button",{onClick:()=>d(r),className:`px-4 py-3 font-bold transition-colors duration-300 border-b-2 -mb-px flex-shrink-0 ${m===r?"text-cyan-400 border-cyan-400":"text-slate-400 border-transparent hover:text-white hover:border-slate-500"}`,role:"tab","aria-selected":m===r,children:i}),Jt=()=>{var f;const[i,r]=o.useState(We[0].key),[m]=mt();o.useEffect(()=>{const s=m.get("tab");s&&We.some(c=>c.key===s)&&r(s)},[m]);const d=(f=We.find(s=>s.key===i))==null?void 0:f.component;return e.jsxs("div",{className:"container mx-auto px-4 py-8 animate-fade-in",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-black text-white mb-8",children:"لوحة تحكم المشرف"}),e.jsx("div",{className:"flex border-b border-slate-700 mb-6 overflow-x-auto whitespace-nowrap scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800",role:"tablist",children:We.map(s=>e.jsx(Gt,{label:s.label,tabKey:s.key,activeTab:i,onClick:r},s.key))}),e.jsx("div",{role:"tabpanel",className:"bg-slate-800 p-3 sm:p-6 rounded-lg border border-slate-700",children:d})]})};export{Jt as default};
