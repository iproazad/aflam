import{r,u as le,a as ne,j as e,s as c}from"./index-7uJ0qKqD.js";import{H as ie,a as ce}from"./HeroSliderSkeleton-D1XTqloE.js";import{M as k}from"./MoviesCarousel-CrV2xLQt.js";import{S as de,G as me,T as ge,Y as fe}from"./TagFilter-ticWPhTP.js";import{u as xe}from"./useWatchLater-B27ka-37.js";import{M as he}from"./MovieGrid-DoFVm-rM.js";import{M as U}from"./MovieGridSkeleton-DW-WaVP_.js";import{M as P}from"./MoviesCarouselSkeleton-DolZvgqU.js";import{P as ue}from"./Pagination-BK7uePpH.js";import"./MovieCardSkeleton--xuy0sGE.js";const j=30,Re=()=>{const[C,O]=r.useState([]),[V,B]=r.useState([]),[z,J]=r.useState([]),[T,_]=r.useState([]),[F,K]=r.useState([]),[G,Q]=r.useState(0),[W,X]=r.useState([]),[Z,ee]=r.useState([]),[te,se]=r.useState([]),[y,$]=r.useState(!0),[re,I]=r.useState(!0),[q,A]=r.useState(null),[i,u]=r.useState("all"),[d,v]=r.useState([]),[m,p]=r.useState([]),[S,ae]=r.useState("createdAt_desc"),{currentUser:b}=le(),{favorites:w}=xe(),[f,Y]=ne(),M=r.useRef(null),E=parseInt(f.get("page")||"1",10),n=r.useCallback(t=>{var a;const s=new URLSearchParams(f);t<=1?s.delete("page"):s.set("page",t.toString()),Y(s,{replace:!0}),(a=document.getElementById("filters-section"))==null||a.scrollIntoView({behavior:"smooth",block:"start"})},[f,Y]);r.useEffect(()=>{(async()=>{try{$(!0);const[s,a,o,g,x,h]=await Promise.all([c.from("categories").select("name").order("name"),c.from("movies").select("tags").eq("is_kurdish",!1),c.from("movies").select("year").eq("is_kurdish",!1),c.from("movies").select("*").eq("is_kurdish",!1).order("created_at",{ascending:!1}).limit(5),c.from("movies").select("*").eq("is_kurdish",!1).order("created_at",{ascending:!1}).limit(15),c.from("movies").select("*").eq("is_kurdish",!1).order("imdb_rating",{ascending:!1,nulls:"last"}).limit(15)]);if(s.error)throw new Error(`Categories Error: ${s.error.message}`);if(X(s.data.map(l=>l.name)),a.error)throw new Error(`Tags Error: ${a.error.message}`);if(ee([...new Set(a.data.flatMap(l=>l.tags||[]))].sort()),o.error)throw new Error(`Years Error: ${o.error.message}`);if(se([...new Set(o.data.map(l=>l.year))].sort((l,R)=>Number(R)-Number(l))),g.error)throw new Error(`Hero Movies Error: ${g.error.message}`);if(O(g.data),x.error)throw new Error(`Recent Movies Error: ${x.error.message}`);if(B(x.data),h.error)throw new Error(`Rated Movies Error: ${h.error.message}`);J(h.data)}catch(s){console.error("Error fetching initial data: ",s.message),A("فشل تحميل البيانات الأولية. قد تكون هناك مشكلة في الاتصال بقاعدة البيانات أو سياسات RLS.")}finally{$(!1)}})()},[]),r.useEffect(()=>{(async()=>{if(!b||w.length===0){_([]);return}const{data:s,error:a}=await c.from("movies").select("*").in("id",w).limit(15);a?console.error("Error fetching favorite movies:",a):_(s)})()},[w,b]),r.useEffect(()=>{y||(async()=>{I(!0);const s=(E-1)*j,a=s+j-1;let o=c.from("movies").select("*",{count:"exact"}).eq("is_kurdish",!1);i!=="all"&&(o=o.eq("year",i)),d.length>0&&(o=o.contains("genres",d)),m.length>0&&(o=o.contains("tags",m));const[g,x]=S.split("_");o=o.order(g==="createdAt"?"created_at":g,{ascending:x==="asc"}),o=o.range(s,a);const{data:h,error:l,count:R}=await o;l?(console.error("Error fetching paginated movies: ",l.message),A("فشل تحميل الأفلام. يرجى المحاولة مرة أخرى.")):(K(h),Q(R||0)),I(!1)})()},[E,i,d,m,S,y]),r.useEffect(()=>{var s;const t=f.get("genre");t&&t!==M.current&&(u("all"),p([]),v([t]),M.current=t,(s=document.getElementById("filters-section"))==null||s.scrollIntoView({behavior:"smooth",block:"start"}))},[f]);const H=t=>{n(1),v(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},L=t=>{n(1),p(s=>s.includes(t)?s.filter(a=>a!==t):[...s,t])},oe=()=>{n(1),u("all"),v([]),p([]),M.current=null},N=i!=="all"||d.length>0||m.length>0,D=Math.ceil(G/j);return y?e.jsxs("div",{children:[e.jsx(ie,{}),e.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),b&&e.jsx(P,{title:"المفضلة"}),e.jsx(P,{title:"أحدث الإضافات"}),e.jsx(P,{title:"الأعلى تقييماً"}),e.jsxs("section",{className:"mb-12",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:"تصفح الكل"}),e.jsx(U,{count:18})]})]}):q&&C.length===0?e.jsxs("div",{className:"text-center p-8 bg-red-900/20 border border-red-500/50 rounded-lg mt-8 animate-fade-in",children:[e.jsx("h2",{className:"text-2xl text-red-400 mb-4",children:"حدث خطأ في الاتصال بقاعدة البيانات"}),e.jsx("p",{className:"text-slate-300 whitespace-pre-line",children:q}),e.jsx("p",{className:"text-slate-400 mt-4",children:"This usually means the database tables are not set up correctly or Row Level Security (RLS) is preventing access. Please check your Supabase dashboard to ensure the 'movies' and 'categories' tables are readable by anonymous users."})]}):e.jsxs("div",{className:"animate-fade-in",children:[e.jsx(ce,{movies:C}),e.jsx("div",{id:"filters-section",className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl scroll-mt-20",children:e.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[e.jsx(de,{sortOrder:S,onSortChange:t=>{n(1),ae(t)}}),e.jsx(me,{genres:W,selectedGenres:d,onToggleGenre:H,onClearGenres:()=>{n(1),v([])}}),e.jsx(ge,{tags:Z,selectedTags:m,onToggleTag:L,onClearTags:()=>{n(1),p([])}}),e.jsx(fe,{years:te,selectedYear:i,onYearChange:t=>{n(1),u(t)}})]})}),N&&e.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-gray-800/50 p-3 animate-fade-in-down",children:[e.jsx("span",{className:"font-bold text-gray-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[i!=="all"&&e.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",i,e.jsx("button",{onClick:()=>{n(1),u("all")},className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${i}`,children:"×"})]}),d.map(t=>e.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[t,e.jsx("button",{onClick:()=>H(t),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${t}`,children:"×"})]},t)),m.map(t=>e.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",t,e.jsx("button",{onClick:()=>L(t),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${t}`,children:"×"})]},t))]}),e.jsx("button",{onClick:oe,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),!N&&e.jsxs(e.Fragment,{children:[b&&T.length>0&&e.jsx(k,{title:"المفضلة",movies:T}),e.jsx(k,{title:"أحدث الإضافات",movies:V}),e.jsx(k,{title:"الأعلى تقييماً",movies:z})]}),e.jsxs("section",{className:"mb-12",children:[e.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:N?`نتائج (${G})`:"تصفح الكل"}),re?e.jsx(U,{count:j}):F.length>0?e.jsxs(e.Fragment,{children:[e.jsx(he,{movies:F}),D>1&&e.jsx(ue,{currentPage:E,totalPages:D,onPageChange:n})]}):e.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:e.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام تطابق معايير البحث."})})]})]})};export{Re as default};
