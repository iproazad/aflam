import{r,a as Q,s as p,j as a}from"./index-DbzJ5413.js";import{S as V,G as X,T as ee,Y as te}from"./TagFilter-B-0vOiRH.js";import{M as ae}from"./MovieGridSkeleton-oTutThMd.js";import{P as se}from"./Pagination-apUufEkX.js";import{S as re}from"./SeriesGrid-Db60iw9D.js";import{a as ne,R as le}from"./ResumeFromModal-B_ZuMVmk.js";import"./MovieCardSkeleton-Bd2sLGc_.js";import"./SpinnerIcon-CdEoE9NS.js";const _=30,N="cached_series",ce=900*1e3,oe=async()=>{let l=[],d=0;const g=1e3;for(;;){const{data:c,error:m}=await p.from("series").select("*").order("created_at",{ascending:!1}).range(d,d+g-1);if(m)throw console.error("Error fetching series batch:",m),m;if(c&&c.length>0){if(l=l.concat(c),c.length<g)break;d+=c.length}else break}return l},pe=()=>{const[l,d]=r.useState([]),[g,c]=r.useState([]),[m,T]=r.useState(!0),[n,S]=r.useState("all"),[o,b]=r.useState([]),[i,y]=r.useState([]),[h,L]=r.useState("createdAt_desc"),[j,E]=Q(),A=r.useRef(!0),{addWatchLaterSeries:F,removeWatchLaterSeries:M,isWatchLaterSeries:D,getWatchLaterInfo:P,loading:W}=ne(),[f,w]=r.useState(null),x=parseInt(j.get("page")||"1",10),R=r.useCallback(e=>{const t=new URLSearchParams(j);e<=1?t.delete("page"):t.set("page",e.toString()),E(t,{replace:!0}),window.scrollTo(0,0)},[j,E]);r.useEffect(()=>{(async()=>{try{const t=localStorage.getItem(N);if(t){const{data:s,timestamp:u}=JSON.parse(t);if(new Date().getTime()-u<ce){d(s),T(!1);return}}}catch(t){console.error("Error reading from series cache",t),localStorage.removeItem(N)}try{const t=await oe();d(t);try{const s={data:t,timestamp:new Date().getTime()};localStorage.setItem(N,JSON.stringify(s))}catch(s){console.error("Error writing to series cache",s)}}catch(t){console.error("Error fetching series: ",t)}finally{T(!1)}})()},[]),r.useEffect(()=>{const e=async()=>{const{data:s,error:u}=await p.from("categories").select("name").order("name");u?console.error("Error fetching categories: ",u):c(s.map(q=>q.name))};e();const t=p.channel("public:categories:series").on("postgres_changes",{event:"*",schema:"public",table:"categories"},e).subscribe();return()=>{p.removeChannel(t)}},[]);const k=e=>b(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),Y=()=>b([]),G=e=>y(t=>t.includes(e)?t.filter(s=>s!==e):[...t,e]),O=()=>y([]),H=()=>{S("all"),b([]),y([])},$=e=>{D(e.id)?M(e.id):w(e)},J=(e,t)=>{f&&F(f.id,e,t),w(null)},U=[...new Set(l.map(e=>e.year))].sort((e,t)=>t-e),z=g,B=[...new Set(l.flatMap(e=>e.tags||[]))].sort(),C=r.useMemo(()=>l.filter(e=>n==="all"||e.year.toString()===n).filter(e=>o.length===0||o.some(t=>{var s;return(s=e.genres)==null?void 0:s.includes(t)})).filter(e=>i.length===0||i.some(t=>{var s;return(s=e.tags)==null?void 0:s.includes(t)})).sort((e,t)=>{switch(h){case"rating_desc":return(t.imdb_rating??0)-(e.imdb_rating??0);case"rating_asc":return(e.imdb_rating??0)-(t.imdb_rating??0);case"year_desc":return t.year-e.year;case"year_asc":return e.year-t.year;case"createdAt_asc":return Date.parse(e.created_at)-Date.parse(t.created_at);case"createdAt_desc":default:return Date.parse(t.created_at)-Date.parse(e.created_at)}}),[l,n,o,i,h]);r.useEffect(()=>{if(A.current){A.current=!1;return}x!==1&&R(1)},[n,o,i,h]);const I=Math.ceil(C.length/_),v=C.slice((x-1)*_,x*_),K=n!=="all"||o.length>0||i.length>0,Z=r.useMemo(()=>new Map(v.map(e=>{const t=P(e.id);return[e.id,t?{season:t.season,episode:t.episode}:null]})),[v,P]);return m?a.jsxs("div",{className:"animate-fade-in",children:[a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"my-8 h-20 bg-slate-800/50 rounded-lg animate-pulse"}),a.jsx(ae,{count:18})]}):a.jsxs("div",{className:"animate-fade-in",children:[a.jsx(le,{isOpen:!!f,onClose:()=>w(null),series:f,onSave:J,isSaving:W}),a.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),a.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:a.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[a.jsx(V,{sortOrder:h,onSortChange:L}),a.jsx(X,{genres:z,selectedGenres:o,onToggleGenre:k,onClearGenres:Y}),a.jsx(ee,{tags:B,selectedTags:i,onToggleTag:G,onClearTags:O}),a.jsx(te,{years:U,selectedYear:n,onYearChange:S})]})}),K&&a.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[a.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),a.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[n!=="all"&&a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",n,a.jsx("button",{onClick:()=>S("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${n}`,children:"×"})]}),o.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,a.jsx("button",{onClick:()=>k(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),i.map(e=>a.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,a.jsx("button",{onClick:()=>G(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),a.jsx("button",{onClick:H,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),a.jsx("section",{className:"mb-12",children:C.length>0?a.jsxs(a.Fragment,{children:[a.jsx(re,{series:v,onToggleWatchLater:$,watchLaterInfoMap:Z}),I>1&&a.jsx(se,{currentPage:x,totalPages:I,onPageChange:R})]}):a.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:a.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{pe as default};
