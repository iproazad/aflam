import{r as x,u as W,a as X,b as Z,d as F,j as t}from"./index-COHSSNss.js";import{H as ee,a as te,S as se,G as ae,T as re,Y as le}from"./TagFilter-BqO5ZAg2.js";import{M,a as A}from"./MoviesCarouselSkeleton-V5eS1rLO.js";import{u as ne}from"./MovieCardSkeleton-D7JhNSqL.js";import{M as oe}from"./MovieGrid-B5uZhT3G.js";import{M as ie}from"./MovieGridSkeleton-5cat1ZpX.js";import{P as ce}from"./Pagination-4153t60u.js";import"./MovieCard-C6_WItKi.js";const N=30,ve=()=>{const[i,_]=x.useState([]),[k,Y]=x.useState([]),[B,H]=x.useState(!0),{currentUser:w}=W(),{favorites:L}=ne(),{getAverageRating:d}=X(),[m,p]=Z(),v=parseInt(m.get("page")||"1",10),c=m.get("year")||"all",n=m.getAll("genre"),o=m.getAll("tag"),j=m.get("sort")||"createdAt_desc";x.useEffect(()=>{(async()=>{try{const r=(await F.collection("movies").get()).docs.map(l=>({id:l.id,...l.data()})).filter(l=>l.isKurdish!==!0);r.sort((l,h)=>{var E,R;const u=(E=l.createdAt)!=null&&E.toMillis?l.createdAt.toMillis():0;return((R=h.createdAt)!=null&&R.toMillis?h.createdAt.toMillis():0)-u}),_(r)}catch(s){console.error("Error fetching movies: ",s)}finally{H(!1)}})()},[]),x.useEffect(()=>{const e=F.collection("categories").orderBy("name").onSnapshot(s=>{const a=s.docs.map(r=>r.data().name);Y(a)},s=>{console.error("Error fetching categories: ",s)});return()=>e()},[]);const g=e=>{const s=new URLSearchParams(m);Object.entries(e).forEach(([a,r])=>{s.delete(a),Array.isArray(r)?r.forEach(l=>s.append(a,l)):r&&r!=="all"&&s.set(a,r)}),s.delete("page"),p(s,{replace:!0})},U=e=>{const s=new URLSearchParams(m);s.set("page",e.toString()),p(s,{replace:!0}),window.scrollTo({top:0,behavior:"smooth"})},S=e=>{const s=n.includes(e)?n.filter(a=>a!==e):[...n,e];g({genre:s})},O=()=>g({genre:[]}),C=e=>{const s=o.includes(e)?o.filter(a=>a!==e):[...o,e];g({tag:s})},$=()=>g({tag:[]}),P=e=>g({year:e}),I=e=>g({sort:e}),K=()=>{p(new URLSearchParams,{replace:!0})},T=i.filter(e=>L.includes(e.id)),z=i.slice(0,15),D=[...i].sort((e,s)=>d(s.id).average-d(e.id).average).slice(0,15),V=[...new Set(i.map(e=>e.year))].sort((e,s)=>Number(s)-Number(e)),q=k,J=[...new Set(i.flatMap(e=>e.tags||[]))].sort(),b=x.useMemo(()=>i.filter(e=>c==="all"||e.year.toString()===c).filter(e=>n.length===0?!0:n.some(s=>{var a;return(a=e.genres)==null?void 0:a.includes(s)})).filter(e=>o.length===0?!0:o.some(s=>{var a;return(a=e.tags)==null?void 0:a.includes(s)})).sort((e,s)=>{var a,r,l,h;switch(j){case"rating_desc":return d(s.id).average-d(e.id).average;case"rating_asc":return d(e.id).average-d(s.id).average;case"year_desc":return Number(s.year)-Number(e.year);case"year_asc":return Number(e.year)-Number(s.year);case"createdAt_asc":{const u=(a=e.createdAt)!=null&&a.toMillis?e.createdAt.toMillis():0,f=(r=s.createdAt)!=null&&r.toMillis?s.createdAt.toMillis():0;return u-f}case"createdAt_desc":default:{const u=(l=s.createdAt)!=null&&l.toMillis?s.createdAt.toMillis():0,f=(h=e.createdAt)!=null&&h.toMillis?e.createdAt.toMillis():0;return u-f}}}),[i,c,n,o,j,d]),G=Math.ceil(b.length/N),Q=b.slice((v-1)*N,v*N),y=c!=="all"||n.length>0||o.length>0;return B?t.jsxs("div",{children:[t.jsx(ee,{}),t.jsx("div",{className:"my-8 h-20 bg-gray-800/50 rounded-lg animate-pulse"}),w&&t.jsx(M,{title:"المفضلة"}),t.jsx(M,{title:"أحدث الإضافات"}),t.jsx(M,{title:"الأعلى تقييماً"}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:"تصفح الكل"}),t.jsx(ie,{count:18})]})]}):t.jsxs("div",{children:[t.jsx(te,{movies:i.slice(0,5)}),t.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:t.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[t.jsx(se,{sortOrder:j,onSortChange:I}),t.jsx(ae,{genres:q,selectedGenres:n,onToggleGenre:S,onClearGenres:O}),t.jsx(re,{tags:J,selectedTags:o,onToggleTag:C,onClearTags:$}),t.jsx(le,{years:V,selectedYear:c,onYearChange:P})]})}),y&&t.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-gray-800/50 p-3 animate-fade-in-down",children:[t.jsx("span",{className:"font-bold text-gray-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[c!=="all"&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",c,t.jsx("button",{onClick:()=>P("all"),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${c}`,children:"×"})]}),n.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,t.jsx("button",{onClick:()=>S(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),o.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,t.jsx("button",{onClick:()=>C(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),t.jsx("button",{onClick:K,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),!y&&t.jsxs(t.Fragment,{children:[w&&T.length>0&&t.jsx(A,{title:"المفضلة",movies:T}),t.jsx(A,{title:"أحدث الإضافات",movies:z}),t.jsx(A,{title:"الأعلى تقييماً",movies:D})]}),t.jsxs("section",{className:"mb-12",children:[t.jsx("h2",{className:"text-xl sm:text-2xl font-bold text-white mb-6 border-r-4 border-cyan-400 pr-4",children:y?"نتائج البحث":"تصفح الكل"}),b.length>0?t.jsxs(t.Fragment,{children:[t.jsx(oe,{movies:Q}),G>1&&t.jsx("div",{className:"mt-8",children:t.jsx(ce,{currentPage:v,totalPages:G,onPageChange:U})})]}):t.jsx("div",{className:"text-center p-8 bg-gray-800 rounded-lg mt-8",children:t.jsx("p",{className:"text-xl text-gray-400",children:"لا توجد أفلام تطابق معايير البحث."})})]})]})};export{ve as default};
