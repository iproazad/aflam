import{r as o,j as e,s as S,f as mt,R as bt}from"./index-Cf0rkJzd.js";import{P as rt}from"./Pagination-DxBbqbIs.js";import{F as _e,S as Se}from"./SpinnerIcon-Dp6sy_ha.js";const ut=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),yt=({onSubmit:c,initialData:a,onCancel:p,isKurdishByDefault:h=!1,isLoading:w=!1,allGenres:i=[]})=>{var se,X,Q;const[l,x]=o.useState({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],servers:[{name:"Server 1",url:"https://vidtube.pro/embed-1y2lihgthstv.html",quality:"1080p"}],backup_servers:[],download_url:"",trailer_url:"",is_kurdish:!1,imdb_rating:void 0,quality:"",duration:"",language:"",country:"",directors:[],writers:[],cast:[]}),[k,P]=o.useState(""),[G,D]=o.useState(""),[K,g]=o.useState(!1),[M,_]=o.useState(""),[O,q]=o.useState(!1),[B,E]=o.useState(""),[$,W]=o.useState(""),[U,y]=o.useState(!1),R=o.useRef(null);o.useEffect(()=>{a?(x({title:a.title||"",description:a.description||"",poster_url:a.poster_url||"",backdrop_url:a.backdrop_url||"",year:a.year||new Date().getFullYear(),genres:a.genres||[],tags:a.tags||[],servers:a.servers&&a.servers.length>0?a.servers:[{name:"Server 1",url:"",quality:"1080p"}],backup_servers:a.backup_servers||[],download_url:a.download_url||"",trailer_url:a.trailer_url||"",is_kurdish:a.is_kurdish||!1,imdb_rating:a.imdb_rating,quality:a.quality||"",duration:a.duration||"",language:a.language||"",country:a.country||"",directors:a.directors||[],writers:a.writers||[],cast:a.cast||[]}),P((a.tags||[]).join(", "))):(x({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],servers:[{name:"Server 1",url:"https://vidtube.pro/embed-1y2lihgthstv.html",quality:"1080p"}],backup_servers:[],download_url:"",trailer_url:"",is_kurdish:h,imdb_rating:void 0,quality:"",duration:"",language:"",country:"",directors:[],writers:[],cast:[]}),P(""))},[a,h]),o.useEffect(()=>{const t=r=>{R.current&&!R.current.contains(r.target)&&q(!1)};return document.addEventListener("mousedown",t),()=>{document.removeEventListener("mousedown",t)}},[]),o.useEffect(()=>{const t=l.download_url;if(t&&t.includes("vidtube.pro/d/")){const r=t.replace("/d/","/embed-");l.servers.length>0&&l.servers[0].url!==r&&x(n=>{const b=[...n.servers];return b[0]={...b[0],url:r},{...n,servers:b}})}},[l.download_url,l.servers]),o.useEffect(()=>{if(!a){const t=l.title.match(/\b(19[89]\d|20\d{2})\b/);if(t&&t[0]){const r=parseInt(t[0],10),n=l.title.replace(t[0],"").replace(/\s\s+/g," ").trim();x(b=>b.year!==r||b.title!==n?{...b,year:r,title:n}:b)}}},[l.title,a]),o.useEffect(()=>{!a&&!l.backdrop_url.trim()&&x(t=>({...t,backdrop_url:t.poster_url}))},[l.poster_url,a,l.backdrop_url]);const m=async t=>{var r;try{if(!((r=navigator.clipboard)!=null&&r.readText))throw new Error("Clipboard API not available.");const n=await navigator.clipboard.readText();n&&t(n)}catch(n){console.error("Failed to read clipboard contents: ",n),alert("فشل لصق النص. يرجى التأكد من منح الإذن لاستخدام الحافظة.")}},d=t=>{const{name:r,value:n,type:b}=t.target;if(b==="checkbox"){const{checked:s}=t.target;x(f=>({...f,[r]:s}))}else if(r==="year"){const s=parseInt(n,10);x(f=>({...f,[r]:isNaN(s)?0:s}))}else if(r==="imdb_rating"){const s=parseFloat(n);x(f=>({...f,imdb_rating:isNaN(s)?void 0:s}))}else x(s=>({...s,[r]:n}))},u=t=>{P(t.target.value)},C=t=>{x(r=>{const n=r.genres||[],b=n.includes(t)?n.filter(s=>s!==t):[...n,t];return{...r,genres:b}})},j=async()=>{const t=$.trim();if(t){if(i.some(r=>r.toLowerCase()===t.toLowerCase())){alert("هذه الفئة موجودة بالفعل.");return}y(!0);try{const{error:r}=await S.from("categories").insert({name:t});if(r)throw r;x(n=>({...n,genres:[...n.genres||[],t]})),W("")}catch(r){console.error("Error adding new genre:",r),alert("حدث خطأ أثناء إضافة الفئة الجديدة.")}finally{y(!1)}}},L=(t,r,n)=>{const b=[...l.servers];b[t]={...b[t],[r]:n},x(s=>({...s,servers:b}))},ee=()=>{x(t=>{const r={name:`Server ${t.servers.length+1}`,url:"",quality:"1080p"};return{...t,servers:[...t.servers,r]}})},re=t=>{x(r=>({...r,servers:r.servers.filter((n,b)=>b!==t)}))},he=(t,r,n)=>{const b=[...l.backup_servers||[]];b[t]={...b[t],[r]:n},x(s=>({...s,backup_servers:b}))},ie=()=>{x(t=>{var r;return{...t,backup_servers:[...t.backup_servers||[],{name:`Server ${(((r=t.backup_servers)==null?void 0:r.length)||0)+1}`,url:"",quality:"1080p",no_sub_url:""}]}})},v=t=>{x(r=>({...r,backup_servers:(r.backup_servers||[]).filter((n,b)=>b!==t)}))},A=async()=>{var t,r,n,b,s,f,N,I,ce,de,ye,we,xe,ve,nt,lt,ot,it,ct;if(!G){_("Please enter a URL.");return}g(!0),_("");try{_("Fetching movie page...");const Ae=`https://corsproxy.io/?${encodeURIComponent(G)}`,Ge=await fetch(Ae);if(!Ge.ok)throw new Error(`Failed to fetch URL: ${Ge.statusText}`);const gt=await Ge.text(),dt=new DOMParser,Z=dt.parseFromString(gt,"text/html");if(G.includes("a.asd.homes")){_("جلب البيانات من عرب سيد...");const ae=z=>{var H,Ce;const V=Array.from(Z.querySelectorAll(".info__area__ul > li")).find(ue=>{var me,Qe;return(Qe=(me=ue.querySelector(".title__kit span"))==null?void 0:me.textContent)==null?void 0:Qe.trim().startsWith(z)});if(!V)return[];const le=Array.from(V.querySelectorAll("ul.tags__list a"));if(le.length>0)return le.map(ue=>{var me;return((me=ue.textContent)==null?void 0:me.trim())||""}).filter(Boolean);const oe=Array.from(V.childNodes).find(ue=>{var me;return ue.nodeType===Node.TEXT_NODE&&((me=ue.textContent)==null?void 0:me.trim())});if(oe)return[((H=oe.textContent)==null?void 0:H.trim())||""];const F=V.querySelector("a");return F?[((Ce=F.textContent)==null?void 0:Ce.trim())||""]:[]},ke=((r=(t=Z.querySelector("h1.post__name"))==null?void 0:t.textContent)==null?void 0:r.trim())||"",pe=ke.match(/\(\s*(\d{4})\s*\)/),Ie=pe?parseInt(pe[1],10):new Date().getFullYear(),ge=pe?ke.replace(pe[0],"").trim():ke,ze=((b=(n=Z.querySelector(".post__story p"))==null?void 0:n.textContent)==null?void 0:b.trim())||"",Ee=((s=Z.querySelector(".poster__single img"))==null?void 0:s.getAttribute("data-src"))||((f=Z.querySelector(".poster__single img"))==null?void 0:f.getAttribute("src"))||"",De=((I=(N=Z.querySelector(".rating__box .rate__txt"))==null?void 0:N.textContent)==null?void 0:I.trim().split("/")[0].trim())||"0",We=parseFloat(De)||void 0,Je=ae("نوع العرض"),Ye=ae("جودة العرض").join(", "),Ve=ae("مدة العرض").join(", "),He=ae("لغة العرض").join(", "),Ke=ae("بلد العرض").join(", "),Fe=[],Oe=[],Te=[];Z.querySelectorAll(".persons__list li a").forEach(z=>{var le,oe,F,H;const ne=(oe=(le=z.querySelector(".name"))==null?void 0:le.textContent)==null?void 0:oe.trim(),V=(H=(F=z.querySelector(".role"))==null?void 0:F.textContent)==null?void 0:H.trim();ne&&V&&(V.includes("مخرج")?Fe.push(ne):V.includes("كاتب")?Oe.push(ne):Te.push(ne))});const Pe=((ce=Z.querySelector(".show__trailer"))==null?void 0:ce.getAttribute("data-iframe"))||"",$e=async z=>{var ne;if(!z)return"";try{_("Fetching watch page...");const V=await fetch(`https://corsproxy.io/?${encodeURIComponent(z)}`);if(!V.ok)throw new Error(`Failed to fetch watch page: ${V.statusText}`);const le=await V.text(),F=(ne=new DOMParser().parseFromString(le,"text/html").querySelector(".player__iframe iframe"))==null?void 0:ne.getAttribute("src");return F?F.startsWith("/")?`https://a.asd.homes${F}`:new URL(F,z).href:""}catch(V){return console.error("Error scraping watch page:",V),_("Warning: Could not automatically find watch server."),""}},Le=(z,ne,V)=>new Promise(async(le,oe)=>{if(!z)return le("");let F=null,H=null;const Ce=setTimeout(()=>{H==null||H.disconnect(),F==null||F.remove(),oe(new Error(`Scraping timed out for ${z}`))},15e3);try{const ue=await fetch(`https://corsproxy.io/?${encodeURIComponent(z)}`);if(!ue.ok)return oe(new Error(`Failed to fetch intermediate page: ${z}`));const me=await ue.text(),Xe=new DOMParser().parseFromString(me,"text/html").querySelector(ne);if(Xe&&Xe.getAttribute(V))return clearTimeout(Ce),le(Xe.getAttribute(V)||"");F=document.createElement("div"),F.style.display="none",document.body.appendChild(F),H=new MutationObserver(()=>{const Ze=F==null?void 0:F.querySelector(ne);if(Ze&&Ze.getAttribute(V)){const ft=Ze.getAttribute(V)||"";H==null||H.disconnect(),clearTimeout(Ce),F==null||F.remove(),le(ft)}}),H.observe(F,{childList:!0,subtree:!0}),F.innerHTML=me}catch(ue){clearTimeout(Ce),H==null||H.disconnect(),F==null||F.remove(),oe(ue)}});_("Fetching watch & download pages (this may take a moment)...");const fe=(de=Z.querySelector("a.watch__btn"))==null?void 0:de.getAttribute("href"),Me=(ye=Z.querySelector("a.download__btn"))==null?void 0:ye.getAttribute("href"),[je,qe]=await Promise.all([$e(fe),Le(Me,'a.downloadsLink, a[href*="vidtube.pro/d/"], .downloads__links__list a',"href").catch(z=>(console.warn("Could not scrape download URL:",z),_("Warning: Could not automatically find download link."),""))]);let Ne=[];je&&(_("Parsing watch servers..."),Ne.push({name:"Server 1",url:je,quality:"HD"})),x(z=>({...z,title:ge,year:Ie||z.year,description:ze,poster_url:Ee,backdrop_url:Ee,imdb_rating:We,genres:[...new Set([...z.genres,...Je])],quality:Ye,duration:Ve,language:He,country:Ke,directors:Fe,writers:Oe,cast:Te,trailer_url:Pe,servers:Ne.length>0?Ne:z.servers,download_url:qe||z.download_url})),_("تم جلب البيانات بنجاح!")}else if(G.includes("topcinema.cam")){const ae=fe=>{var ne,V,le;const je=Array.from(Z.querySelectorAll(".RightTaxContent > li")).find(oe=>{var F,H;return(H=(F=oe.querySelector("span"))==null?void 0:F.textContent)==null?void 0:H.trim().startsWith(fe)});if(!je)return[];const qe=Array.from(je.querySelectorAll("a, strong"));if(qe.length>0)return qe.map(oe=>{var F;return((F=oe.textContent)==null?void 0:F.trim())||""}).filter(Boolean);const Ne=je.cloneNode(!0);(ne=Ne.querySelector("i"))==null||ne.remove(),(V=Ne.querySelector("span"))==null||V.remove();const z=(le=Ne.textContent)==null?void 0:le.trim().replace(/^:/,"").trim();return z?z.split(/\s*,\s*/):[]},ke=((xe=(we=Z.querySelector("h1.post-title"))==null?void 0:we.textContent)==null?void 0:xe.trim())||"",pe=ke.match(/\b(19\d{2}|20\d{2})\b/),Ie=pe?parseInt(pe[0],10):new Date().getFullYear();let ge=ke;ge=ge.replace(/فيلم|مترجم|اون لاين|اونلاين|WEB-DL|BluRay|HD/gi,"").replace(/[\u0600-\u06FF]+/g,""),pe&&(ge=ge.replace(pe[0],"")),ge=ge.trim().replace(/^[^a-zA-Z0-9\s]+|[^a-zA-Z0-9\s]+$/g,"").trim();const ze=((nt=(ve=Z.querySelector(".story p"))==null?void 0:ve.textContent)==null?void 0:nt.trim())||"",Ee=((lt=Z.querySelector(".MainSingle .left .image img"))==null?void 0:lt.getAttribute("src"))||"",De=((it=(ot=Z.querySelector(".imdbR span"))==null?void 0:ot.textContent)==null?void 0:it.trim())||"0",We=parseFloat(De)||void 0,Je=ae("نوع الفيلم"),Ye=ae("جودة الفيلم").join(", "),Ve=ae("توقيت الفيلم").join(", "),He=ae("لغة الفيلم").join(", "),Ke=ae("دولة الفيلم").join(", "),Fe=ae("المخرجين"),Oe=ae("المؤلفين"),Te=ae("بطولة");let Pe="";const $e=Z.querySelector("a.download"),Le=$e==null?void 0:$e.getAttribute("href");if(Le){_("Fetching download link...");const fe=`https://corsproxy.io/?${encodeURIComponent(Le)}`,Me=await fetch(fe);if(Me.ok){const je=await Me.text();Pe=((ct=dt.parseFromString(je,"text/html").querySelector('a.downloadsLink, a[href*="vidtube.pro/d/"]'))==null?void 0:ct.getAttribute("href"))||""}}x(fe=>({...fe,title:ge,year:Ie||fe.year,description:ze,poster_url:Ee,backdrop_url:Ee,imdb_rating:We,genres:[...new Set([...fe.genres,...Je])],quality:Ye,duration:Ve,language:He,country:Ke,directors:Fe,writers:Oe,cast:Te,download_url:Pe})),_("تم جلب البيانات بنجاح!")}else{_("هذا الموقع غير مدعوم حاليًا للجلب."),g(!1);return}}catch(Ae){console.error("Scraping failed:",Ae),_(`فشل جلب البيانات: ${Ae.message}.`)}finally{g(!1)}},J=t=>{if(t.preventDefault(),l.genres.length===0){alert("الرجاء اختيار فئة واحدة على الأقل.");return}const r=k.split(",").map(n=>n.trim()).filter(Boolean);c({...l,tags:r})},te=i.filter(t=>t.toLowerCase().includes(B.toLowerCase())),Y="w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 focus:border-cyan-500 outline-none transition",T="bg-slate-600 text-white p-2 rounded-md border border-slate-500 focus:border-cyan-500 outline-none";return e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3 p-4 bg-slate-900/50 rounded-lg border border-slate-700",children:[e.jsx("label",{htmlFor:"scrape_url",className:"block text-lg font-semibold text-white",children:"جلب البيانات من رابط"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{id:"scrape_url",type:"url",value:G,onChange:t=>D(t.target.value),placeholder:"https://web6.topcinema.cam/... or https://a.asd.homes/...",className:`${Y} flex-grow`}),e.jsxs("button",{type:"button",onClick:A,disabled:K,className:"bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700 flex-shrink-0 flex items-center disabled:bg-slate-500",children:[K&&e.jsx(ut,{}),K?"جاري الجلب...":"جلب البيانات"]})]}),M&&e.jsx("p",{className:`text-sm mt-1 ${M.startsWith("فشل")||M.startsWith("هذا")?"text-red-400":"text-green-400"}`,children:M})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("div",{children:e.jsx("input",{type:"text",name:"title",value:l.title,onChange:d,placeholder:"عنوان الفيلم (بالانجليزية)",required:!0,className:Y})}),e.jsx("input",{type:"number",name:"year",value:l.year||"",onChange:d,placeholder:"سنة الإنتاج",required:!0,className:Y})]}),e.jsx("textarea",{name:"description",value:l.description,onChange:d,placeholder:"وصف الفيلم",required:!0,className:`${Y} h-32`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",name:"poster_url",value:l.poster_url,onChange:d,placeholder:"رابط صورة البوستر",required:!0,className:`${Y} flex-grow`}),e.jsx("button",{type:"button",onClick:()=>m(t=>x(r=>({...r,poster_url:t,backdrop_url:t}))),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-2 px-4 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsx("input",{type:"url",name:"backdrop_url",value:l.backdrop_url,onChange:d,placeholder:"رابط صورة الخلفية",required:!0,className:Y})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"number",name:"imdb_rating",value:l.imdb_rating??"",onChange:d,placeholder:"تقيم الفيلم",step:"0.1",min:"0",max:"10",className:Y}),e.jsx("input",{type:"url",name:"trailer_url",value:l.trailer_url??"",onChange:d,placeholder:"رابط المقطع الدعائي (اختياري)",className:Y})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"tags",className:"block text-lg font-semibold text-white mb-2",children:"الكلمات الدلالية (Tags)"}),e.jsx("input",{id:"tags",type:"text",name:"tags",value:k,onChange:u,placeholder:"أكشن, بطل خارق, إثارة (مفصولة بفاصلة)",className:Y})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{id:"is_kurdish",type:"checkbox",name:"is_kurdish",checked:!!l.is_kurdish,onChange:d,className:"h-5 w-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600 focus:ring-offset-slate-800 cursor-pointer"}),e.jsx("label",{htmlFor:"is_kurdish",className:"text-white cursor-pointer",children:"هذا الفيلم مدبلج للكردية"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الفئات (اختر واحدة على الأقل)"}),e.jsxs("div",{className:"relative",ref:R,children:[e.jsxs("button",{type:"button",onClick:()=>q(t=>!t),className:`${Y} text-right flex justify-between items-center`,children:[e.jsx("span",{children:l.genres.length>0?l.genres.join(", "):"اختر الفئات..."}),e.jsx("svg",{className:`h-5 w-5 transition-transform duration-200 ${O?"rotate-180":""}`,xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 20 20",fill:"currentColor",children:e.jsx("path",{fillRule:"evenodd",d:"M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z",clipRule:"evenodd"})})]}),O&&e.jsxs("div",{className:"absolute z-10 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto",children:[e.jsx("div",{className:"p-2 border-b border-slate-700",children:e.jsx("input",{type:"text",placeholder:"ابحث أو أضف فئة...",value:B,onChange:t=>E(t.target.value),className:"w-full bg-slate-700 text-white p-2 rounded-md border-slate-600 outline-none"})}),e.jsx("ul",{className:"p-1",children:te.map(t=>e.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-700 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:l.genres.includes(t),onChange:()=>C(t),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("span",{className:"text-white",children:t})]},t))}),e.jsx("div",{className:"p-2 border-t border-slate-700",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"text",placeholder:"إضافة فئة جديدة...",value:$,onChange:t=>W(t.target.value),className:"flex-grow bg-slate-700 text-white p-2 rounded-md border-slate-600 outline-none"}),e.jsx("button",{type:"button",onClick:j,disabled:U||!$.trim(),className:"bg-cyan-600 text-white px-3 py-1 rounded-md text-sm hover:bg-cyan-700 disabled:bg-slate-500",children:U?"...":"إضافة"})]})})]})]})]}),e.jsxs("details",{className:"bg-slate-900/30 p-4 rounded-lg border border-slate-700",open:!0,children:[e.jsx("summary",{className:"text-lg font-semibold text-white cursor-pointer",children:"تفاصيل إضافية للفيلم"}),e.jsxs("div",{className:"mt-4 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 gap-4",children:[e.jsx("input",{type:"text",name:"quality",value:l.quality,onChange:d,placeholder:"الجودة (e.g. 1080p WEB-DL)",className:T}),e.jsx("input",{type:"text",name:"duration",value:l.duration,onChange:d,placeholder:"مدة العرض",className:T}),e.jsx("input",{type:"text",name:"language",value:l.language,onChange:d,placeholder:"اللغة",className:T}),e.jsx("input",{type:"text",name:"country",value:l.country,onChange:d,placeholder:"الدولة",className:T})]}),e.jsx("textarea",{value:(se=l.directors)==null?void 0:se.join(", "),onChange:t=>x(r=>({...r,directors:t.target.value.split(",").map(n=>n.trim())})),placeholder:"المخرجين (مفصولة بفاصلة)",className:`${T} w-full`,rows:2}),e.jsx("textarea",{value:(X=l.writers)==null?void 0:X.join(", "),onChange:t=>x(r=>({...r,writers:t.target.value.split(",").map(n=>n.trim())})),placeholder:"المؤلفين (مفصولة بفاصلة)",className:`${T} w-full`,rows:2}),e.jsx("textarea",{value:(Q=l.cast)==null?void 0:Q.join(", "),onChange:t=>x(r=>({...r,cast:t.target.value.split(",").map(n=>n.trim())})),placeholder:"البطولة (مفصولة بفاصلة)",className:`${T} w-full`,rows:3})]})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"سيرفرات المشاهدة"}),l.servers.map((t,r)=>e.jsxs("div",{className:"bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:t.name,onChange:n=>L(r,"name",n.target.value),placeholder:"اسم السيرفر",className:`${T} flex-1`}),e.jsxs("select",{value:t.quality,onChange:n=>L(r,"quality",n.target.value),className:`${T} w-28`,children:[e.jsx("option",{value:"1080p",children:"1080p"}),e.jsx("option",{value:"720p",children:"720p"}),e.jsx("option",{value:"480p",children:"480p"})]}),l.servers.length>1&&e.jsx("button",{type:"button",onClick:()=>re(r),className:"bg-red-600 text-white p-2 rounded-md hover:bg-red-700 text-xs",children:"X"})]}),r===0?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsx("input",{type:"url",value:t.url,onChange:n=>L(r,"url",n.target.value),placeholder:"رابط السيرفر 1",required:!0,className:`${T} w-full`}),e.jsx("input",{type:"url",name:"download_url",value:l.download_url||"",onChange:d,placeholder:"رابط تحميل الفيلم (اختياري)",className:`${T} w-full`})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"url",value:t.url,onChange:n=>L(r,"url",n.target.value),placeholder:`رابط السيرفر ${r+1}`,required:!0,className:`${T} w-full flex-grow`}),e.jsx("button",{type:"button",onClick:()=>m(n=>L(r,"url",n)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]})]},r)),e.jsx("button",{type:"button",onClick:ee,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500",children:"إضافة سيرفر"})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"سيرفرات احتياطية (مشغل خارجي)"}),(l.backup_servers||[]).map((t,r)=>e.jsxs("div",{className:"bg-slate-900/50 p-3 rounded-lg border border-slate-700 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"text",value:t.name,onChange:n=>he(r,"name",n.target.value),placeholder:"اسم السيرفر",className:`${T} flex-1`}),e.jsxs("select",{value:t.quality,onChange:n=>he(r,"quality",n.target.value),className:`${T} w-28`,children:[e.jsx("option",{value:"1080p",children:"1080p"}),e.jsx("option",{value:"720p",children:"720p"}),e.jsx("option",{value:"480p",children:"480p"})]}),e.jsx("button",{type:"button",onClick:()=>v(r),className:"bg-red-600 text-white p-2 rounded-md hover:bg-red-700 text-xs",children:"X"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2",children:[e.jsx("input",{type:"url",value:t.url,onChange:n=>he(r,"url",n.target.value),placeholder:"رابط السيرفر (مع ترجمة)",className:`${T} w-full`}),e.jsx("input",{type:"url",value:t.no_sub_url||"",onChange:n=>he(r,"no_sub_url",n.target.value),placeholder:"رابط السيرفر (بدون ترجمة)",className:`${T} w-full`})]})]},r)),e.jsx("button",{type:"button",onClick:ie,className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500",children:"إضافة سيرفر احتياطي"})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-slate-700",children:[e.jsx("button",{type:"button",onClick:p,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors disabled:opacity-50",disabled:w,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",disabled:w,children:[w&&e.jsx(ut,{}),w?a?"جاري التحديث...":"جاري الإضافة...":a?"تحديث الفيلم":"إضافة الفيلم"]})]})]})},wt=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),be=({isOpen:c,onClose:a,onConfirm:p,title:h,message:w,isLoading:i=!1})=>{const[l,x]=o.useState(c);return o.useEffect(()=>{if(c)x(!0);else{const k=setTimeout(()=>x(!1),300);return()=>clearTimeout(k)}},[c]),l?e.jsx("div",{className:`fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50 p-4 ${c?"animate-fade-in":"animate-fade-out"}`,onClick:a,"aria-modal":"true",role:"dialog",children:e.jsxs("div",{className:`relative bg-slate-800 p-6 rounded-lg shadow-xl w-full max-w-md border border-slate-700 ${c?"animate-zoom-in":"animate-zoom-out"}`,onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"sm:flex sm:items-start",children:[e.jsx("div",{className:"mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-500/20 sm:mx-0 sm:h-10 sm:w-10",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6 text-red-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"})})}),e.jsxs("div",{className:"mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right flex-grow",children:[e.jsx("h3",{className:"text-lg leading-6 font-bold text-white",id:"modal-title",children:h}),e.jsx("div",{className:"mt-2",children:e.jsx("p",{className:"text-sm text-slate-300",children:w})})]})]}),e.jsxs("div",{className:"mt-5 sm:mt-4 sm:flex sm:flex-row-reverse sm:justify-start gap-3",children:[e.jsxs("button",{type:"button",className:"w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 focus:ring-offset-slate-800 sm:w-auto sm:text-sm disabled:bg-red-800 disabled:cursor-not-allowed",onClick:p,disabled:i,children:[i&&e.jsx(wt,{}),i?"جاري الحذف...":"حذف"]}),e.jsx("button",{type:"button",className:"mt-3 w-full inline-flex justify-center rounded-md border border-slate-600 shadow-sm px-4 py-2 bg-slate-700 text-base font-medium text-white hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 focus:ring-offset-slate-800 sm:mt-0 sm:w-auto sm:text-sm disabled:opacity-50",onClick:a,disabled:i,children:"إلغاء"})]})]})}):null},jt=10,ht=()=>e.jsxs("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden mt-8 animate-pulse",children:[e.jsxs("div",{className:"p-4 flex justify-between items-center",children:[e.jsx("div",{className:"h-10 bg-gray-700 rounded w-40"}),e.jsx("div",{className:"h-8 bg-gray-700 rounded w-64"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsx("tr",{children:[...Array(9)].map((c,a)=>e.jsx("th",{className:"px-4 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})},a))})}),e.jsx("tbody",{children:[...Array(jt)].map((c,a)=>e.jsxs("tr",{className:"border-b border-gray-700",children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-6 w-6 bg-gray-600 rounded"})}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-20 w-14 bg-gray-600 rounded"})}),[...Array(7)].map((p,h)=>e.jsx("td",{className:"px-4 py-2",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})},h))]},a))})]})})]}),at=({message:c,type:a,onClose:p})=>(o.useEffect(()=>{const i=setTimeout(p,5e3);return()=>clearTimeout(i)},[p]),e.jsx("div",{className:`fixed top-24 right-5 z-[100] p-4 rounded-lg shadow-lg text-white border-l-4 animate-fade-in-down ${a==="success"?"bg-green-600 border-green-500":"bg-red-600 border-red-500"}`,role:"alert",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"font-bold",children:c}),e.jsx("button",{onClick:p,className:"absolute top-1 right-2 text-2xl font-bold leading-none",children:"×"})]})})),xt=({genres:c,onSubmit:a,onClose:p,isLoading:h})=>{const[w,i]=o.useState(c[0]||""),[l,x]=o.useState("add"),k=P=>{P.preventDefault(),w&&a(w,l)};return e.jsx(_e,{title:"تغيير الفئة بشكل جماعي",onClose:p,isOpen:!0,children:e.jsxs("form",{onSubmit:k,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"اختر فئة لإضافتها أو إزالتها من الأفلام المحددة."}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("select",{value:w,onChange:P=>i(P.target.value),className:"flex-grow bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:c.map(P=>e.jsx("option",{value:P,children:P},P))}),e.jsxs("select",{value:l,onChange:P=>x(P.target.value),className:"bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:[e.jsx("option",{value:"add",children:"إضافة"}),e.jsx("option",{value:"remove",children:"إزالة"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:p,disabled:h,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:h||!w,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[h&&e.jsx(Se,{}),h?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},Nt=({onSubmit:c,onClose:a,isLoading:p})=>{const[h,w]=o.useState(new Date().getFullYear()),i=l=>{l.preventDefault(),c(h)};return e.jsx(_e,{title:"تغيير سنة الإنتاج بشكل جماعي",onClose:a,isOpen:!0,children:e.jsxs("form",{onSubmit:i,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"أدخل سنة الإنتاج الجديدة ليتم تطبيقها على جميع الأفلام المحددة."}),e.jsx("input",{type:"number",value:h,onChange:l=>w(parseInt(l.target.value)),required:!0,className:"w-full bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:a,disabled:p,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:p,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[p&&e.jsx(Se,{}),p?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},pt=({onSubmit:c,onClose:a,isLoading:p})=>{const[h,w]=o.useState(""),[i,l]=o.useState("add"),x=k=>{k.preventDefault(),h.trim()&&c(h.trim(),i)};return e.jsx(_e,{title:"تغيير الكلمات الدلالية بشكل جماعي",onClose:a,isOpen:!0,children:e.jsxs("form",{onSubmit:x,className:"space-y-4",children:[e.jsx("p",{className:"text-gray-300",children:"أدخل كلمة دلالية (Tag) لإضافتها أو إزالتها من الأفلام المحددة."}),e.jsxs("div",{className:"flex gap-4",children:[e.jsx("input",{type:"text",value:h,onChange:k=>w(k.target.value),placeholder:"الكلمة الدلالية, مثلاً: بطل خارق",required:!0,className:"flex-grow bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("select",{value:i,onChange:k=>l(k.target.value),className:"bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none",children:[e.jsx("option",{value:"add",children:"إضافة"}),e.jsx("option",{value:"remove",children:"إزالة"})]})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:a,disabled:p,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:p||!h.trim(),className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800",children:[p&&e.jsx(Se,{}),p?"جاري التنفيذ...":"تطبيق التغيير"]})]})]})})},Re=10,vt=()=>{const[c,a]=o.useState([]),[p,h]=o.useState(null),[w,i]=o.useState(!1),[l,x]=o.useState(1),[k,P]=o.useState("all"),[G,D]=o.useState(""),[K,g]=o.useState(!1),[M,_]=o.useState(null),[O,q]=o.useState(!0),[B,E]=o.useState(!1),[$,W]=o.useState(null),[U,y]=o.useState([]),[R,m]=o.useState(null),[d,u]=o.useState([]),C=async()=>{const{data:s,error:f}=await S.from("movies").select("*").order("created_at",{ascending:!1});f?(console.error("Error fetching movies: ",f),j("فشل في تحميل الأفلام.","error")):a(s);const{data:N,error:I}=await S.from("categories").select("name").order("name");I?console.error("Error fetching categories from ManageMovies: ",I):u(N.map(ce=>ce.name)),q(!1)};o.useEffect(()=>{q(!0),C();const s=S.channel("public:movies").on("postgres_changes",{event:"*",schema:"public",table:"movies"},()=>C()).subscribe();return()=>{S.removeChannel(s)}},[]),o.useEffect(()=>{x(1),y([])},[k,G]);const j=(s,f)=>{W({message:s,type:f})},L=async s=>{E(!0);try{const{error:f}=await S.from("movies").insert([{...s,created_at:new Date().toISOString()}]);if(f)throw f;await C(),i(!1),x(1),j("تمت إضافة الفيلم بنجاح.","success")}catch(f){console.error("Error adding movie: ",f);const N=f.message||JSON.stringify(f);j(`حدث خطأ أثناء إضافة الفيلم: ${N}`,"error")}finally{E(!1)}},ee=async(s,f)=>{E(!0);try{const{error:N}=await S.from("movies").update(f).eq("id",s);if(N)throw N;await C(),h(null),i(!1),j("تم تحديث الفيلم بنجاح.","success")}catch(N){console.error("Error updating movie: ",N);const I=N.message||JSON.stringify(N);j(`حدث خطأ أثناء تحديث الفيلم: ${I}`,"error")}finally{E(!1)}},re=s=>{_(s),g(!0)},he=async()=>{if(M){E(!0);try{const{error:s}=await S.from("movies").delete().eq("id",M.id);if(s)throw s;j("تم حذف الفيلم بنجاح.","success")}catch(s){console.error("Error deleting movie: ",s);const f=s.message||JSON.stringify(s);j(`حدث خطأ أثناء حذف الفيلم: ${f}`,"error")}finally{g(!1),_(null),E(!1)}}},ie=s=>{h(s),i(!0)},v=()=>{h(null),i(!0)},A=()=>{h(null),i(!1),m(null)},J=s=>{y(f=>f.includes(s)?f.filter(N=>N!==s):[...f,s])},te=s=>{s.target.checked?y(r.map(f=>f.id)):y(U.filter(f=>!r.some(N=>N.id===f)))},Y=async(s,f)=>{E(!0);try{const{error:N}=await S.from("movies").update(s).in("id",U);if(N)throw N;j(f,"success"),y([])}catch(N){console.error("Bulk update failed:",N),j("فشل التحديث الجماعي.","error")}finally{E(!1),m(null)}},T=async()=>{E(!0);try{const{error:s}=await S.from("movies").delete().in("id",U);if(s)throw s;j(`تم حذف ${U.length} فيلم بنجاح.`,"success"),y([])}catch(s){console.error("Bulk delete failed:",s),j("فشل الحذف الجماعي.","error")}finally{E(!1),m(null)}},se=async(s,f)=>{E(!0);try{const{data:N,error:I}=await S.from("movies").select("id, genres").in("id",U);if(I)throw I;const ce=N.map(ye=>{const we=ye.genres||[];let xe;return f==="add"?xe=[...new Set([...we,s])]:xe=we.filter(ve=>ve!==s),{id:ye.id,genres:xe}}),{error:de}=await S.from("movies").upsert(ce);if(de)throw de;j(`تم ${f==="add"?"إضافة":"إزالة"} فئة "${s}" بنجاح.`,"success"),y([])}catch(N){console.error("Bulk genre change failed:",N),j("فشل تغيير الفئة الجماعي.","error")}finally{E(!1),m(null)}},X=async(s,f)=>{E(!0);try{const{data:N,error:I}=await S.from("movies").select("id, tags").in("id",U);if(I)throw I;const ce=N.map(ye=>{const we=ye.tags||[];let xe;return f==="add"?xe=[...new Set([...we,s])]:xe=we.filter(ve=>ve!==s),{id:ye.id,tags:xe}}),{error:de}=await S.from("movies").upsert(ce);if(de)throw de;j(`تم ${f==="add"?"إضافة":"إزالة"} الكلمة الدلالية "${s}" بنجاح.`,"success"),y([])}catch(N){console.error("Bulk tags change failed:",N),j("فشل تغيير الكلمات الدلالية الجماعي.","error")}finally{E(!1),m(null)}},Q=c.filter(s=>k==="kurdish"?s.is_kurdish===!0:k==="non-kurdish"?!s.is_kurdish:!0).filter(s=>mt(G,s.title)),t=Math.ceil(Q.length/Re),r=Q.slice((l-1)*Re,l*Re),n=s=>`px-4 py-2 text-sm font-bold rounded-lg transition-colors duration-200 ${k===s?"bg-gradient-to-r from-cyan-500 to-blue-500 text-white shadow-md":"bg-slate-700 text-slate-200 hover:bg-slate-600"}`,b=r.length>0&&r.every(s=>U.includes(s.id));return O?e.jsx(ht,{}):e.jsxs("div",{className:"relative",children:[$&&e.jsx(at,{...$,onClose:()=>W(null)}),e.jsx(be,{isOpen:K,onClose:()=>g(!1),onConfirm:he,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الفيلم ",e.jsxs("strong",{className:"text-white",children:['"',M==null?void 0:M.title,'"']}),"؟ ",e.jsx("br",{})," ",e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:B}),R==="delete"&&e.jsx(be,{isOpen:!0,onClose:()=>m(null),onConfirm:T,title:`تأكيد حذف ${U.length} فيلم`,message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الأفلام المحددة؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:B}),R==="genre"&&e.jsx(xt,{genres:d,onClose:A,onSubmit:se,isLoading:B}),R==="tags"&&e.jsx(pt,{onClose:A,onSubmit:X,isLoading:B}),R==="year"&&e.jsx(Nt,{onClose:A,onSubmit:s=>Y({year:s},"تم تحديث السنة بنجاح."),isLoading:B}),R==="markKurdish"&&e.jsx(be,{isOpen:!0,onClose:A,onConfirm:()=>Y({is_kurdish:!0},"تم التحديث بنجاح."),title:"تأكيد",message:"هل تريد تحديد كل هذه الأفلام على أنها كردية؟",isLoading:B}),R==="unmarkKurdish"&&e.jsx(be,{isOpen:!0,onClose:A,onConfirm:()=>Y({is_kurdish:!1},"تم التحديث بنجاح."),title:"تأكيد",message:"هل تريد إزالة العلامة الكردية من كل هذه الأفلام؟",isLoading:B}),w&&e.jsx(_e,{title:p?"تعديل الفيلم":"إضافة فيلم جديد",onClose:A,isOpen:w,children:e.jsx(yt,{onSubmit:p?s=>ee(p.id,s):L,initialData:p,onCancel:A,isKurdishByDefault:k==="kurdish"&&!p,isLoading:B,allGenres:d})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center mb-6 gap-4 w-full",children:[e.jsx("button",{onClick:v,className:"bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2.5 px-5 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-lg w-full sm:w-auto flex-shrink-0",children:"إضافة فيلم جديد"}),e.jsxs("div",{className:"relative w-full sm:flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",value:G,onChange:s=>D(s.target.value),placeholder:"ابحث عن فيلم للتعديل...",className:"w-full bg-slate-700 text-white p-2.5 pl-10 rounded-lg focus:ring-2 focus:ring-cyan-500 border-none outline-none transition-colors","aria-label":"Search for a movie to edit"})]}),e.jsxs("div",{className:"flex flex-wrap justify-center items-center gap-2 p-1 bg-slate-900/50 rounded-lg flex-shrink-0",children:[e.jsx("button",{onClick:()=>P("all"),className:n("all"),children:"الكل"}),e.jsx("button",{onClick:()=>P("kurdish"),className:n("kurdish"),children:"كردي فقط"}),e.jsx("button",{onClick:()=>P("non-kurdish"),className:n("non-kurdish"),children:"غير كردي"})]})]}),U.length>0&&e.jsxs("div",{className:"bg-slate-900/80 backdrop-blur-sm border border-cyan-500 rounded-lg p-3 mb-4 flex flex-wrap items-center justify-between gap-3 animate-fade-in-down",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-white font-bold",children:[U.length," فيلم محدد"]}),e.jsx("button",{onClick:()=>y([]),className:"text-sm text-cyan-400 hover:underline",children:"إلغاء التحديد"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>m("genre"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الفئة"}),e.jsx("button",{onClick:()=>m("tags"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الكلمات"}),e.jsx("button",{onClick:()=>m("year"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير السنة"}),e.jsx("button",{onClick:()=>m("markKurdish"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تحديد ككردي"}),e.jsx("button",{onClick:()=>m("unmarkKurdish"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"إلغاء تحديد ككردي"}),e.jsx("button",{onClick:()=>m("delete"),className:"bg-red-600 text-sm py-1 px-3 rounded-md hover:bg-red-500",children:"حذف المحدد"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"overflow-x-auto hidden lg:block",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-900/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right",children:e.jsx("input",{type:"checkbox",onChange:te,checked:b,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الصورة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"العنوان"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تقييم IMDb"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"السنة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الفئات"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"مدبلج كردي"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تاريخ الإضافة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:r.map(s=>{var f,N;return e.jsxs("tr",{className:`${U.includes(s.id)?"bg-cyan-500/20":"hover:bg-slate-700/50"} transition-colors duration-200`,children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:U.includes(s.id),onChange:()=>J(s.id),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:e.jsx("img",{src:s.poster_url,alt:s.title,className:"h-20 w-auto rounded object-cover",loading:"lazy"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap font-medium text-white align-middle",children:s.title}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-yellow-400 font-bold align-middle",children:s.imdb_rating?s.imdb_rating.toFixed(1):"N/A"}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:s.year}),e.jsx("td",{className:"px-4 py-2 text-slate-300 align-middle",children:e.jsxs("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(f=s.genres)==null?void 0:f.slice(0,3).map(I=>e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:I},I)),((N=s.genres)==null?void 0:N.length)>3&&e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:"..."})]})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:s.is_kurdish?"نعم":"لا"}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:s.created_at?new Date(s.created_at).toLocaleDateString("ar-EG"):"غير متاح"}),e.jsxs("td",{className:"px-4 py-2 whitespace-nowrap font-medium align-middle",children:[e.jsx("button",{onClick:()=>ie(s),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>re(s),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},s.id)})})]})}),e.jsxs("div",{className:"block lg:hidden space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("input",{type:"checkbox",onChange:te,checked:b,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("label",{className:"text-sm text-slate-300",children:"تحديد الكل في هذه الصفحة"})]}),r.map(s=>{var f,N;return e.jsxs("div",{className:`p-3 rounded-lg transition-all duration-200 ${U.includes(s.id)?"bg-cyan-500/20 ring-2 ring-cyan-500":"bg-slate-900/50"}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-24",children:e.jsx("img",{src:s.poster_url,alt:s.title,className:"w-full rounded object-cover",loading:"lazy"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h3",{className:"font-bold text-white truncate flex-grow pr-2",children:s.title}),e.jsx("input",{type:"checkbox",checked:U.includes(s.id),onChange:()=>J(s.id),className:"h-5 w-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600 flex-shrink-0"})]}),e.jsxs("div",{className:"text-sm text-slate-400 mt-1 flex items-center gap-x-2 flex-wrap",children:[e.jsx("span",{children:s.year}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{className:"text-yellow-400 font-bold",children:s.imdb_rating?s.imdb_rating.toFixed(1):"N/A"}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{children:s.is_kurdish?"كردي":"غير كردي"})]}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[(f=s.genres)==null?void 0:f.slice(0,2).map(I=>e.jsx("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:I},I)),((N=s.genres)==null?void 0:N.length)>2&&e.jsxs("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:["+",s.genres.length-2]})]})]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700 flex justify-end items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-xs text-slate-500 mr-auto",children:["أضيف في: ",s.created_at?new Date(s.created_at).toLocaleDateString("ar-EG"):"N/A"]}),e.jsx("button",{onClick:()=>ie(s),className:"font-medium text-cyan-400 hover:text-cyan-300",children:"تعديل"}),e.jsx("button",{onClick:()=>re(s),className:"font-medium text-red-500 hover:text-red-400",children:"حذف"})]})]},s.id)})]})]}),Q.length>Re&&e.jsx("div",{className:"p-4 mt-4 border-t border-slate-700",children:e.jsx(rt,{currentPage:l,totalPages:t,onPageChange:x})})]})},kt=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),Ct=({onSubmit:c,initialData:a,onCancel:p,isLoading:h=!1,allGenres:w=[]})=>{const[i,l]=o.useState({title:"",description:"",poster_url:"",backdrop_url:"",year:new Date().getFullYear(),genres:[],tags:[],seasons:[{season_number:1,title:"الموسم 1",description:"",poster_url:"",year:new Date().getFullYear(),episodes:[{episode_number:1,title:"الحلقة 1",url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"1080p"}],imdb_rating:0}],trailer_url:"",imdb_rating:0}),[x,k]=o.useState(""),[P,G]=o.useState(!1),D=o.useRef(null);o.useEffect(()=>{a&&(l({...a,genres:a.genres||[],tags:a.tags||[],seasons:a.seasons&&a.seasons.length>0?a.seasons:[{season_number:1,title:"الموسم 1",description:"",poster_url:a.poster_url,year:a.year,episodes:[],imdb_rating:0}],trailer_url:a.trailer_url||"",imdb_rating:a.imdb_rating||0}),k((a.tags||[]).join(", ")))},[a]),o.useEffect(()=>{const m=d=>{D.current&&!D.current.contains(d.target)&&G(!1)};return document.addEventListener("mousedown",m),()=>document.removeEventListener("mousedown",m)},[]);const K=async m=>{var d;try{if(!((d=navigator.clipboard)!=null&&d.readText))throw new Error("Clipboard API not available.");const u=await navigator.clipboard.readText();u&&m(u)}catch(u){console.error("Failed to read clipboard contents: ",u),alert("فشل لصق النص. يرجى التأكد من منح الإذن لاستخدام الحافظة.")}},g=m=>{const{name:d,value:u}=m.target;if(d==="year"||d==="imdb_rating"){const C=parseFloat(u);l(j=>({...j,[d]:isNaN(C)?0:C}))}else l(C=>({...C,[d]:u}))},M=m=>{k(m.target.value)},_=m=>{l(d=>({...d,genres:d.genres.includes(m)?d.genres.filter(u=>u!==m):[...d.genres,m]}))},O=(m,d,u)=>{const C=[...i.seasons],j={...C[m]};if(d==="season_number"||d==="year"||d==="imdb_rating"){const L=typeof u=="string"?parseFloat(u):u;j[d]=isNaN(L)?0:L}else j[d]=u;C[m]=j,l(L=>({...L,seasons:C}))},q=()=>{const m=i.seasons.length>0?Math.max(...i.seasons.map(u=>u.season_number))+1:1,d=i.seasons.length>0?i.seasons[i.seasons.length-1].year:i.year;l(u=>({...u,seasons:[...u.seasons,{season_number:m,title:`الموسم ${m}`,description:"",poster_url:u.poster_url,year:d+1,episodes:[{episode_number:1,title:"الحلقة 1",url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"1080p"}],imdb_rating:0}]}))},B=m=>{l(d=>({...d,seasons:d.seasons.filter((u,C)=>C!==m)}))},E=(m,d,u,C)=>{const j=[...i.seasons],L=[...j[m].episodes],ee={...L[d]};if(u==="episode_number"){const re=typeof C=="string"?parseFloat(C):C;ee[u]=isNaN(re)?0:re}else ee[u]=C;L[d]=ee,j[m]={...j[m],episodes:L},l(re=>({...re,seasons:j}))},$=m=>{const d=i.seasons[m],u=d.episodes.length>0?Math.max(...d.episodes.map(L=>L.episode_number))+1:1,C={episode_number:u,title:`الحلقة ${u}`,url:"https://vidtube.pro/embed-yabwsjqcvg9i.html",download_url:"",quality:"1080p"},j=i.seasons.map((L,ee)=>ee===m?{...L,episodes:[...L.episodes,C]}:L);l(L=>({...L,seasons:j}))},W=(m,d)=>{const u=i.seasons.map((C,j)=>j===m?{...C,episodes:C.episodes.filter((L,ee)=>ee!==d)}:C);l(C=>({...C,seasons:u}))},U=m=>{m.preventDefault();const d=x.split(",").map(u=>u.trim()).filter(Boolean);c({...i,tags:d})},y="w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",R="bg-slate-600 text-white p-2 rounded-md border border-slate-500 focus:border-cyan-500 outline-none";return e.jsxs("form",{onSubmit:U,className:"space-y-6",children:[e.jsx("h3",{className:"text-xl font-bold text-white border-b border-slate-700 pb-2",children:"معلومات المسلسل الرئيسية"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"text",name:"title",value:i.title,onChange:g,placeholder:"عنوان المسلسل",required:!0,className:y}),e.jsx("input",{type:"number",name:"year",value:i.year||"",onChange:g,placeholder:"سنة بداية العرض",required:!0,className:y})]}),e.jsx("textarea",{name:"description",value:i.description,onChange:g,placeholder:"وصف المسلسل العام",required:!0,className:`${y} h-24`}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"url",name:"poster_url",value:i.poster_url,onChange:g,placeholder:"رابط البوستر الرئيسي",required:!0,className:y}),e.jsx("input",{type:"url",name:"backdrop_url",value:i.backdrop_url,onChange:g,placeholder:"رابط صورة الخلفية",required:!0,className:y})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx("input",{type:"number",name:"imdb_rating",value:i.imdb_rating??"",onChange:g,placeholder:"تقييم IMDb (e.g. 8.5)",step:"0.1",min:"0",max:"10",className:y}),e.jsx("input",{type:"url",name:"trailer_url",value:i.trailer_url??"",onChange:g,placeholder:"رابط المقطع الدعائي (اختياري)",className:y})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الفئات"}),e.jsxs("div",{className:"relative",ref:D,children:[e.jsx("button",{type:"button",onClick:()=>G(m=>!m),className:`${y} text-right`,children:i.genres.length>0?i.genres.join(", "):"اختر الفئات..."}),P&&e.jsx("div",{className:"absolute z-10 mt-1 w-full bg-slate-900 border border-slate-700 rounded-md shadow-lg max-h-60 overflow-y-auto",children:w.map(m=>e.jsxs("label",{className:"flex items-center gap-3 p-2 hover:bg-slate-700 cursor-pointer",children:[e.jsx("input",{type:"checkbox",checked:i.genres.includes(m),onChange:()=>_(m),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("span",{className:"text-white",children:m})]},m))})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-semibold text-white mb-2",children:"الكلمات الدلالية (مفصولة بفاصلة)"}),e.jsx("input",{type:"text",value:x,onChange:M,placeholder:"أكشن, إثارة...",className:y})]}),e.jsxs("div",{className:"space-y-4 border-t border-slate-700 pt-4",children:[e.jsx("h3",{className:"text-xl font-bold text-white",children:"المواسم والحلقات"}),i.seasons.map((m,d)=>e.jsxs("div",{className:"bg-slate-900/50 p-4 rounded-lg border border-slate-700 space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("label",{className:"text-white font-semibold",children:"الموسم رقم:"}),e.jsx("input",{type:"number",value:m.season_number||"",onChange:u=>O(d,"season_number",u.target.value),className:`${R} w-20`})]}),e.jsx("button",{type:"button",onClick:()=>B(d),className:"bg-red-600 text-white px-3 py-1 rounded-md text-sm",children:"إزالة الموسم"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-3 gap-3",children:[e.jsx("input",{type:"text",value:m.title,onChange:u=>O(d,"title",u.target.value),placeholder:"عنوان الموسم",required:!0,className:R}),e.jsx("input",{type:"number",value:m.year||"",onChange:u=>O(d,"year",u.target.value),placeholder:"سنة الموسم",required:!0,className:R}),e.jsx("input",{type:"number",value:m.imdb_rating??"",onChange:u=>O(d,"imdb_rating",u.target.value),placeholder:"تقييم IMDb",step:"0.1",min:"0",max:"10",className:R}),e.jsx("input",{type:"url",value:m.poster_url,onChange:u=>O(d,"poster_url",u.target.value),placeholder:"رابط بوستر الموسم",required:!0,className:`${R} col-span-1 sm:col-span-3`}),e.jsx("textarea",{value:m.description,onChange:u=>O(d,"description",u.target.value),placeholder:"وصف الموسم",required:!0,className:`${R} h-20 col-span-1 sm:col-span-3`})]}),e.jsxs("div",{className:"space-y-2 pt-3 mt-3 border-t border-slate-600",children:[e.jsxs("h4",{className:"font-semibold text-slate-300",children:["حلقات الموسم ",m.season_number,":"]}),m.episodes.map((u,C)=>e.jsxs("div",{className:"bg-slate-800/60 p-2 rounded-md space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"number",value:u.episode_number||"",onChange:j=>E(d,C,"episode_number",j.target.value),placeholder:"رقم",className:`${R} w-16`}),e.jsx("input",{type:"text",value:u.title,onChange:j=>E(d,C,"title",j.target.value),placeholder:"عنوان الحلقة",className:`${R} flex-1`}),e.jsx("button",{type:"button",onClick:()=>W(d,C),className:"bg-red-500 text-white p-2 rounded-md hover:bg-red-600 text-xs",children:"X"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsx("input",{type:"url",value:u.url,onChange:j=>E(d,C,"url",j.target.value),placeholder:"رابط المشاهدة",required:!0,className:`${R} flex-1`}),e.jsx("button",{type:"button",onClick:()=>K(j=>E(d,C,"url",j)),className:"bg-cyan-600 hover:bg-cyan-700 text-white font-bold text-xs py-1.5 px-3 rounded-md transition-colors flex-shrink-0",children:"لصق"})]}),e.jsxs("select",{value:u.quality||"1080p",onChange:j=>E(d,C,"quality",j.target.value),className:`${R} w-28 flex-shrink-0`,children:[e.jsx("option",{value:"1080p",children:"1080p"}),e.jsx("option",{value:"720p",children:"720p"}),e.jsx("option",{value:"480p",children:"480p"})]})]}),e.jsx("input",{type:"url",value:u.download_url||"",onChange:j=>E(d,C,"download_url",j.target.value),placeholder:"رابط التحميل (اختياري)",className:`${R} w-full`})]})]},C)),e.jsx("button",{type:"button",onClick:()=>$(d),className:"text-sm bg-slate-600 text-white py-1 px-3 rounded-md hover:bg-slate-500",children:"إضافة حلقة"})]})]},d)),e.jsx("button",{type:"button",onClick:q,className:"bg-cyan-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-700",children:"إضافة موسم"})]}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-slate-700",children:[e.jsx("button",{type:"button",onClick:p,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg",disabled:h,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg",disabled:h,children:[h&&e.jsx(kt,{}),a?"تحديث المسلسل":"إضافة المسلسل"]})]})]})},Be=10,St=()=>{const[c,a]=o.useState([]),[p,h]=o.useState(null),[w,i]=o.useState(!1),[l,x]=o.useState(1),[k,P]=o.useState(""),[G,D]=o.useState(!1),[K,g]=o.useState(null),[M,_]=o.useState(!0),[O,q]=o.useState(!1),[B,E]=o.useState(null),[$,W]=o.useState([]),[U,y]=o.useState(null),[R,m]=o.useState([]),d=async()=>{const{data:t,error:r}=await S.from("series").select("*").order("created_at",{ascending:!1});r?(console.error("Error fetching series: ",r),u("فشل في تحميل المسلسلات.","error")):a(t);const{data:n,error:b}=await S.from("categories").select("name").order("name");b?console.error("Error fetching categories: ",b):m(n.map(s=>s.name)),_(!1)};o.useEffect(()=>{_(!0),d();const t=S.channel("public:series").on("postgres_changes",{event:"*",schema:"public",table:"series"},d).subscribe();return()=>{S.removeChannel(t)}},[]),o.useEffect(()=>{x(1),W([])},[k]);const u=(t,r)=>{E({message:t,type:r})},C=async t=>{q(!0);try{const{error:r}=await S.from("series").insert([{...t,created_at:new Date().toISOString()}]);if(r)throw r;await d(),i(!1),x(1),u("تمت إضافة المسلسل بنجاح.","success")}catch(r){console.error("Error adding series: ",r);const n=r.message||JSON.stringify(r);u(`حدث خطأ أثناء إضافة المسلسل: ${n}`,"error")}finally{q(!1)}},j=async(t,r)=>{q(!0);try{const{error:n}=await S.from("series").update(r).eq("id",t);if(n)throw n;await d(),h(null),i(!1),u("تم تحديث المسلسل بنجاح.","success")}catch(n){console.error("Error updating series:",n);const b=n.message||JSON.stringify(n);u(`حدث خطأ أثناء تحديث المسلسل: ${b}`,"error")}finally{q(!1)}},L=t=>{g(t),D(!0)},ee=async()=>{if(K){q(!0);try{const{error:t}=await S.from("series").delete().eq("id",K.id);if(t)throw t;u("تم حذف المسلسل بنجاح.","success")}catch(t){console.error("Error deleting series:",t);const r=t.message||JSON.stringify(t);u(`حدث خطأ أثناء حذف المسلسل: ${r}`,"error")}finally{D(!1),g(null),q(!1)}}},re=t=>{h(t),i(!0)},he=()=>{h(null),i(!0)},ie=()=>{h(null),i(!1),y(null)},v=t=>{W(r=>r.includes(t)?r.filter(n=>n!==t):[...r,t])},A=t=>{t.target.checked?W(X.map(r=>r.id)):W($.filter(r=>!X.some(n=>n.id===r)))},J=async()=>{q(!0);try{const{error:t}=await S.from("series").delete().in("id",$);if(t)throw t;u(`تم حذف ${$.length} مسلسل بنجاح.`,"success"),W([])}catch(t){console.error("Bulk delete failed:",t),u("فشل الحذف الجماعي.","error")}finally{q(!1),y(null)}},te=async(t,r)=>{q(!0);try{const{data:n,error:b}=await S.from("series").select("id, genres").in("id",$);if(b)throw b;const s=n.map(N=>{const I=N.genres||[],ce=r==="add"?[...new Set([...I,t])]:I.filter(de=>de!==t);return{id:N.id,genres:ce}}),{error:f}=await S.from("series").upsert(s);if(f)throw f;u(`تم ${r==="add"?"إضافة":"إزالة"} فئة "${t}" بنجاح.`,"success"),W([])}catch(n){console.error("Bulk genre change failed:",n),u("فشل تغيير الفئة الجماعي.","error")}finally{q(!1),y(null)}},Y=async(t,r)=>{q(!0);try{const{data:n,error:b}=await S.from("series").select("id, tags").in("id",$);if(b)throw b;const s=n.map(N=>{const I=N.tags||[],ce=r==="add"?[...new Set([...I,t])]:I.filter(de=>de!==t);return{id:N.id,tags:ce}}),{error:f}=await S.from("series").upsert(s);if(f)throw f;u(`تم ${r==="add"?"إضافة":"إزالة"} الكلمة الدلالية "${t}" بنجاح.`,"success"),W([])}catch(n){console.error("Bulk tags change failed:",n),u("فشل تغيير الكلمات الدلالية الجماعي.","error")}finally{q(!1),y(null)}},T=c.filter(t=>mt(k,t.title)),se=Math.ceil(T.length/Be),X=T.slice((l-1)*Be,l*Be),Q=X.length>0&&X.every(t=>$.includes(t.id));return M?e.jsx(ht,{}):e.jsxs("div",{className:"relative",children:[B&&e.jsx(at,{...B,onClose:()=>E(null)}),e.jsx(be,{isOpen:G,onClose:()=>D(!1),onConfirm:ee,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف المسلسل ",e.jsxs("strong",{className:"text-white",children:['"',K==null?void 0:K.title,'"']}),"؟ ",e.jsx("br",{})," ",e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:O}),U==="delete"&&e.jsx(be,{isOpen:!0,onClose:()=>y(null),onConfirm:J,title:`تأكيد حذف ${$.length} مسلسل`,message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف المسلسلات المحددة؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:O}),U==="genre"&&e.jsx(xt,{genres:R,onClose:ie,onSubmit:te,isLoading:O}),U==="tags"&&e.jsx(pt,{onClose:ie,onSubmit:Y,isLoading:O}),w&&e.jsx(_e,{title:p?"تعديل المسلسل":"إضافة مسلسل جديد",onClose:ie,isOpen:w,children:e.jsx(Ct,{onSubmit:p?t=>j(p.id,t):C,initialData:p,onCancel:ie,isLoading:O,allGenres:R})}),e.jsxs("div",{className:"flex flex-col sm:flex-row items-center mb-6 gap-4 w-full",children:[e.jsx("button",{onClick:he,className:"bg-gradient-to-r from-cyan-500 to-blue-500 text-white font-bold py-2.5 px-5 rounded-lg hover:from-cyan-600 hover:to-blue-600 transition-all duration-300 shadow-lg w-full sm:w-auto flex-shrink-0",children:"إضافة مسلسل جديد"}),e.jsxs("div",{className:"relative w-full sm:flex-grow",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-5 w-5 text-gray-400",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}),e.jsx("input",{type:"text",value:k,onChange:t=>P(t.target.value),placeholder:"ابحث عن مسلسل للتعديل...",className:"w-full bg-slate-700 text-white p-2.5 pl-10 rounded-lg focus:ring-2 focus:ring-cyan-500 border-none outline-none transition-colors","aria-label":"Search for a series to edit"})]})]}),$.length>0&&e.jsxs("div",{className:"bg-slate-900/80 backdrop-blur-sm border border-cyan-500 rounded-lg p-3 mb-4 flex flex-wrap items-center justify-between gap-3 animate-fade-in-down",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("span",{className:"text-white font-bold",children:[$.length," مسلسل محدد"]}),e.jsx("button",{onClick:()=>W([]),className:"text-sm text-cyan-400 hover:underline",children:"إلغاء التحديد"})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{onClick:()=>y("genre"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الفئة"}),e.jsx("button",{onClick:()=>y("tags"),className:"bg-slate-700 text-sm py-1 px-3 rounded-md hover:bg-slate-600",children:"تغيير الكلمات"}),e.jsx("button",{onClick:()=>y("delete"),className:"bg-red-600 text-sm py-1 px-3 rounded-md hover:bg-red-500",children:"حذف المحدد"})]})]}),e.jsxs("div",{children:[e.jsx("div",{className:"overflow-x-auto hidden lg:block",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-slate-900/50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-right",children:e.jsx("input",{type:"checkbox",onChange:A,checked:Q,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الصورة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"العنوان"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تقييم IMDb"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"السنة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"الفئات"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"المواسم"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"تاريخ الإضافة"}),e.jsx("th",{className:"px-4 py-3 text-right text-xs font-medium text-slate-400 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-slate-700",children:X.map(t=>{var r,n,b;return e.jsxs("tr",{className:`${$.includes(t.id)?"bg-cyan-500/20":"hover:bg-slate-700/50"} transition-colors duration-200`,children:[e.jsx("td",{className:"px-4 py-2",children:e.jsx("input",{type:"checkbox",checked:$.includes(t.id),onChange:()=>v(t.id),className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:e.jsx("img",{src:t.poster_url,alt:t.title,className:"h-20 w-auto rounded object-cover",loading:"lazy"})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap font-medium text-white align-middle",children:t.title}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-yellow-400 font-bold align-middle",children:t.imdb_rating?t.imdb_rating.toFixed(1):"N/A"}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:t.year}),e.jsx("td",{className:"px-4 py-2 text-slate-300 align-middle",children:e.jsxs("div",{className:"flex flex-wrap gap-1 max-w-xs",children:[(r=t.genres)==null?void 0:r.slice(0,3).map(s=>e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:s},s)),((n=t.genres)==null?void 0:n.length)>3&&e.jsx("span",{className:"bg-slate-600 text-slate-200 px-2 py-1 text-xs rounded-full",children:"..."})]})}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:((b=t.seasons)==null?void 0:b.length)||0}),e.jsx("td",{className:"px-4 py-2 whitespace-nowrap text-slate-300 align-middle",children:t.created_at?new Date(t.created_at).toLocaleDateString("ar-EG"):"غير متاح"}),e.jsxs("td",{className:"px-4 py-2 whitespace-nowrap font-medium align-middle",children:[e.jsx("button",{onClick:()=>re(t),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>L(t),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},t.id)})})]})}),e.jsxs("div",{className:"block lg:hidden space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-2",children:[e.jsx("input",{type:"checkbox",onChange:A,checked:Q,className:"h-4 w-4 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600"}),e.jsx("label",{className:"text-sm text-slate-300",children:"تحديد الكل في هذه الصفحة"})]}),X.map(t=>{var r,n,b;return e.jsxs("div",{className:`p-3 rounded-lg transition-all duration-200 ${$.includes(t.id)?"bg-cyan-500/20 ring-2 ring-cyan-500":"bg-slate-900/50"}`,children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-shrink-0 w-24",children:e.jsx("img",{src:t.poster_url,alt:t.title,className:"w-full rounded object-cover",loading:"lazy"})}),e.jsxs("div",{className:"flex-grow min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h3",{className:"font-bold text-white truncate flex-grow pr-2",children:t.title}),e.jsx("input",{type:"checkbox",checked:$.includes(t.id),onChange:()=>v(t.id),className:"h-5 w-5 text-cyan-500 bg-slate-700 border-slate-600 rounded focus:ring-cyan-600 flex-shrink-0"})]}),e.jsxs("div",{className:"text-sm text-slate-400 mt-1 flex items-center gap-x-2 flex-wrap",children:[e.jsx("span",{children:t.year}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsx("span",{className:"text-yellow-400 font-bold",children:t.imdb_rating?t.imdb_rating.toFixed(1):"N/A"}),e.jsx("span",{className:"text-slate-600",children:"•"}),e.jsxs("span",{children:[((r=t.seasons)==null?void 0:r.length)||0," مواسم"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2",children:[(n=t.genres)==null?void 0:n.slice(0,2).map(s=>e.jsx("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:s},s)),((b=t.genres)==null?void 0:b.length)>2&&e.jsxs("span",{className:"bg-slate-700 text-slate-200 px-2 py-0.5 text-xs rounded-full",children:["+",t.genres.length-2]})]})]})]}),e.jsxs("div",{className:"mt-3 pt-3 border-t border-slate-700 flex justify-end items-center gap-4 text-sm",children:[e.jsxs("div",{className:"text-xs text-slate-500 mr-auto",children:["أضيف في: ",t.created_at?new Date(t.created_at).toLocaleDateString("ar-EG"):"N/A"]}),e.jsx("button",{onClick:()=>re(t),className:"font-medium text-cyan-400 hover:text-cyan-300",children:"تعديل"}),e.jsx("button",{onClick:()=>L(t),className:"font-medium text-red-500 hover:text-red-400",children:"حذف"})]})]},t.id)})]})]}),T.length>Be&&e.jsx("div",{className:"p-4 mt-4 border-t border-slate-700",children:e.jsx(rt,{currentPage:l,totalPages:se,onPageChange:x})})]})},_t=()=>e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),Et=({onSubmit:c,initialData:a,onCancel:p,isLoading:h=!1})=>{const[w,i]=o.useState("");o.useEffect(()=>{i(a?a.name:"")},[a]);const l=x=>{x.preventDefault(),w.trim()&&c({name:w})};return e.jsxs("form",{onSubmit:l,className:"space-y-6",children:[e.jsx("input",{type:"text",name:"name",value:w,onChange:x=>i(x.target.value),placeholder:"اسم الفئة",required:!0,className:"w-full bg-gray-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-none outline-none"}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-gray-700",children:[e.jsx("button",{type:"button",onClick:p,className:"bg-gray-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-500 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",disabled:h,children:"إلغاء"}),e.jsxs("button",{type:"submit",className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",disabled:h,children:[h&&e.jsx(_t,{}),h?a?"جاري التحديث...":"جاري الإضافة...":a?"تحديث":"إضافة"]})]})]})},$t=10,Mt=()=>e.jsx("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden mt-8 animate-pulse",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/3"})}),e.jsx("th",{className:"px-6 py-3",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/4"})})]})}),e.jsx("tbody",{children:[...Array($t)].map((c,a)=>e.jsxs("tr",{className:"border-b border-gray-700",children:[e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded"})}),e.jsx("td",{className:"px-6 py-4",children:e.jsx("div",{className:"h-4 bg-gray-600 rounded w-1/2"})})]},a))})]})})}),qt=({isOpen:c,onClose:a,onSubmit:p,isLoading:h,categories:w})=>{const[i,l]=o.useState(""),[x,k]=o.useState(""),[P,G]=o.useState(""),D=bt.useMemo(()=>w.filter(g=>g.name!==i),[w,i]);o.useEffect(()=>{if(c&&w.length>0){const g=w[0].name;l(g);const M=w.filter(_=>_.name!==g);k(M.length>0?M[0].name:"")}},[c,w]),o.useEffect(()=>{G(i&&x&&i===x?"لا يمكن دمج فئة مع نفسها. الرجاء اختيار فئتين مختلفتين.":"")},[i,x]),o.useEffect(()=>{D.some(g=>g.name===x)||k(D.length>0?D[0].name:"")},[i,D,x]);const K=g=>{g.preventDefault(),!(P||!i||!x)&&p(i,x)};return e.jsx(_e,{title:"توحيد (دمج) الفئات",onClose:a,isOpen:c,children:e.jsxs("form",{onSubmit:K,className:"space-y-6",children:[e.jsx("p",{className:"text-slate-300",children:"سيتم نقل كل المحتوى من الفئة المصدر إلى الفئة الهدف، ثم سيتم حذف الفئة المصدر نهائياً."}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"source_category",className:"block text-sm font-medium text-slate-300 mb-2",children:"دمج من هذه الفئة (سيتم حذفها):"}),e.jsx("select",{id:"source_category",value:i,onChange:g=>l(g.target.value),required:!0,className:"w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",children:w.map(g=>e.jsx("option",{value:g.name,children:g.name},g.id))})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"destination_category",className:"block text-sm font-medium text-slate-300 mb-2",children:"الدمج في هذه الفئة (ستبقى):"}),e.jsx("select",{id:"destination_category",value:x,onChange:g=>k(g.target.value),required:!0,className:"w-full bg-slate-700 text-white p-3 rounded-md focus:ring-2 focus:ring-cyan-500 border-2 border-slate-600 outline-none",disabled:D.length===0,children:D.map(g=>e.jsx("option",{value:g.name,children:g.name},g.id))})]}),P&&e.jsx("p",{className:"text-red-400 text-center text-sm bg-red-500/10 p-2 rounded-md",children:P}),e.jsxs("div",{className:"flex justify-end gap-4 pt-4 border-t border-slate-700",children:[e.jsx("button",{type:"button",onClick:a,disabled:h,className:"bg-slate-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-slate-500 transition-colors disabled:opacity-50",children:"إلغاء"}),e.jsxs("button",{type:"submit",disabled:h||!!P||!i||!x,className:"flex items-center justify-center bg-cyan-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-cyan-600 transition-colors disabled:bg-cyan-800 disabled:cursor-not-allowed",children:[h&&e.jsx(Se,{}),h?"جاري الدمج...":"تنفيذ الدمج"]})]})]})})},Ue=10,At=({message:c,type:a,onClose:p})=>(o.useEffect(()=>{const i=setTimeout(p,5e3);return()=>clearTimeout(i)},[p]),e.jsx("div",{className:`fixed top-24 right-5 z-[100] p-4 rounded-lg shadow-lg text-white border-l-4 animate-fade-in-down ${a==="success"?"bg-green-600 border-green-500":"bg-red-600 border-red-500"}`,role:"alert",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("p",{className:"font-bold",children:c}),e.jsx("button",{onClick:p,className:"absolute top-1 right-2 text-2xl font-bold leading-none",children:"×"})]})})),Ft=({children:c,onClose:a,title:p,isOpen:h})=>{const[w,i]=o.useState(h);return o.useEffect(()=>{if(h){i(!0),document.body.style.overflow="hidden";const l=x=>{x.key==="Escape"&&a()};return window.addEventListener("keydown",l),()=>{window.removeEventListener("keydown",l)}}else{const l=setTimeout(()=>{i(!1),document.body.style.overflow="auto"},300);return()=>clearTimeout(l)}},[h,a]),w?e.jsx("div",{className:`fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 ${h?"animate-fade-in":"animate-fade-out"}`,onClick:a,children:e.jsxs("div",{className:`bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-lg border border-gray-700 ${h?"animate-zoom-in":"animate-zoom-out"}`,onClick:l=>l.stopPropagation(),children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx("h2",{className:"text-2xl font-bold text-white",children:p}),e.jsx("button",{onClick:a,className:"text-gray-400 hover:text-white text-3xl transition-colors",children:"×"})]}),c]})}):null},Ot=()=>{const[c,a]=o.useState([]),[p,h]=o.useState(null),[w,i]=o.useState(!1),[l,x]=o.useState(1),[k,P]=o.useState(!1),[G,D]=o.useState(null),[K,g]=o.useState(!0),[M,_]=o.useState(!1),[O,q]=o.useState(null),[B,E]=o.useState(!1),[$,W]=o.useState(null),U=async()=>{const{data:v,error:A}=await S.from("categories").select("*").order("name");A?(console.error("Error fetching categories: ",A),y("فشل في تحميل الفئات.","error")):a(v),g(!1)};o.useEffect(()=>{g(!0),U();const v=S.channel("public:categories").on("postgres_changes",{event:"*",schema:"public",table:"categories"},U).subscribe();return()=>{S.removeChannel(v)}},[]);const y=(v,A)=>{q({message:v,type:A})},R=async v=>{_(!0);try{const{error:A}=await S.from("categories").insert([v]);if(A)throw A;y("تمت إضافة الفئة بنجاح!","success"),i(!1),x(1)}catch(A){console.error("Error adding category: ",A);const J=A.message||JSON.stringify(A);y(`حدث خطأ أثناء إضافة الفئة: ${J}`,"error")}finally{_(!1)}},m=async(v,A)=>{_(!0);const J=p==null?void 0:p.name,te=A.name,Y=J&&te&&J!==te;try{const{error:T}=await S.from("categories").update(A).eq("id",v);if(T)throw T;if(Y){y("تم تحديث الفئة. جاري تحديث المحتوى المرتبط...","success");const{data:se,error:X}=await S.from("movies").select("id, genres").contains("genres",[J]);if(X)console.error("Error fetching movies to update:",X),y("تم تحديث الفئة، لكن حدث خطأ أثناء جلب الأفلام للتحديث.","error");else if(se&&se.length>0){const r=se.map(s=>{const f=s.genres.map(N=>N===J?te:N);return S.from("movies").update({genres:f}).eq("id",s.id)}),b=(await Promise.all(r)).find(s=>s.error);b&&(console.error("Error updating movies with new category:",b.error),y("تم تحديث الفئة، لكن حدث خطأ أثناء تحديث بعض الأفلام.","error"))}const{data:Q,error:t}=await S.from("series").select("id, genres").contains("genres",[J]);if(t)console.error("Error fetching series to update:",t),y("تم تحديث الفئة، لكن حدث خطأ أثناء جلب المسلسلات للتحديث.","error");else if(Q&&Q.length>0){const r=Q.map(s=>{const f=s.genres.map(N=>N===J?te:N);return S.from("series").update({genres:f}).eq("id",s.id)}),b=(await Promise.all(r)).find(s=>s.error);b&&(console.error("Error updating series with new category:",b.error),y("تم تحديث الفئة، لكن حدث خطأ أثناء تحديث بعض المسلسلات.","error"))}y("تم تحديث الفئة والمحتوى المرتبط بنجاح!","success")}else y("تم تحديث الفئة بنجاح!","success");h(null),i(!1)}catch(T){if(console.error("Error updating category transaction: ",T),T.code==="23505")y(`فشل التحديث: اسم الفئة "${te}" موجود بالفعل.`,"error");else{const se=T.message||JSON.stringify(T);y(`حدث خطأ أثناء تحديث الفئة: ${se}`,"error")}}finally{_(!1)}},d=v=>{D(v),P(!0)},u=async()=>{if(G){_(!0);try{const{error:v}=await S.from("categories").delete().eq("id",G.id);if(v)throw v;y("تم حذف الفئة بنجاح!","success")}catch(v){console.error("Error deleting category: ",v);const A=v.message||JSON.stringify(v);y(`حدث خطأ أثناء حذف الفئة: ${A}`,"error")}finally{P(!1),D(null),_(!1)}}},C=v=>{h(v),i(!0)},j=()=>{h(null),i(!0)},L=()=>{h(null),i(!1)},ee=(v,A)=>{E(!1),W({source:v,dest:A})},re=async()=>{if(!$)return;const{source:v,dest:A}=$;_(!0);try{y("جاري تحديث الأفلام...","success");const{data:J,error:te}=await S.from("movies").select("id, genres").contains("genres",[v]);if(te)throw new Error(`Failed to fetch movies: ${te.message}`);if(J&&J.length>0){const X=J.map(Q=>{const t=[...new Set(Q.genres.filter(r=>r!==v).concat([A]))];return S.from("movies").update({genres:t}).eq("id",Q.id)});await Promise.all(X)}y("جاري تحديث المسلسلات...","success");const{data:Y,error:T}=await S.from("series").select("id, genres").contains("genres",[v]);if(T)throw new Error(`Failed to fetch series: ${T.message}`);if(Y&&Y.length>0){const X=Y.map(Q=>{const t=[...new Set(Q.genres.filter(r=>r!==v).concat([A]))];return S.from("series").update({genres:t}).eq("id",Q.id)});await Promise.all(X)}y("جاري حذف الفئة المدمجة...","success");const{error:se}=await S.from("categories").delete().eq("name",v);if(se)throw new Error(`Failed to delete category: ${se.message}`);y("تم دمج الفئات بنجاح!","success")}catch(J){console.error("Error merging categories: ",J),y(`فشل دمج الفئات: ${J.message}`,"error")}finally{W(null),_(!1)}},he=Math.ceil(c.length/Ue),ie=c.slice((l-1)*Ue,l*Ue);return K?e.jsxs("div",{children:[e.jsx("div",{className:"h-10 bg-gray-700 rounded w-48 mb-6 animate-pulse"}),e.jsx(Mt,{})]}):e.jsxs("div",{children:[O&&e.jsx(At,{...O,onClose:()=>q(null)}),e.jsx(be,{isOpen:k,onClose:()=>P(!1),onConfirm:u,title:"تأكيد الحذف",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد حذف الفئة ",e.jsxs("strong",{className:"text-white",children:['"',G==null?void 0:G.name,'"']}),"؟",e.jsx("br",{}),e.jsx("span",{className:"text-yellow-400",children:"لا يمكن التراجع عن هذا الإجراء."})]}),isLoading:M}),e.jsx(be,{isOpen:!!$,onClose:()=>W(null),onConfirm:re,title:"تأكيد عملية الدمج",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد دمج الفئة ",e.jsxs("strong",{className:"text-white",children:['"',$==null?void 0:$.source,'"']})," في الفئة ",e.jsxs("strong",{className:"text-white",children:['"',$==null?void 0:$.dest,'"']}),"؟",e.jsx("br",{}),e.jsxs("span",{className:"text-yellow-400",children:['سيتم حذف الفئة "',$==null?void 0:$.source,'" نهائياً. لا يمكن التراجع عن هذا الإجراء.']})]}),isLoading:M}),e.jsx(qt,{isOpen:B,onClose:()=>E(!1),onSubmit:ee,isLoading:M,categories:c}),e.jsx(Ft,{isOpen:w,title:p?"تعديل الفئة":"إضافة فئة جديدة",onClose:L,children:e.jsx(Et,{onSubmit:p?v=>m(p.id,v):R,initialData:p,onCancel:L,isLoading:M})}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{onClick:j,className:"bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-cyan-600 transition-colors",children:"إضافة فئة جديدة"}),e.jsx("button",{onClick:()=>E(!0),className:"bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-500 transition-colors",children:"توحيد الفئات"})]}),e.jsxs("div",{children:[e.jsx("div",{className:"bg-gray-800 rounded-lg shadow-lg overflow-hidden hidden sm:block",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full",children:[e.jsx("thead",{className:"bg-gray-700",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider",children:"اسم الفئة"}),e.jsx("th",{className:"px-6 py-3 text-right text-xs font-medium text-gray-300 uppercase tracking-wider",children:"إجراءات"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-700",children:c.length>0?ie.map(v=>e.jsxs("tr",{className:"hover:bg-gray-700/50",children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium text-white",children:v.name}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:[e.jsx("button",{onClick:()=>C(v),className:"text-cyan-400 hover:text-cyan-300 ml-4",children:"تعديل"}),e.jsx("button",{onClick:()=>d(v),className:"text-red-500 hover:text-red-400",children:"حذف"})]})]},v.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:2,className:"text-center py-8 text-gray-400",children:"لا توجد فئات حالياً."})})})]})})}),e.jsx("div",{className:"block sm:hidden space-y-3",children:c.length>0?ie.map(v=>e.jsxs("div",{className:"bg-slate-900/50 p-4 rounded-lg flex justify-between items-center",children:[e.jsx("span",{className:"font-medium text-white",children:v.name}),e.jsxs("div",{className:"flex gap-4 flex-shrink-0",children:[e.jsx("button",{onClick:()=>C(v),className:"text-cyan-400 hover:text-cyan-300 text-sm font-medium",children:"تعديل"}),e.jsx("button",{onClick:()=>d(v),className:"text-red-500 hover:text-red-400 text-sm font-medium",children:"حذف"})]})]},v.id)):e.jsx("div",{className:"text-center py-8 text-gray-400 bg-slate-900/50 rounded-lg",children:"لا توجد فئات حالياً."})})]}),c.length>Ue&&e.jsx("div",{className:"mt-4",children:e.jsx(rt,{currentPage:l,totalPages:he,onPageChange:x})})]})},et=["movies","series","categories"],Tt=c=>c.replace(/[A-Z]/g,a=>`_${a.toLowerCase()}`),st=c=>Array.isArray(c)?c.map(a=>st(a)):c!==null&&typeof c=="object"&&c.constructor===Object?c.hasOwnProperty("seconds")&&c.hasOwnProperty("nanoseconds")&&Object.keys(c).length===2&&typeof c.seconds=="number"&&typeof c.nanoseconds=="number"?new Date(c.seconds*1e3).toISOString():c.hasOwnProperty("_seconds")&&c.hasOwnProperty("_nanoseconds")&&Object.keys(c).length===2&&typeof c._seconds=="number"&&typeof c._nanoseconds=="number"?new Date(c._seconds*1e3).toISOString():Object.keys(c).reduce((a,p)=>{const h=Tt(p);return a[h]=st(c[p]),a},{}):c,Pt=()=>{const[c,a]=o.useState(!1),[p,h]=o.useState(null),[w,i]=o.useState(!1),[l,x]=o.useState(null),k=(g,M)=>{h({message:g,type:M})},P=async()=>{a(!0),k("بدء عملية النسخ الاحتياطي... قد تستغرق هذه العملية بعض الوقت.","success");try{const g={};for(const E of et){const{data:$,error:W}=await S.from(E).select("*");if(W)throw W;g[E]=$||[]}const M=JSON.stringify(g,null,2),_=new Blob([M],{type:"application/json"}),O=URL.createObjectURL(_),q=document.createElement("a");q.href=O;const B=new Date().toISOString().slice(0,10);q.download=`supabase-backup-${B}.json`,document.body.appendChild(q),q.click(),document.body.removeChild(q),URL.revokeObjectURL(O),k("تم إكمال النسخ الاحتياطي بنجاح!","success")}catch(g){console.error("Backup failed:",g);let M="فشل النسخ الاحتياطي. تحقق من وحدة التحكم لمزيد من التفاصيل.";g.code==="42501"&&(M="فشل النسخ الاحتياطي: أذونات غير كافية. تأكد من أن قواعد RLS تسمح للمشرفين بقراءة المجموعات."),k(M,"error")}finally{a(!1)}},G=g=>{var _;const M=(_=g.target.files)==null?void 0:_[0];if(M){const O=new FileReader;O.onload=q=>{var B;try{const E=(B=q.target)==null?void 0:B.result,$=JSON.parse(E);x($)}catch(E){k("ملف JSON غير صالح.","error"),console.error("JSON parsing error:",E),x(null)}},O.readAsText(M)}},D=()=>{l?i(!0):k("الرجاء تحديد ملف نسخ احتياطي أولاً.","error")},K=async()=>{if(i(!1),!!l){a(!0),k("بدء عملية الاستعادة... هذه العملية ستستغرق وقتاً.","success");try{let g=0,M=[];for(const O of Object.keys(l)){if(!et.includes(O)){M.push(O),console.warn(`Skipping restore for unsupported collection: "${O}"`);continue}const q=l[O];if(Array.isArray(q)&&q.length>0){const B=q.map($=>st($)),{error:E}=await S.from(O).upsert(B);if(E)throw console.error(`Error during upsert to "${O}":`,JSON.stringify(E,null,2)),console.error("First failed object (transformed):",JSON.stringify(B[0],null,2)),E;g++}}let _="تمت استعادة البيانات بنجاح!";M.length>0&&(_+=` تم تخطي المجموعات التالية: ${M.join(", ")}.`),g===0&&M.length>0?k(`لم يتم العثور على مجموعات بيانات صالحة للاستعادة في الملف. تم تخطي: ${M.join(", ")}.`,"error"):g>0?k(_,"success"):k("لم يتم العثور على بيانات صالحة للاستعادة في الملف.","error")}catch(g){console.error("Restore failed:",JSON.stringify(g,null,2));const M=`فشلت عملية الاستعادة: ${g.message||"خطأ غير معروف"}. يرجى مراجعة وحدة التحكم للحصول على التفاصيل الفنية.`;k(M,"error")}finally{a(!1),x(null)}}};return e.jsxs("div",{className:"space-y-12",children:[p&&e.jsx(at,{...p,onClose:()=>h(null)}),e.jsx(be,{isOpen:w,onClose:()=>i(!1),onConfirm:K,title:"تأكيد استعادة البيانات",message:e.jsxs(e.Fragment,{children:["هل أنت متأكد أنك تريد استعادة البيانات من هذا الملف؟",e.jsx("br",{}),e.jsx("strong",{className:"text-yellow-400",children:"تحذير:"})," سيتم الكتابة فوق أي بيانات موجودة في المجموعات التي لها نفس الأسماء. لا يمكن التراجع عن هذا الإجراء."]}),isLoading:c}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"النسخ الاحتياطي للبيانات"}),e.jsxs("div",{className:"bg-slate-900/50 p-6 rounded-lg border border-slate-700 space-y-4",children:[e.jsxs("p",{className:"text-sm text-slate-400",children:["انقر على الزر أدناه لتصدير بيانات المحتوى العام (",et.join(", "),"). لا يتم تضمين بيانات المستخدمين والمشرفين الخاصة في هذا النسخ الاحتياطي من جانب العميل لأسباب تتعلق بالأمان والأذونات."]}),e.jsxs("button",{onClick:P,disabled:c,className:"w-full flex items-center justify-center bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-blue-800 disabled:cursor-wait",children:[c&&e.jsx(Se,{}),c?"جاري التصدير...":"تصدير بيانات المحتوى الآن"]})]})]}),e.jsxs("section",{children:[e.jsx("h2",{className:"text-2xl font-bold text-white mb-4",children:"استعادة البيانات"}),e.jsxs("div",{className:"bg-slate-900/50 p-6 rounded-lg border border-slate-700 space-y-4",children:[e.jsxs("div",{className:"p-4 border-l-4 border-yellow-500 bg-yellow-500/10 text-yellow-300 rounded-md",children:[e.jsx("strong",{className:"font-bold",children:"تحذير خطير:"})," استعادة البيانات من ملف ستقوم بالكتابة فوق البيانات الحالية في قاعدة البيانات. استخدم هذه الميزة بحذر شديد وتأكد من أنك تستخدم ملف النسخ الاحتياطي الصحيح."]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-slate-300 mb-2",children:"1. حدد ملف النسخ الاحتياطي (.json)"}),e.jsx("input",{type:"file",accept:".json",onChange:G,className:"w-full text-sm text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-cyan-500/20 file:text-cyan-300 hover:file:bg-cyan-500/30"})]}),e.jsxs("button",{onClick:D,disabled:c||!l,className:"w-full flex items-center justify-center bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition-colors disabled:bg-red-800 disabled:cursor-not-allowed disabled:cursor-wait",children:[c&&e.jsx(Se,{}),c?"جاري الاستعادة...":"2. استعادة البيانات"]})]})]})]})},tt=[{key:"movies",label:"إدارة الأفلام",component:e.jsx(vt,{})},{key:"series",label:"إدارة المسلسلات",component:e.jsx(St,{})},{key:"categories",label:"إدارة الفئات",component:e.jsx(Ot,{})},{key:"backup",label:"النسخ الاحتياطي والاستعادة",component:e.jsx(Pt,{})}],Lt=({label:c,tabKey:a,activeTab:p,onClick:h})=>e.jsx("button",{onClick:()=>h(a),className:`px-4 py-3 font-bold transition-colors duration-300 border-b-2 -mb-px flex-shrink-0 ${p===a?"text-cyan-400 border-cyan-400":"text-slate-400 border-transparent hover:text-white hover:border-slate-500"}`,role:"tab","aria-selected":p===a,children:c}),It=()=>{var h;const[c,a]=o.useState(tt[0].key),p=(h=tt.find(w=>w.key===c))==null?void 0:h.component;return e.jsxs("div",{className:"container mx-auto px-4 py-8 animate-fade-in",children:[e.jsx("h1",{className:"text-3xl md:text-4xl font-black text-white mb-8",children:"لوحة تحكم المشرف"}),e.jsx("div",{className:"flex border-b border-slate-700 mb-6 overflow-x-auto whitespace-nowrap scrollbar-thin scrollbar-thumb-slate-600 scrollbar-track-slate-800",role:"tablist",children:tt.map(w=>e.jsx(Lt,{label:w.label,tabKey:w.key,activeTab:c,onClick:a},w.key))}),e.jsx("div",{role:"tabpanel",className:"bg-slate-800 p-3 sm:p-6 rounded-lg border border-slate-700",children:p})]})};export{It as default};
