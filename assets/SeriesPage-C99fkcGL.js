import{r,a as ee,j as t,s as x}from"./index-7uJ0qKqD.js";import{S as te,G as ae,T as se,Y as re}from"./TagFilter-ticWPhTP.js";import{M as ne}from"./MovieGridSkeleton-DW-WaVP_.js";import{P as le}from"./Pagination-BK7uePpH.js";import{S as oe}from"./SeriesGrid-BuAcxdhR.js";import{a as ie,R as ce}from"./ResumeFromModal-XZE8XZ6D.js";import"./MovieCardSkeleton--xuy0sGE.js";import"./SpinnerIcon-DP9Pwg2V.js";const h=30,Se=()=>{const[m,G]=r.useState([]),[k,E]=r.useState(0),[F,M]=r.useState([]),[A,W]=r.useState([]),[Y,I]=r.useState([]),[_,N]=r.useState(!0),[i,f]=r.useState("all"),[c,u]=r.useState([]),[d,p]=r.useState([]),[S,D]=r.useState("createdAt_desc"),[b,v]=ee(),{addWatchLaterSeries:O,removeWatchLaterSeries:$,isWatchLaterSeries:q,getWatchLaterInfo:C,loading:z}=ie(),[g,j]=r.useState(null),y=parseInt(b.get("page")||"1",10),l=r.useCallback(e=>{const a=new URLSearchParams(b);e<=1?a.delete("page"):a.set("page",e.toString()),v(a,{replace:!0}),window.scrollTo(0,0)},[b,v]);r.useEffect(()=>{(async()=>{try{const[a,o,s]=await Promise.all([x.from("categories").select("name").order("name"),x.from("series").select("tags"),x.from("series").select("year")]);if(a.error)throw a.error;if(M(a.data.map(n=>n.name)),o.error)throw o.error;if(W([...new Set(o.data.flatMap(n=>n.tags||[]))].sort()),s.error)throw s.error;I([...new Set(s.data.map(n=>n.year))].sort((n,w)=>Number(w)-Number(n)))}catch(a){console.error("Error fetching initial series data: ",a)}})()},[]),r.useEffect(()=>{(async()=>{N(!0);const a=(y-1)*h,o=a+h-1;let s=x.from("series").select("*",{count:"exact"});i!=="all"&&(s=s.eq("year",i)),c.length>0&&(s=s.contains("genres",c)),d.length>0&&(s=s.contains("tags",d));const[n,w]=S.split("_");s=s.order(n==="createdAt"?"created_at":n,{ascending:w==="asc"}),s=s.range(a,o);const{data:X,error:L,count:Z}=await s;L?console.error("Error fetching series:",L):(G(X),E(Z||0)),N(!1)})()},[y,i,c,d,S]);const P=e=>{l(1),u(a=>a.includes(e)?a.filter(o=>o!==e):[...a,e])},U=()=>{l(1),u([])},T=e=>{l(1),p(a=>a.includes(e)?a.filter(o=>o!==e):[...a,e])},B=()=>{l(1),p([])},H=()=>{l(1),f("all"),u([]),p([])},J=e=>{q(e.id)?$(e.id):j(e)},K=(e,a)=>{g&&O(g.id,e,a),j(null)},Q=i!=="all"||c.length>0||d.length>0,R=Math.ceil(k/h),V=r.useMemo(()=>new Map(m.map(e=>{const a=C(e.id);return[e.id,a?{season:a.season,episode:a.episode}:null]})),[m,C]);return t.jsxs("div",{className:"animate-fade-in",children:[t.jsx(ce,{isOpen:!!g,onClose:()=>j(null),series:g,onSave:K,isSaving:z}),t.jsx("h1",{className:"text-4xl font-black text-white mb-8 border-r-4 border-cyan-400 pr-4",children:"تصفح المسلسلات"}),t.jsx("div",{className:"relative z-30 my-8 flex justify-center items-center p-4 bg-slate-900/70 backdrop-blur-sm rounded-xl",children:t.jsxs("div",{className:"w-full grid grid-cols-1 sm:grid-cols-2 md:flex md:flex-row md:flex-wrap justify-center items-center gap-4",children:[t.jsx(te,{sortOrder:S,onSortChange:e=>{l(1),D(e)}}),t.jsx(ae,{genres:F,selectedGenres:c,onToggleGenre:P,onClearGenres:U}),t.jsx(se,{tags:A,selectedTags:d,onToggleTag:T,onClearTags:B}),t.jsx(re,{years:Y,selectedYear:i,onYearChange:e=>{l(1),f(e)}})]})}),Q&&t.jsxs("div",{className:"mb-8 flex flex-wrap items-center gap-3 rounded-lg bg-slate-800/50 p-3 animate-fade-in-down",children:[t.jsx("span",{className:"font-bold text-slate-300 mr-2 flex-shrink-0",children:"الفلاتر النشطة:"}),t.jsxs("div",{className:"flex flex-wrap items-center gap-2 flex-grow",children:[i!=="all"&&t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["سنة: ",i,t.jsx("button",{onClick:()=>{l(1),f("all")},className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove year filter ${i}`,children:"×"})]}),c.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:[e,t.jsx("button",{onClick:()=>P(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove genre filter ${e}`,children:"×"})]},e)),d.map(e=>t.jsxs("span",{className:"flex items-center gap-2 rounded-full bg-cyan-900/50 px-3 py-1 text-sm text-cyan-300",children:["#",e,t.jsx("button",{onClick:()=>T(e),className:"text-cyan-400 hover:text-white text-lg leading-none font-bold","aria-label":`Remove tag filter ${e}`,children:"×"})]},e))]}),t.jsx("button",{onClick:H,className:"ml-auto text-sm font-bold text-red-500 hover:text-red-400 hover:underline flex-shrink-0 px-2",children:"مسح الكل"})]}),t.jsx("section",{className:"mb-12",children:_?t.jsx(ne,{count:h}):m.length>0?t.jsxs(t.Fragment,{children:[t.jsx(oe,{series:m,onToggleWatchLater:J,watchLaterInfoMap:V}),R>1&&t.jsx(le,{currentPage:y,totalPages:R,onPageChange:l})]}):t.jsx("div",{className:"text-center p-8 bg-slate-800 rounded-lg mt-8",children:t.jsx("p",{className:"text-xl text-slate-400",children:"لا توجد مسلسلات تطابق معايير البحث."})})})]})};export{Se as default};
